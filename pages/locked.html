<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account Locked ‚Äì Medical Exam Room Pro</title>

    <link rel="manifest" href="../manifest.json">
    <link rel="stylesheet" href="../css/common.css" media="all">
    <link rel="stylesheet" href="../css/locked.css" media="all">

    <script type="module" src="../scripts/utils.js"></script>
    <script type="module" src="../scripts/ui.js"></script>
    <script type="module" src="../scripts/router.js"></script>
    <script type="module" src="../scripts/security.js"></script>
    <script type="module" src="../scripts/db.js"></script>

    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('../service-worker.js').catch(() => { });
        }
    </script>

    <script type="module">
        import * as utils from '../scripts/utils.js';
        import * as ui from '../scripts/ui.js';
        import * as router from '../scripts/router.js';
        import * as security from '../scripts/security.js';
        import * as db from '../scripts/db.js';
        import * as auth from '../scripts/auth.js';

        (async function initLocked() {
            ui.applyTheme();

            // Get lock details from URL or from stored lock status
            const params = new URLSearchParams(window.location.search);
            let reason = params.get('reason');
            let timestamp = params.get('timestamp');
            let duration = params.get('duration');

            // If not in URL, try to get from lock status in database
            if (!reason) {
                const lockStatus = await db.getLockStatus();
                if (lockStatus && lockStatus.locked) {
                    reason = lockStatus.reason;
                    timestamp = lockStatus.timestamp;
                    duration = lockStatus.duration || 'Permanent';
                }
            }

            // Fallback defaults
            if (!reason) reason = 'time_manipulation';
            if (!timestamp) timestamp = Date.now();
            if (!duration) duration = 'Permanent';

            // Display lock info
            const reasonEl = document.getElementById('lock-reason');
            if (reasonEl) reasonEl.textContent = getReasonDescription(reason);

            const timestampEl = document.getElementById('lock-timestamp');
            if (timestampEl) {
                timestampEl.textContent = `Locked on: ${utils.formatDate(new Date(parseInt(timestamp)))} at ${utils.formatTime(parseInt(timestamp))}`;
            }

            const durationEl = document.getElementById('lock-duration');
            if (durationEl) durationEl.textContent = duration;

            // Display device fingerprint
            const fpEl = document.getElementById('device-fp');
            if (fpEl) {
                fpEl.textContent = security.getDeviceFingerprint() || 'Not available';
            }
        })();

        function getReasonDescription(code) {
            const reasons = {
                'time_manipulation': 'Time manipulation detected. Changing device time to extend trial/subscription is strictly prohibited.',
                'multiple_devices': 'Account accessed from too many devices simultaneously.',
                'security_breach': 'Security breach detected. Account locked for your protection.',
                'payment_fraud': 'Suspicious payment activity detected.',
                'admin_lock': 'Account locked by administrator.',
                'trial_abuse': 'Multiple trial activations detected from the same device.'
            };
            return reasons[code] || 'Security violation detected. Your account has been locked.';
        }

        window.contactSupport = function () {
            const fingerprint = security.getDeviceFingerprint() || '';
            const reason = document.getElementById('lock-reason')?.textContent || '';
            const timestamp = document.getElementById('lock-timestamp')?.textContent || '';

            const subject = encodeURIComponent('Account Lock - Medical Exam Room Pro');
            const body = encodeURIComponent(
                `My account is locked. Please help.\n\n` +
                `Device Fingerprint: ${fingerprint}\n` +
                `Lock Reason: ${reason}\n` +
                `${timestamp}\n\n` +
                `My Details:\n` +
                `Name: \n` +
                `Email: \n` +
                `Phone: \n\n` +
                `Please unlock my account.`
            );
            window.location.href = `mailto:felixappbuilder@gmail.com?subject=${subject}&body=${body}`;
        };

        window.callSupport = function () {
            window.location.href = 'tel:+254746834527';
        };

        window.clearLocalData = async function () {
            const confirmed = await ui.showConfirmationDialog(
                'Clear Local Data',
                'WARNING: This will delete all local data including exam progress and saved questions. Only do this if instructed by support. Continue?',
                'critical'
            );
            if (!confirmed) return;

            ui.showLoading('Clearing data...');
            try {
                await db.clearDatabase();
                localStorage.clear();
                sessionStorage.clear();
                await auth.logout(); // ensure tokens are gone
                ui.hideLoading();
                ui.showToast('Local data cleared. Redirecting...', 'success');
                router.navigateTo('index.html');
            } catch (error) {
                ui.hideLoading();
                ui.showToast('Failed to clear data: ' + error.message, 'error');
            }
        };
    </script>
</head>

<body>
    <div class="locked-container">
        <div class="lock-card">
            <div class="lock-icon">üîí</div>
            <h1>Account Locked</h1>

            <div class="reason-box">
                <p id="lock-reason" class="reason"></p>
            </div>

            <div class="lock-details">
                <p id="lock-timestamp"></p>
                <p><strong>Lock duration:</strong> <span id="lock-duration"></span></p>
                <p><strong>Device fingerprint:</strong> <code id="device-fp"></code></p>
            </div>

            <div class="prevention-tips">
                <h3>‚ùì Why did this happen?</h3>
                <p>Medical Exam Room Pro has a zero‚Äëtolerance policy against time manipulation. Changing your device's
                    date or time to extend a trial or subscription is automatically detected and results in an
                    immediate, permanent lock.</p>
                <p>To prevent this in future:</p>
                <ul>
                    <li>Keep your device time set to automatic</li>
                    <li>Never use apps that alter system time</li>
                    <li>Use the app exactly as intended</li>
                </ul>
            </div>

            <div class="support-section">
                <h3>üìû Need help?</h3>
                <p>Contact support to request account unlock:</p>
                <div class="support-buttons">
                    <button onclick="contactSupport()" class="btn-primary">‚úâÔ∏è Email Support</button>
                    <button onclick="callSupport()" class="btn-secondary">üì± Call 0746834527</button>
                </div>
                <p class="small">Include your device fingerprint and the reason shown above.</p>
            </div>

            <hr>

            <div class="danger-zone">
                <h3>‚ö†Ô∏è Clear Local Data</h3>
                <p>Only use this if instructed by support. This will remove all locally stored exams and settings.</p>
                <button onclick="clearLocalData()" class="btn-danger">üóëÔ∏è Clear Local Data</button>
            </div>

            <button onclick="router.navigateTo('index.html')" class="btn-text">‚Üê Return to Home</button>
        </div>
    </div>

    <script data-lazy data-src="../scripts/offline.js"></script>
</body>

</html>