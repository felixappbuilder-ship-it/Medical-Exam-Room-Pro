<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password ‚Äì Medical Exam Room Pro</title>
    
    <link rel="manifest" href="../manifest.json">
    <link rel="stylesheet" href="../css/common.css" media="all">
    <link rel="stylesheet" href="../css/forgot-password.css" media="all">
    
    <script type="module" src="../scripts/utils.js"></script>
    <script type="module" src="../scripts/ui.js"></script>
    <script type="module" src="../scripts/router.js"></script>
    <script type="module" src="../scripts/validation.js"></script>
    <script type="module" src="../scripts/db.js"></script> 
    <script type="module" src="../scripts/auth.js"></script>
    <script type="module" src="../scripts/security.js"></script>
    
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('../service-worker.js').catch(() => {});
        }
    </script>
    
   <script type="module">
    // Import dependencies
    import * as app from '../scripts/app.js';
    import * as auth from '../scripts/auth.js';
    import * as ui from '../scripts/ui.js';
    import * as router from '../scripts/router.js';
    import * as validation from '../scripts/validation.js';
    import * as utils from '../scripts/utils.js';

    // State
    let currentIdentifier = '';
    let securityQuestions = [];

    // Initialize page
    window.addEventListener('load', function() {
        ui.applyTheme();

        // Redirect if already logged in (optional ‚Äì maybe still allow reset)
        if (app.checkAuth()) {
            // If logged in, maybe ask to logout first? We'll just allow reset anyway.
            // But we can show a warning.
            ui.showToast('You are already logged in. Resetting password will log you out.', 'warning');
        }

        // Check if there's a reset token in session (maybe from previous attempt)
        const resetToken = sessionStorage.getItem('resetToken');
        if (resetToken) {
            // Possibly auto-fill? We'll just ignore.
        }
    });

    // Step 1: Initiate reset ‚Äì get security questions
    window.initiateReset = async function(event) {
        event.preventDefault();

        const identifier = document.getElementById('email').value.trim();
        if (!validation.validateEmail(identifier) && !validation.validatePhone(identifier)) {
            ui.showToast('Enter a valid email or Kenyan phone', 'error');
            return;
        }

        ui.showLoading('Verifying account...');
        try {
            // Try to get security questions from auth module
            const questions = await auth.getSecurityQuestions(identifier);
            securityQuestions = questions;
            currentIdentifier = identifier;

            ui.hideLoading();

            // Show step 2
            document.getElementById('step1').style.display = 'none';
            document.getElementById('step2').style.display = 'block';

            // Render questions
            const container = document.getElementById('questions-container');
            container.innerHTML = securityQuestions.map((q, index) => `
                <div class="form-group">
                    <label>${q}</label>
                    <input type="text" id="answer-${index}" class="security-answer" placeholder="Your answer" autocomplete="off">
                </div>
            `).join('');

        } catch (error) {
            ui.hideLoading();
            ui.showToast(error.message || 'Account not found', 'error');
        }
    };

    // Step 2: Verify answers
    window.verifyAnswers = async function() {
        const answers = [];
        for (let i = 0; i < securityQuestions.length; i++) {
            const ans = document.getElementById(`answer-${i}`).value.trim();
            if (!ans) {
                ui.showToast('Please answer all questions', 'error');
                return;
            }
            answers.push(ans);
        }

        ui.showLoading('Verifying answers...');
        try {
            await auth.verifySecurityAnswers(currentIdentifier, answers);
            ui.hideLoading();

            // Show step 3
            document.getElementById('step2').style.display = 'none';
            document.getElementById('step3').style.display = 'block';
        } catch (error) {
            ui.hideLoading();
            ui.showToast(error.message || 'Incorrect answers', 'error');
        }
    };

    // Step 3: Reset password
    window.resetPassword = async function(event) {
        event.preventDefault();

        const newPassword = document.getElementById('new-password').value;
        const confirmPassword = document.getElementById('confirm-password').value;

        if (newPassword !== confirmPassword) {
            ui.showToast('Passwords do not match', 'error');
            return;
        }

        const strength = validation.validatePassword(newPassword);
        if (!strength.isValid) {
            ui.showToast('Password must be 8+ chars, include uppercase, lowercase, number', 'error');
            return;
        }

        ui.showLoading('Resetting password...');
        try {
            await auth.resetPassword(currentIdentifier, newPassword);
            ui.hideLoading();
            ui.showToast('Password reset successful! Please login.', 'success');
            // Redirect to login
            router.navigateTo('login.html');
        } catch (error) {
            ui.hideLoading();
            ui.showToast(error.message || 'Reset failed', 'error');
        }
    };

    // Back navigation
    window.backToStep1 = function() {
        document.getElementById('step2').style.display = 'none';
        document.getElementById('step1').style.display = 'block';
    };

    window.backToStep2 = function() {
        document.getElementById('step3').style.display = 'none';
        document.getElementById('step2').style.display = 'block';
    };
</script>
</head>
<body>
    <div class="page-container">
        <header>
            <div class="logo">
                <img src="../assets/images/logo.png" alt="Logo" width="40" height="40">
                <span>MedExamPro</span>
            </div>
            <button onclick="ui.toggleTheme()" class="btn-outline">üåì</button>
        </header>
        
        <main class="form-container">
            <h1>Reset Password</h1>
            
            <!-- Step 1: Email/Phone -->
            <div id="step1">
                <p class="instruction">Enter your registered email address or phone number.</p>
                <form onsubmit="initiateReset(event)">
                    <div class="form-group">
                        <label for="email">Email or Phone</label>
                        <input type="text" id="email" name="email" placeholder="e.g., student@example.com or 254712345678" required autofocus>
                    </div>
                    <button type="submit" class="btn-primary">Continue</button>
                </form>
                <p class="back-link">
                    <button onclick="router.navigateTo('login.html')" class="btn-text">‚Üê Back to Login</button>
                </p>
            </div>
            
            <!-- Step 2: Security Questions -->
            <div id="step2" style="display:none;">
                <p class="instruction">Answer the security questions you set during registration.</p>
                <div id="questions-container"></div>
                <button onclick="verifyAnswers()" class="btn-primary">Verify Answers</button>
                <p class="back-link">
                    <button onclick="document.getElementById('step2').style.display='none'; document.getElementById('step1').style.display='block';" class="btn-text">‚Üê Back</button>
                </p>
            </div>
            
            <!-- Step 3: New Password -->
            <div id="step3" style="display:none;">
                <p class="instruction">Enter your new password.</p>
                <form onsubmit="resetPassword(event)">
                    <div class="form-group">
                        <label for="new-password">New password</label>
                        <input type="password" id="new-password" required>
                        <small>8+ characters, at least one uppercase, one lowercase, one number</small>
                    </div>
                    <div class="form-group">
                        <label for="confirm-password">Confirm new password</label>
                        <input type="password" id="confirm-password" required>
                    </div>
                    <button type="submit" class="btn-primary">Reset Password</button>
                </form>
            </div>
        </main>
    </div>
    
    <script data-lazy data-src="../scripts/offline.js"></script>
</body>
</html>