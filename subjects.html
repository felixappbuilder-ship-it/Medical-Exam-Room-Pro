<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subjects - Medical Exam Room Pro</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/subjects.css">
    <link rel="icon" href="images/logo.png" type="image/png">
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('service-worker.js');
            });
        }
    </script>
</head>
<body>
    <header class="header">
        <div class="header-container">
            <div class="logo">
                <img src="images/logo.png" alt="Logo" class="logo-image">
                <div class="user-info">
                    <h1 class="logo-text">Select Subjects</h1>
                    <div class="subscription-status" id="subscriptionStatus">
                        <span class="status-icon">‚è≥</span>
                        <span class="status-text">Checking subscription...</span>
                    </div>
                </div>
            </div>
            
            <div class="header-actions">
                <button class="theme-toggle" id="themeToggle">
                    <span class="theme-icon">üåô</span>
                    <span class="theme-text">Dark Mode</span>
                </button>
                
                <button class="btn-profile" id="profileBtn">
                    <span class="profile-icon">üë§</span>
                    <span class="profile-text">Profile</span>
                </button>
                
                <button class="btn-logout" id="logoutBtn">
                    <span class="logout-icon">üö™</span>
                    <span class="logout-text">Logout</span>
                </button>
            </div>
        </div>
    </header>

    <main class="main-content">
        <div class="subjects-container">
            <div class="page-header">
                <h2>Choose Subjects to Study</h2>
                <p class="page-subtitle">Select one or more subjects. You can choose specific topics within each subject.</p>
                <div class="selection-info">
                    <div class="selected-count" id="selectedCount">0 subjects selected</div>
                    <div class="total-questions" id="totalQuestions">Total: 0 questions</div>
                </div>
            </div>
            
            <div class="subjects-grid" id="subjectsGrid">
                <!-- Subjects will be loaded dynamically -->
            </div>
            
            <div class="action-buttons">
                <button class="btn-secondary" id="selectAllBtn">
                    <span class="btn-icon">‚úì</span>
                    <span class="btn-text">Select All Subjects</span>
                </button>
                
                <button class="btn-secondary" id="clearAllBtn">
                    <span class="btn-icon">‚úó</span>
                    <span class="btn-text">Clear All</span>
                </button>
                
                <button class="btn-primary btn-continue" id="continueBtn" disabled>
                    <span class="btn-icon">‚Üí</span>
                    <span class="btn-text">Continue to Topics</span>
                </button>
            </div>
            
            <div class="quick-actions">
                <h3>Quick Start</h3>
                <div class="quick-buttons">
                    <button class="btn-quick" data-subjects='["Anatomy","Physiology"]'>
                        <span class="quick-icon">ü¶¥‚ù§Ô∏è</span>
                        <span class="quick-text">Anatomy + Physiology</span>
                        <span class="quick-count">1,870 questions</span>
                    </button>
                    
                    <button class="btn-quick" data-subjects='["Pathology","Pharmacology","Microbiology"]'>
                        <span class="quick-icon">ü©∫üíäü¶†</span>
                        <span class="quick-text">Clinical Subjects</span>
                        <span class="quick-count">1,430 questions</span>
                    </button>
                    
                    <button class="btn-quick" data-subjects='["Biochemistry","Histology","Embryology"]'>
                        <span class="quick-icon">üß™üî¨üë∂</span>
                        <span class="quick-text">Basic Sciences</span>
                        <span class="quick-count">1,650 questions</span>
                    </button>
                    
                    <button class="btn-quick" id="customBtn">
                        <span class="quick-icon">‚öôÔ∏è</span>
                        <span class="quick-text">Custom Selection</span>
                    </button>
                </div>
            </div>
            
            <div class="subscription-warning" id="subscriptionWarning" style="display: none;">
                <div class="warning-icon">‚ö†Ô∏è</div>
                <div class="warning-content">
                    <h4>Subscription Required</h4>
                    <p>Your free trial has expired. <a href="subscription.html" class="warning-link">Subscribe now</a> to continue accessing all subjects.</p>
                    <p class="warning-note">You can still browse subjects but cannot start exams.</p>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer-minimal">
        <p>Select subjects to proceed to topic selection. Each subject has specific topics you can choose from.</p>
    </footer>

    <script src="scripts/app.js"></script>
    <script src="scripts/subscription.js"></script>
    <script src="scripts/ui.js"></script>
    <script src="scripts/utils.js"></script>
    <script src="scripts/router.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Theme toggle
            const themeToggle = document.getElementById('themeToggle');
            const themeIcon = themeToggle.querySelector('.theme-icon');
            const themeText = themeToggle.querySelector('.theme-text');
            
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.body.classList.toggle('dark-theme', savedTheme === 'dark');
            
            if (savedTheme === 'dark') {
                themeIcon.textContent = '‚òÄÔ∏è';
                themeText.textContent = 'Light Mode';
            }
            
            themeToggle.addEventListener('click', function() {
                const isDark = document.body.classList.toggle('dark-theme');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
                
                if (isDark) {
                    themeIcon.textContent = '‚òÄÔ∏è';
                    themeText.textContent = 'Light Mode';
                } else {
                    themeIcon.textContent = 'üåô';
                    themeText.textContent = 'Dark Mode';
                }
            });
            
            // Navigation
            const profileBtn = document.getElementById('profileBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            
            profileBtn.addEventListener('click', function() {
                window.location.href = 'profile.html';
            });
            
            logoutBtn.addEventListener('click', function() {
                if (confirm('Are you sure you want to logout?')) {
                    localStorage.removeItem('accessToken');
                    localStorage.removeItem('userData');
                    localStorage.removeItem('tokenExpiry');
                    alert('Logged out successfully');
                    window.location.href = 'index.html';
                }
            });
            
            // Subjects data
            const subjects = [
                { id: 'anatomy', name: 'Anatomy', icon: 'ü¶¥', questions: 720, color: '#2196F3' },
                { id: 'physiology', name: 'Physiology', icon: '‚ù§Ô∏è', questions: 1150, color: '#F44336' },
                { id: 'biochemistry', name: 'Biochemistry', icon: 'üß™', questions: 810, color: '#4CAF50' },
                { id: 'histology', name: 'Histology', icon: 'üî¨', questions: 450, color: '#FF9800' },
                { id: 'embryology', name: 'Embryology', icon: 'üë∂', questions: 390, color: '#9C27B0' },
                { id: 'pathology', name: 'Pathology', icon: 'ü©∫', questions: 540, color: '#3F51B5' },
                { id: 'pharmacology', name: 'Pharmacology', icon: 'üíä', questions: 460, color: '#009688' },
                { id: 'microbiology', name: 'Microbiology', icon: 'ü¶†', questions: 430, color: '#FF5722' }
            ];
            
            const subjectsGrid = document.getElementById('subjectsGrid');
            const selectedCount = document.getElementById('selectedCount');
            const totalQuestions = document.getElementById('totalQuestions');
            const continueBtn = document.getElementById('continueBtn');
            const selectAllBtn = document.getElementById('selectAllBtn');
            const clearAllBtn = document.getElementById('clearAllBtn');
            const subscriptionStatus = document.getElementById('subscriptionStatus');
            const subscriptionWarning = document.getElementById('subscriptionWarning');
            
            let selectedSubjects = [];
            
            // Check subscription status
            function checkSubscription() {
                const subscriptionData = JSON.parse(localStorage.getItem('subscription') || '{}');
                const isActive = subscriptionData.isActive || false;
                const plan = subscriptionData.plan || 'none';
                const expiryDate = subscriptionData.expiryDate;
                
                if (isActive && expiryDate && new Date(expiryDate) > new Date()) {
                    subscriptionStatus.innerHTML = `
                        <span class="status-icon active">‚úì</span>
                        <span class="status-text">${plan === 'trial' ? 'Free Trial Active' : 'Subscription Active'} | Expires: ${new Date(expiryDate).toLocaleDateString()}</span>
                    `;
                    subscriptionWarning.style.display = 'none';
                    return true;
                } else {
                    subscriptionStatus.innerHTML = `
                        <span class="status-icon expired">‚úó</span>
                        <span class="status-text">No Active Subscription | <a href="subscription.html" class="status-link">Subscribe Now</a></span>
                    `;
                    subscriptionWarning.style.display = 'block';
                    return false;
                }
            }
            
            // Render subjects
            function renderSubjects() {
                subjectsGrid.innerHTML = '';
                subjects.forEach(subject => {
                    const isSelected = selectedSubjects.includes(subject.id);
                    const subjectCard = document.createElement('div');
                    subjectCard.className = `subject-card ${isSelected ? 'selected' : ''}`;
                    subjectCard.dataset.subjectId = subject.id;
                    subjectCard.style.borderColor = subject.color;
                    
                    subjectCard.innerHTML = `
                        <div class="subject-card-header">
                            <div class="subject-icon" style="background-color: ${subject.color}20; color: ${subject.color}">
                                ${subject.icon}
                            </div>
                            <label class="checkbox-label">
                                <input type="checkbox" class="subject-checkbox" ${isSelected ? 'checked' : ''}>
                                <span class="checkbox-custom"></span>
                            </label>
                        </div>
                        <div class="subject-card-body">
                            <h4 class="subject-name">${subject.name}</h4>
                            <p class="subject-questions">${subject.questions.toLocaleString()} questions</p>
                            <div class="subject-progress">
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${Math.random() * 100}%; background-color: ${subject.color}"></div>
                                </div>
                                <span class="progress-text">${Math.floor(Math.random() * 100)}% mastery</span>
                            </div>
                        </div>
                        <div class="subject-card-footer">
                            <button class="btn-view-topics" data-subject="${subject.id}">
                                <span class="btn-icon">üìö</span>
                                <span class="btn-text">View Topics</span>
                            </button>
                        </div>
                    `;
                    
                    subjectsGrid.appendChild(subjectCard);
                });
                
                updateSelectionInfo();
                attachSubjectEvents();
            }
            
            // Attach events to subject cards
            function attachSubjectEvents() {
                document.querySelectorAll('.subject-card').forEach(card => {
                    const checkbox = card.querySelector('.subject-checkbox');
                    const subjectId = card.dataset.subjectId;
                    const viewTopicsBtn = card.querySelector('.btn-view-topics');
                    
                    checkbox.addEventListener('change', function() {
                        if (this.checked) {
                            selectedSubjects.push(subjectId);
                            card.classList.add('selected');
                        } else {
                            selectedSubjects = selectedSubjects.filter(id => id !== subjectId);
                            card.classList.remove('selected');
                        }
                        updateSelectionInfo();
                    });
                    
                    card.addEventListener('click', function(e) {
                        if (!e.target.closest('.checkbox-label') && !e.target.closest('.btn-view-topics')) {
                            checkbox.checked = !checkbox.checked;
                            checkbox.dispatchEvent(new Event('change'));
                        }
                    });
                    
                    viewTopicsBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        localStorage.setItem('selectedSubject', subjectId);
                        window.location.href = `${subjectId}.html`;
                    });
                });
            }
            
            // Update selection info
            function updateSelectionInfo() {
                const selectedCountValue = selectedSubjects.length;
                const totalQuestionsValue = subjects
                    .filter(subject => selectedSubjects.includes(subject.id))
                    .reduce((sum, subject) => sum + subject.questions, 0);
                
                selectedCount.textContent = `${selectedCountValue} subject${selectedCountValue !== 1 ? 's' : ''} selected`;
                totalQuestions.textContent = `Total: ${totalQuestionsValue.toLocaleString()} questions`;
                
                continueBtn.disabled = selectedCountValue === 0;
                
                // Update quick buttons state
                document.querySelectorAll('.btn-quick').forEach(btn => {
                    if (btn.id !== 'customBtn') {
                        const btnSubjects = JSON.parse(btn.dataset.subjects).map(s => s.toLowerCase());
                        const allSelected = btnSubjects.every(s => selectedSubjects.includes(s));
                        btn.classList.toggle('active', allSelected);
                    }
                });
            }
            
            // Select all subjects
            selectAllBtn.addEventListener('click', function() {
                selectedSubjects = subjects.map(subject => subject.id);
                renderSubjects();
            });
            
            // Clear all selections
            clearAllBtn.addEventListener('click', function() {
                selectedSubjects = [];
                renderSubjects();
            });
            
            // Continue to topics
            continueBtn.addEventListener('click', function() {
                if (!checkSubscription()) {
                    alert('Please subscribe to continue. Your free trial has expired.');
                    window.location.href = 'subscription.html';
                    return;
                }
                
                localStorage.setItem('selectedSubjects', JSON.stringify(selectedSubjects));
                
                // If only one subject selected, go directly to that subject's topics
                if (selectedSubjects.length === 1) {
                    window.location.href = `${selectedSubjects[0]}.html`;
                } else {
                    // For multiple subjects, show confirmation
                    const confirmMessage = `You selected ${selectedSubjects.length} subjects. You'll choose topics for each subject separately. Continue?`;
                    if (confirm(confirmMessage)) {
                        window.location.href = `${selectedSubjects[0]}.html`;
                    }
                }
            });
            
            // Quick selection buttons
            document.querySelectorAll('.btn-quick').forEach(btn => {
                if (btn.id !== 'customBtn') {
                    btn.addEventListener('click', function() {
                        const btnSubjects = JSON.parse(this.dataset.subjects).map(s => s.toLowerCase());
                        
                        // Toggle selection
                        const allSelected = btnSubjects.every(s => selectedSubjects.includes(s));
                        if (allSelected) {
                            // Deselect all
                            selectedSubjects = selectedSubjects.filter(id => !btnSubjects.includes(id));
                        } else {
                            // Select all (add unique)
                            btnSubjects.forEach(subjectId => {
                                if (!selectedSubjects.includes(subjectId)) {
                                    selectedSubjects.push(subjectId);
                                }
                            });
                        }
                        
                        renderSubjects();
                    });
                }
            });
            
            // Custom selection button
            document.getElementById('customBtn').addEventListener('click', function() {
                // This allows manual selection, which is already enabled
                alert('You can manually select subjects by clicking on them.');
            });
            
            // Load previously selected subjects
            const savedSubjects = JSON.parse(localStorage.getItem('selectedSubjects') || '[]');
            if (savedSubjects.length > 0) {
                selectedSubjects = savedSubjects;
            }
            
            // Initialize
            checkSubscription();
            renderSubjects();
            
            // Initialize app state
            if (typeof initApp === 'function') {
                initApp();
            }
        });
    </script>
</body>
</html>