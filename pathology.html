<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pathology Topics - Medical Exam Room Pro</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/pathology.css">
    <link rel="icon" href="images/logo.png" type="image/png">
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('service-worker.js');
            });
        }
    </script>
</head>
<body>
    <header class="header">
        <div class="header-container">
            <div class="logo">
                <img src="images/logo.png" alt="Logo" class="logo-image">
                <div class="subject-header">
                    <div class="subject-title">
                        <span class="subject-icon">ü©∫</span>
                        <h1>Pathology</h1>
                    </div>
                    <div class="subject-stats">
                        <span class="stat">540 Questions</span>
                        <span class="stat">10 Topics</span>
                        <span class="stat" id="masteryLevel">70% Mastery</span>
                    </div>
                </div>
            </div>
            
            <div class="header-actions">
                <button class="theme-toggle" id="themeToggle">
                    <span class="theme-icon">üåô</span>
                    <span class="theme-text">Dark Mode</span>
                </button>
                
                <button class="btn-back" id="backBtn">
                    <span class="back-icon">‚Üê</span>
                    <span class="back-text">Back to Subjects</span>
                </button>
                
                <button class="btn-profile" id="profileBtn">
                    <span class="profile-icon">üë§</span>
                </button>
            </div>
        </div>
    </header>

    <main class="main-content">
        <div class="topics-container">
            <div class="page-header">
                <h2>Select Pathology Topics</h2>
                <p class="page-subtitle">Choose specific topics to focus on. Each topic contains multiple questions.</p>
                
                <div class="selection-controls">
                    <button class="btn-control" id="selectAllBtn">
                        <span class="control-icon">‚úì</span>
                        <span class="control-text">Select All Topics</span>
                    </button>
                    
                    <button class="btn-control" id="clearAllBtn">
                        <span class="control-icon">‚úó</span>
                        <span class="control-text">Clear All</span>
                    </button>
                    
                    <button class="btn-control" id="smartSelectBtn">
                        <span class="control-icon">üéØ</span>
                        <span class="control-text">Smart Select (Weak Areas)</span>
                    </button>
                </div>
                
                <div class="selection-summary" id="selectionSummary">
                    <div class="summary-item">
                        <span class="summary-label">Selected Topics:</span>
                        <span class="summary-value" id="selectedTopicsCount">0</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Total Questions:</span>
                        <span class="summary-value" id="totalQuestionsCount">0</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Estimated Time:</span>
                        <span class="summary-value" id="estimatedTime">0 min</span>
                    </div>
                </div>
            </div>
            
            <div class="topics-grid" id="topicsGrid">
                <!-- Topics will be loaded dynamically -->
            </div>
            
           
            
            <div class="action-buttons">
                <button class="btn-secondary" id="cancelBtn">
                    <span class="btn-icon">‚Üê</span>
                    <span class="btn-text">Back to Subjects</span>
                </button>
                
                <button class="btn-primary" id="startExamBtn" disabled>
                    <span class="btn-icon">‚ñ∂Ô∏è</span>
                    <span class="btn-text">Start Exam</span>
                </button>
                
                <button class="btn-secondary" id="saveSettingsBtn">
                    <span class="btn-icon">üíæ</span>
                    <span class="btn-text">Save as Preset</span>
                </button>
            </div>
            
            <div class="recent-performance">
                <h3>Your Recent Performance in Pathology</h3>
                <div class="performance-stats">
                    <div class="stat-card">
                        <div class="stat-value">70%</div>
                        <div class="stat-label">Average Score</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">29s</div>
                        <div class="stat-label">Avg Time/Question</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">35</div>
                        <div class="stat-label">Exams Taken</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">3</div>
                        <div class="stat-label">Weak Topics</div>
                    </div>
                </div>
                
                <div class="weak-topics" id="weakTopics">
                    <!-- Weak topics will be loaded dynamically -->
                </div>
            </div>
        </div>
    </main>

    <footer class="footer-minimal">
        <p>Select topics and configure your exam settings. You can save your favorite configurations as presets.</p>
    </footer>

    <script src="scripts/app.js"></script>
    <script src="scripts/questions.js"></script>
    <script src="scripts/subscription.js"></script>
    <script src="scripts/ui.js"></script>
    <script src="scripts/utils.js"></script>
    <script src="scripts/router.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Theme toggle
            const themeToggle = document.getElementById('themeToggle');
            const themeIcon = themeToggle.querySelector('.theme-icon');
            const themeText = themeToggle.querySelector('.theme-text');
            
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.body.classList.toggle('dark-theme', savedTheme === 'dark');
            
            if (savedTheme === 'dark') {
                themeIcon.textContent = '‚òÄÔ∏è';
                themeText.textContent = 'Light Mode';
            }
            
            themeToggle.addEventListener('click', function() {
                const isDark = document.body.classList.toggle('dark-theme');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
                
                if (isDark) {
                    themeIcon.textContent = '‚òÄÔ∏è';
                    themeText.textContent = 'Light Mode';
                } else {
                    themeIcon.textContent = 'üåô';
                    themeText.textContent = 'Dark Mode';
                }
            });
            
            // Navigation
            const backBtn = document.getElementById('backBtn');
            const profileBtn = document.getElementById('profileBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            
            backBtn.addEventListener('click', function() {
                window.location.href = 'subjects.html';
            });
            
            profileBtn.addEventListener('click', function() {
                window.location.href = 'profile.html';
            });
            
            cancelBtn.addEventListener('click', function() {
                window.location.href = 'subjects.html';
            });
            
            // Pathology topics data (540 questions total)
            const topics = [
                { id: 'cellular-injury', name: 'Cellular Injury & Adaptation', questions: 70, mastery: 75, weak: false },
                { id: 'inflammation', name: 'Inflammation & Repair', questions: 65, mastery: 82, weak: false },
                { id: 'hemodynamic-disorders', name: 'Hemodynamic Disorders', questions: 55, mastery: 78, weak: false },
                { id: 'genetic-disorders', name: 'Genetic Disorders', questions: 50, mastery: 65, weak: true },
                { id: 'immunopathology', name: 'Immunopathology', questions: 60, mastery: 70, weak: false },
                { id: 'neoplasia', name: 'Neoplasia', questions: 80, mastery: 58, weak: true },
                { id: 'infectious-diseases', name: 'Infectious Diseases', questions: 55, mastery: 72, weak: false },
                { id: 'environmental-pathology', name: 'Environmental Pathology', questions: 45, mastery: 68, weak: false },
                { id: 'systemic-pathology', name: 'Systemic Pathology', questions: 50, mastery: 62, weak: false },
                { id: 'clinical-pathology', name: 'Clinical Pathology', questions: 50, mastery: 55, weak: true }
            ];
            
            const topicsGrid = document.getElementById('topicsGrid');
            const selectedTopicsCount = document.getElementById('selectedTopicsCount');
            const totalQuestionsCount = document.getElementById('totalQuestionsCount');
            const estimatedTime = document.getElementById('estimatedTime');
            const startExamBtn = document.getElementById('startExamBtn');
            const selectAllBtn = document.getElementById('selectAllBtn');
            const clearAllBtn = document.getElementById('clearAllBtn');
            const smartSelectBtn = document.getElementById('smartSelectBtn');
            const selectionSummary = document.getElementById('selectionSummary');
            const weakTopicsContainer = document.getElementById('weakTopics');
            
            let selectedTopics = [];
            
            // Check subscription
            function checkSubscription() {
                const subscriptionData = JSON.parse(localStorage.getItem('subscription') || '{}');
                const isActive = subscriptionData.isActive || false;
                const expiryDate = subscriptionData.expiryDate;
                
                if (!isActive || !expiryDate || new Date(expiryDate) <= new Date()) {
                    alert('Your subscription has expired. Please subscribe to start exams.');
                    window.location.href = 'subscription.html';
                    return false;
                }
                return true;
            }
            
            // Render topics
            function renderTopics() {
                topicsGrid.innerHTML = '';
                topics.forEach(topic => {
                    const isSelected = selectedTopics.includes(topic.id);
                    const topicCard = document.createElement('div');
                    topicCard.className = `topic-card ${isSelected ? 'selected' : ''} ${topic.weak ? 'weak' : ''}`;
                    topicCard.dataset.topicId = topic.id;
                    
                    topicCard.innerHTML = `
                        <div class="topic-card-header">
                            <div class="topic-checkbox">
                                <label class="checkbox-label">
                                    <input type="checkbox" class="topic-checkbox-input" ${isSelected ? 'checked' : ''}>
                                    <span class="checkbox-custom"></span>
                                </label>
                            </div>
                            <div class="topic-mastery">
                                <div class="mastery-circle">
                                    <svg width="40" height="40">
                                        <circle cx="20" cy="20" r="15" stroke="#e0e0e0" stroke-width="3" fill="none"></circle>
                                        <circle cx="20" cy="20" r="15" stroke="#3F51B5" stroke-width="3" fill="none" 
                                                stroke-dasharray="${2 * Math.PI * 15}" 
                                                stroke-dashoffset="${2 * Math.PI * 15 * (1 - topic.mastery / 100)}"
                                                transform="rotate(-90 20 20)"></circle>
                                    </svg>
                                    <span class="mastery-percent">${topic.mastery}%</span>
                                </div>
                            </div>
                        </div>
                        <div class="topic-card-body">
                            <h4 class="topic-name">${topic.name}</h4>
                            <p class="topic-questions">${topic.questions} questions</p>
                            <div class="topic-tags">
                                ${topic.weak ? '<span class="tag weak">Weak Area</span>' : ''}
                                <span class="tag difficulty">Medium Difficulty</span>
                            </div>
                        </div>
                        <div class="topic-card-footer">
                            <div class="topic-stats">
                                <span class="stat">Avg: 29s</span>
                                <span class="stat">Acc: ${topic.mastery}%</span>
                            </div>
                        </div>
                    `;
                    
                    topicsGrid.appendChild(topicCard);
                });
                
                updateSelectionInfo();
                attachTopicEvents();
                renderWeakTopics();
            }
            
            // Attach events to topic cards
            function attachTopicEvents() {
                document.querySelectorAll('.topic-card').forEach(card => {
                    const checkbox = card.querySelector('.topic-checkbox-input');
                    const topicId = card.dataset.topicId;
                    
                    checkbox.addEventListener('change', function() {
                        if (this.checked) {
                            selectedTopics.push(topicId);
                            card.classList.add('selected');
                        } else {
                            selectedTopics = selectedTopics.filter(id => id !== topicId);
                            card.classList.remove('selected');
                        }
                        updateSelectionInfo();
                    });
                    
                    card.addEventListener('click', function(e) {
                        if (!e.target.closest('.checkbox-label') && !e.target.closest('.topic-checkbox')) {
                            checkbox.checked = !checkbox.checked;
                            checkbox.dispatchEvent(new Event('change'));
                        }
                    });
                });
            }
            
            // Update selection info
            function updateSelectionInfo() {
                const selectedCount = selectedTopics.length;
                const totalQuestions = topics
                    .filter(topic => selectedTopics.includes(topic.id))
                    .reduce((sum, topic) => sum + topic.questions, 0);
                
                // Calculate estimated time (average 30 seconds per question)
                const estimatedMinutes = Math.ceil((totalQuestions * 30) / 60);
                
                selectedTopicsCount.textContent = selectedCount;
                totalQuestionsCount.textContent = totalQuestions;
                estimatedTime.textContent = `${estimatedMinutes} min`;
                
                startExamBtn.disabled = selectedCount === 0;
                
                // Update selection summary style
                if (selectedCount > 0) {
                    selectionSummary.classList.add('active');
                } else {
                    selectionSummary.classList.remove('active');
                }
            }
            
            // Render weak topics
            function renderWeakTopics() {
                const weakTopicsList = topics.filter(topic => topic.weak);
                weakTopicsContainer.innerHTML = '';
                
                if (weakTopicsList.length > 0) {
                    weakTopicsList.forEach(topic => {
                        const weakTopic = document.createElement('div');
                        weakTopic.className = 'weak-topic-item';
                        weakTopic.innerHTML = `
                            <div class="weak-topic-name">${topic.name}</div>
                            <div class="weak-topic-actions">
                                <button class="btn-weak-select" data-topic="${topic.id}">
                                    <span class="btn-icon">+</span>
                                    <span class="btn-text">Select</span>
                                </button>
                                <button class="btn-weak-practice" data-topic="${topic.id}">
                                    <span class="btn-icon">üéØ</span>
                                    <span class="btn-text">Practice</span>
                                </button>
                            </div>
                        `;
                        weakTopicsContainer.appendChild(weakTopic);
                    });
                } else {
                    weakTopicsContainer.innerHTML = '<p class="no-weak">No weak topics identified. Keep up the good work!</p>';
                }
                
                // Attach weak topic button events
                document.querySelectorAll('.btn-weak-select').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const topicId = this.dataset.topic;
                        if (!selectedTopics.includes(topicId)) {
                            selectedTopics.push(topicId);
                            renderTopics();
                        }
                    });
                });
                
                document.querySelectorAll('.btn-weak-practice').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const topicId = this.dataset.topic;
                        localStorage.setItem('quickPracticeTopic', topicId);
                        alert(`Quick practice for ${topics.find(t => t.id === topicId).name} will start with 10 questions.`);
                    });
                });
            }
            
            // Select all topics
            selectAllBtn.addEventListener('click', function() {
                selectedTopics = topics.map(topic => topic.id);
                renderTopics();
            });
            
            // Clear all selections
            clearAllBtn.addEventListener('click', function() {
                selectedTopics = [];
                renderTopics();
            });
            
            // Smart select (weak areas)
            smartSelectBtn.addEventListener('click', function() {
                const weakTopicIds = topics.filter(topic => topic.weak).map(topic => topic.id);
                selectedTopics = [...new Set([...selectedTopics, ...weakTopicIds])];
                renderTopics();
                alert(`Selected ${weakTopicIds.length} weak area${weakTopicIds.length !== 1 ? 's' : ''} for focused practice.`);
            });
            
            // Start exam
            startExamBtn.addEventListener('click', function() {
                if (!checkSubscription()) return;
                
                // Save exam configuration
                const examConfig = {
                    subject: 'pathology',
                    topics: selectedTopics,
                    examMode: document.getElementById('examMode').value,
                    questionCount: document.getElementById('questionCount').value,
                    difficulty: document.getElementById('difficulty').value,
                    timerMode: document.getElementById('timerMode').value,
                    timestamp: Date.now()
                };
                
                localStorage.setItem('examConfig', JSON.stringify(examConfig));
                localStorage.setItem('selectedTopics', JSON.stringify(selectedTopics));
                
                // Navigate to exam settings for final confirmation
                window.location.href = 'exam-settings.html';
            });
            
            // Save settings as preset
            document.getElementById('saveSettingsBtn').addEventListener('click', function() {
                const presetName = prompt('Enter a name for this preset:');
                if (presetName) {
                    const preset = {
                        name: presetName,
                        subject: 'pathology',
                        topics: selectedTopics,
                        examMode: document.getElementById('examMode').value,
                        questionCount: document.getElementById('questionCount').value,
                        difficulty: document.getElementById('difficulty').value,
                        timerMode: document.getElementById('timerMode').value,
                        savedAt: new Date().toISOString()
                    };
                    
                    // Save to localStorage
                    const presets = JSON.parse(localStorage.getItem('examPresets') || '[]');
                    presets.push(preset);
                    localStorage.setItem('examPresets', JSON.stringify(presets));
                    
                    alert(`Preset "${presetName}" saved successfully!`);
                }
            });
            
            // Load question count based on selected topics
            function updateQuestionCountOptions() {
                const totalAvailableQuestions = topics
                    .filter(topic => selectedTopics.includes(topic.id))
                    .reduce((sum, topic) => sum + topic.questions, 0);
                
                const questionCountSelect = document.getElementById('questionCount');
                const currentValue = questionCountSelect.value;
                
                // Update options based on available questions
                const options = questionCountSelect.querySelectorAll('option');
                options.forEach(option => {
                    if (option.value === 'custom') return;
                    
                    const value = parseInt(option.value);
                    if (value > totalAvailableQuestions) {
                        option.disabled = true;
                        option.textContent = `${option.value} (Not enough questions)`;
                    } else {
                        option.disabled = false;
                        option.textContent = option.value === '10' ? 'Quick Exam (10)' :
                                           option.value === '25' ? 'Standard (25)' :
                                           option.value === '50' ? 'Full Exam (50)' : option.value;
                    }
                });
                
                // If current value is not available, select the largest available
                if (currentValue !== 'custom' && parseInt(currentValue) > totalAvailableQuestions) {
                    const availableOptions = Array.from(options)
                        .filter(opt => !opt.disabled && opt.value !== 'custom')
                        .map(opt => parseInt(opt.value))
                        .sort((a, b) => b - a);
                    
                    if (availableOptions.length > 0) {
                        questionCountSelect.value = availableOptions[0];
                    }
                }
            }
            
            // Watch for selection changes to update question count options
            topicsGrid.addEventListener('change', function() {
                setTimeout(updateQuestionCountOptions, 100);
            });
            
            // Load previously selected topics
            const savedTopics = JSON.parse(localStorage.getItem('selectedTopics') || '[]');
            if (savedTopics.length > 0) {
                selectedTopics = savedTopics.filter(topic => 
                    topics.some(t => t.id === topic)
                );
            }
            
            // Load saved exam settings
            const savedConfig = JSON.parse(localStorage.getItem('examConfig') || '{}');
            if (savedConfig.subject === 'pathology') {
                document.getElementById('examMode').value = savedConfig.examMode || 'timed';
                document.getElementById('questionCount').value = savedConfig.questionCount || '25';
                document.getElementById('difficulty').value = savedConfig.difficulty || 'mixed';
                document.getElementById('timerMode').value = savedConfig.timerMode || 'adaptive';
            }
            
            // Initialize
            renderTopics();
            updateQuestionCountOptions();
            
            // Initialize app state
            if (typeof initApp === 'function') {
                initApp();
            }
        });
    </script>
</body>
</html>