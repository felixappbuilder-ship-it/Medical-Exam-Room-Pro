<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment - Medical Exam Room Pro</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/payment.css">
    <link rel="icon" href="images/logo.png" type="image/png">
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('service-worker.js');
            });
        }
    </script>
</head>
<body>
    <header class="header">
        <div class="header-container">
            <div class="logo">
                <img src="images/logo.png" alt="Logo" class="logo-image">
                <h1 class="logo-text">Payment</h1>
            </div>
            
            <div class="header-actions">
                <button class="theme-toggle" id="themeToggle">
                    <span class="theme-icon">üåô</span>
                    <span class="theme-text">Dark Mode</span>
                </button>
                
                <button class="btn-back" id="backBtn">
                    <span class="back-icon">‚Üê</span>
                    <span class="back-text">Back to Plans</span>
                </button>
            </div>
        </div>
    </header>

    <main class="main-content">
        <div class="payment-container">
            <div class="payment-header">
                <h2>Complete Your Purchase</h2>
                <p class="payment-subtitle">Secure payment via M-Pesa</p>
            </div>
            
            <div class="payment-process">
                <div class="process-steps">
                    <div class="step active" data-step="1">
                        <div class="step-number">1</div>
                        <div class="step-text">Select Plan</div>
                    </div>
                    <div class="step active" data-step="2">
                        <div class="step-number">2</div>
                        <div class="step-text">Enter Details</div>
                    </div>
                    <div class="step" data-step="3">
                        <div class="step-number">3</div>
                        <div class="step-text">Confirm Payment</div>
                    </div>
                    <div class="step" data-step="4">
                        <div class="step-number">4</div>
                        <div class="step-text">Access Granted</div>
                    </div>
                </div>
                
                <div class="order-summary" id="orderSummary">
                    <!-- Order summary will be loaded here -->
                </div>
                
                <form id="paymentForm" class="payment-form">
                    <div class="form-section">
                        <h3>1. Plan Details</h3>
                        <div class="plan-details" id="planDetails">
                            <!-- Plan details will be loaded here -->
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3>2. Payment Method</h3>
                        <div class="payment-method-selector">
                            <div class="method-option active" data-method="mpesa">
                                <div class="method-icon">üì±</div>
                                <div class="method-info">
                                    <h4>M-Pesa</h4>
                                    <p>Pay via M-Pesa STK Push</p>
                                </div>
                                <div class="method-check">‚úì</div>
                            </div>
                        </div>
                        
                        <div class="mpesa-details">
                            <div class="form-group">
                                <label for="phoneNumber">M-Pesa Phone Number *</label>
                                <input type="tel" id="phoneNumber" name="phoneNumber" 
                                       placeholder="2547XXXXXXXX or 07XXXXXXXX" required>
                                <div class="input-hint">Enter the phone number registered with M-Pesa</div>
                            </div>
                            
                            <div class="form-group">
                                <label for="confirmPhone">Confirm Phone Number *</label>
                                <input type="tel" id="confirmPhone" name="confirmPhone" 
                                       placeholder="Re-enter phone number" required>
                                <div class="phone-match" id="phoneMatch"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3>3. Billing Information</h3>
                        <div class="billing-info">
                            <p>You will receive an M-Pesa prompt on your phone. Enter your M-Pesa PIN to complete the payment.</p>
                            <p><strong>Important:</strong> Ensure you have sufficient funds in your M-Pesa account.</p>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3>4. Terms & Conditions</h3>
                        <div class="terms-agreement">
                            <label class="checkbox-label">
                                <input type="checkbox" id="termsAgreement" name="termsAgreement" required>
                                <span class="checkbox-custom"></span>
                                <span class="checkbox-text">I agree to the <a href="#terms" class="link">Terms of Service</a> and authorize this payment</span>
                            </label>
                            
                            <label class="checkbox-label">
                                <input type="checkbox" id="autoRenewal" name="autoRenewal">
                                <span class="checkbox-custom"></span>
                                <span class="checkbox-text">Enable auto-renewal (cancel anytime)</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn-secondary" id="cancelBtn">
                            <span class="btn-icon">‚Üê</span>
                            <span class="btn-text">Cancel</span>
                        </button>
                        
                        <button type="submit" class="btn-primary" id="submitBtn">
                            <span class="btn-icon">üí≥</span>
                            <span class="btn-text">Pay via M-Pesa</span>
                            <span class="btn-spinner" id="submitSpinner" style="display: none;">‚è≥</span>
                        </button>
                    </div>
                </form>
                
                <div class="payment-status" id="paymentStatus" style="display: none;">
                    <div class="status-header">
                        <div class="status-icon" id="statusIcon">‚è≥</div>
                        <h3 id="statusTitle">Processing Payment</h3>
                    </div>
                    <div class="status-content">
                        <p id="statusMessage">Please wait while we process your payment...</p>
                        <div class="status-progress">
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressFill"></div>
                            </div>
                            <div class="progress-text" id="progressText">0%</div>
                        </div>
                        <div class="status-instructions" id="statusInstructions">
                            <!-- Instructions will be shown here -->
                        </div>
                        <div class="status-actions" id="statusActions" style="display: none;">
                            <button class="btn-primary" id="continueBtn">Continue to App</button>
                            <button class="btn-secondary" id="viewReceiptBtn">View Receipt</button>
                            <button class="btn-secondary" id="retryBtn">Retry Payment</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="security-assurance">
                <div class="security-icon">üîí</div>
                <div class="security-content">
                    <h4>Secure Payment</h4>
                    <p>Your payment is processed securely via M-Pesa. We do not store your M-Pesa PIN or personal financial information.</p>
                    <div class="security-features">
                        <span class="feature">‚úì SSL Encrypted</span>
                        <span class="feature">‚úì PCI Compliant</span>
                        <span class="feature">‚úì Fraud Protection</span>
                    </div>
                </div>
            </div>
            
            <div class="support-info">
                <p>Having issues with payment? Contact support: <strong>felixappbuilder@gmail.com</strong> or call <strong>0746834527</strong></p>
            </div>
        </div>
    </main>

    <footer class="footer-minimal">
        <p>¬© 2024 Medical Exam Room Pro | M-Pesa is a registered trademark of Safaricom PLC</p>
    </footer>

    <script src="scripts/app.js"></script>
    <script src="scripts/payment.js"></script>
    <script src="scripts/validation.js"></script>
    <script src="scripts/subscription.js"></script>
    <script src="scripts/ui.js"></script>
    <script src="scripts/utils.js"></script>
    <script src="scripts/router.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Theme toggle
            const themeToggle = document.getElementById('themeToggle');
            const themeIcon = themeToggle.querySelector('.theme-icon');
            const themeText = themeToggle.querySelector('.theme-text');
            
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.body.classList.toggle('dark-theme', savedTheme === 'dark');
            
            if (savedTheme === 'dark') {
                themeIcon.textContent = '‚òÄÔ∏è';
                themeText.textContent = 'Light Mode';
            }
            
            themeToggle.addEventListener('click', function() {
                const isDark = document.body.classList.toggle('dark-theme');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
                
                if (isDark) {
                    themeIcon.textContent = '‚òÄÔ∏è';
                    themeText.textContent = 'Light Mode';
                } else {
                    themeIcon.textContent = 'üåô';
                    themeText.textContent = 'Dark Mode';
                }
            });
            
            // Navigation
            const backBtn = document.getElementById('backBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            
            backBtn.addEventListener('click', function() {
                window.location.href = 'subscription.html';
            });
            
            cancelBtn.addEventListener('click', function() {
                if (confirm('Are you sure you want to cancel? Your payment will not be processed.')) {
                    window.location.href = 'subscription.html';
                }
            });
            
            // Plan data
            const plans = {
                monthly: { name: 'Monthly Plan', price: 350, duration: '30 days', savings: '' },
                quarterly: { name: 'Quarterly Plan', price: 850, duration: '90 days', savings: 'Save KES 200' },
                yearly: { name: 'Yearly Plan', price: 2100, duration: '365 days', savings: 'Save KES 1,100' }
            };
            
            // Load selected plan
            const selectedPlan = localStorage.getItem('selectedPlan') || 'monthly';
            const plan = plans[selectedPlan];
            
            // Update order summary
            document.getElementById('orderSummary').innerHTML = `
                <div class="summary-header">
                    <h3>Order Summary</h3>
                    <button class="btn-change-plan" id="changePlanBtn">Change Plan</button>
                </div>
                <div class="summary-details">
                    <div class="summary-item">
                        <span class="item-label">Plan:</span>
                        <span class="item-value">${plan.name}</span>
                    </div>
                    <div class="summary-item">
                        <span class="item-label">Duration:</span>
                        <span class="item-value">${plan.duration}</span>
                    </div>
                    <div class="summary-item">
                        <span class="item-label">Price:</span>
                        <span class="item-value">KES ${plan.price.toLocaleString()}</span>
                    </div>
                    ${plan.savings ? `
                    <div class="summary-item savings">
                        <span class="item-label">Savings:</span>
                        <span class="item-value">${plan.savings}</span>
                    </div>
                    ` : ''}
                    <div class="summary-total">
                        <span class="total-label">Total Amount:</span>
                        <span class="total-value">KES ${plan.price.toLocaleString()}</span>
                    </div>
                </div>
            `;
            
            // Update plan details
            document.getElementById('planDetails').innerHTML = `
                <div class="plan-card">
                    <div class="plan-name">${plan.name}</div>
                    <div class="plan-price">KES ${plan.price.toLocaleString()}</div>
                    <div class="plan-duration">${plan.duration} access</div>
                    ${plan.savings ? `<div class="plan-savings">${plan.savings}</div>` : ''}
                </div>
            `;
            
            // Change plan button
            document.getElementById('changePlanBtn').addEventListener('click', function() {
                window.location.href = 'subscription.html';
            });
            
            // Phone number validation
            const phoneNumber = document.getElementById('phoneNumber');
            const confirmPhone = document.getElementById('confirmPhone');
            const phoneMatch = document.getElementById('phoneMatch');
            
            function validatePhoneNumber(phone) {
                const digits = phone.replace(/\D/g, '');
                return (digits.length === 12 && digits.startsWith('254')) ||
                       (digits.length === 9 && digits.startsWith('7')) ||
                       (digits.length === 10 && digits.startsWith('07'));
            }
            
            function checkPhoneMatch() {
                const phone1 = phoneNumber.value;
                const phone2 = confirmPhone.value;
                
                if (!phone1 || !phone2) {
                    phoneMatch.textContent = '';
                    return;
                }
                
                if (phone1 === phone2) {
                    phoneMatch.textContent = '‚úì Phone numbers match';
                    phoneMatch.style.color = '#4caf50';
                } else {
                    phoneMatch.textContent = '‚úó Phone numbers do not match';
                    phoneMatch.style.color = '#f44336';
                }
            }
            
            phoneNumber.addEventListener('input', function() {
                checkPhoneMatch();
                // Auto-format phone number
                let phone = this.value.replace(/\D/g, '');
                if (phone.length === 9 && phone.startsWith('7')) {
                    this.value = '254' + phone;
                } else if (phone.length === 10 && phone.startsWith('07')) {
                    this.value = '254' + phone.substring(1);
                }
            });
            
            confirmPhone.addEventListener('input', checkPhoneMatch);
            
            // Payment form submission
            const paymentForm = document.getElementById('paymentForm');
            const submitBtn = document.getElementById('submitBtn');
            const submitSpinner = document.getElementById('submitSpinner');
            const paymentStatus = document.getElementById('paymentStatus');
            const statusIcon = document.getElementById('statusIcon');
            const statusTitle = document.getElementById('statusTitle');
            const statusMessage = document.getElementById('statusMessage');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const statusInstructions = document.getElementById('statusInstructions');
            const statusActions = document.getElementById('statusActions');
            
            let paymentInterval;
            let paymentAttempts = 0;
            const maxAttempts = 3;
            
            paymentForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                // Validate form
                const phone = phoneNumber.value.trim();
                const confirmPhoneValue = confirmPhone.value.trim();
                const termsAgreement = document.getElementById('termsAgreement').checked;
                
                if (!validatePhoneNumber(phone)) {
                    alert('Please enter a valid Kenyan phone number (e.g., 2547XXXXXXXX or 07XXXXXXXX)');
                    return;
                }
                
                if (phone !== confirmPhoneValue) {
                    alert('Phone numbers do not match. Please confirm your phone number.');
                    return;
                }
                
                if (!termsAgreement) {
                    alert('You must agree to the Terms of Service to proceed.');
                    return;
                }
                
                // Check internet connection
                if (!navigator.onLine) {
                    alert('Internet connection required for payment. Please connect and try again.');
                    return;
                }
                
                // Show payment status
                paymentForm.style.display = 'none';
                paymentStatus.style.display = 'block';
                
                // Start payment process
                startPaymentProcess(phone, plan);
            });
            
            async function startPaymentProcess(phone, plan) {
                submitBtn.disabled = true;
                submitSpinner.style.display = 'inline-block';
                
                try {
                    // Format phone number
                    const phoneDigits = phone.replace(/\D/g, '');
                    const formattedPhone = phoneDigits.length === 9 ? '254' + phoneDigits :
                                          phoneDigits.length === 10 ? '254' + phoneDigits.substring(1) : phoneDigits;
                    
                    // Get user data
                    const userData = JSON.parse(localStorage.getItem('userData') || '{}');
                    
                    // Prepare payment data
                    const paymentData = {
                        phoneNumber: formattedPhone,
                        amount: plan.price,
                        plan: selectedPlan,
                        description: `Medical Exam Room Pro - ${plan.name}`,
                        userId: userData.id || 'guest',
                        deviceInfo: {
                            deviceId: localStorage.getItem('deviceId') || 'unknown',
                            timestamp: Date.now()
                        }
                    };
                    
                    // Update status
                    updatePaymentStatus('initiating', 'Initiating payment...', 10);
                    
                    // Call payment API
                    const response = await fetch('https://medicalexamroom.onrender.com/api/v1/payments/initiate', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('accessToken') || ''}`,
                            'X-Device-Fingerprint': localStorage.getItem('deviceId') || '',
                            'X-Client-Time': Date.now().toString()
                        },
                        body: JSON.stringify(paymentData)
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Payment initiation failed: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    
                    if (result.status === 'success') {
                        // Payment initiated successfully
                        updatePaymentStatus('pending', 'Check your phone', 30);
                        
                        statusInstructions.innerHTML = `
                            <h4>Next Steps:</h4>
                            <ol>
                                <li>Check your phone for M-Pesa prompt</li>
                                <li>Enter your M-Pesa PIN when prompted</li>
                                <li>Wait for confirmation message</li>
                            </ol>
                            <p class="note"><strong>Note:</strong> The prompt should arrive within 30 seconds.</p>
                        `;
                        
                        // Start polling for payment status
                        const transactionId = result.data.payment.id;
                        startPaymentPolling(transactionId);
                        
                    } else {
                        throw new Error(result.message || 'Payment initiation failed');
                    }
                    
                } catch (error) {
                    console.error('Payment error:', error);
                    paymentFailed(error.message);
                }
            }
            
            function startPaymentPolling(transactionId) {
                let pollCount = 0;
                const maxPolls = 60; // Poll for 5 minutes (60 * 5 seconds)
                
                paymentInterval = setInterval(async () => {
                    pollCount++;
                    
                    // Update progress
                    const progress = Math.min(30 + (pollCount * 70 / maxPolls), 95);
                    updatePaymentStatus('polling', 'Waiting for payment confirmation...', progress);
                    
                    try {
                        // Poll payment status
                        const response = await fetch(`https://medicalexamroom.onrender.com/api/v1/payments/check-status/${transactionId}`, {
                            headers: {
                                'Authorization': `Bearer ${localStorage.getItem('accessToken') || ''}`,
                                'X-Device-Fingerprint': localStorage.getItem('deviceId') || ''
                            }
                        });
                        
                        if (response.ok) {
                            const result = await response.json();
                            
                            if (result.data.payment.status === 'completed') {
                                // Payment successful
                                clearInterval(paymentInterval);
                                paymentSuccess(result.data.payment);
                                return;
                            } else if (result.data.payment.status === 'failed') {
                                // Payment failed
                                clearInterval(paymentInterval);
                                paymentFailed('Payment failed. Please check your M-Pesa balance and try again.');
                                return;
                            }
                        }
                        
                        // Stop polling after max attempts
                        if (pollCount >= maxPolls) {
                            clearInterval(paymentInterval);
                            paymentFailed('Payment timeout. Please check if you received the M-Pesa prompt.');
                        }
                        
                    } catch (error) {
                        console.error('Polling error:', error);
                    }
                }, 5000); // Poll every 5 seconds
            }
            
            function updatePaymentStatus(stage, message, progress) {
                statusMessage.textContent = message;
                progressFill.style.width = `${progress}%`;
                progressText.textContent = `${Math.round(progress)}%`;
                
                switch(stage) {
                    case 'initiating':
                        statusIcon.textContent = '‚è≥';
                        statusTitle.textContent = 'Initiating Payment';
                        break;
                    case 'pending':
                        statusIcon.textContent = 'üì±';
                        statusTitle.textContent = 'Check Your Phone';
                        break;
                    case 'polling':
                        statusIcon.textContent = '‚è≥';
                        statusTitle.textContent = 'Processing';
                        break;
                    case 'success':
                        statusIcon.textContent = '‚úÖ';
                        statusTitle.textContent = 'Payment Successful';
                        break;
                    case 'failed':
                        statusIcon.textContent = '‚ùå';
                        statusTitle.textContent = 'Payment Failed';
                        break;
                }
            }
            
            function paymentSuccess(paymentData) {
                updatePaymentStatus('success', 'Payment completed successfully!', 100);
                
                // Update subscription in localStorage
                const expiryDate = new Date();
                switch(selectedPlan) {
                    case 'monthly':
                        expiryDate.setMonth(expiryDate.getMonth() + 1);
                        break;
                    case 'quarterly':
                        expiryDate.setMonth(expiryDate.getMonth() + 3);
                        break;
                    case 'yearly':
                        expiryDate.setFullYear(expiryDate.getFullYear() + 1);
                        break;
                }
                
                const subscription = {
                    plan: selectedPlan,
                    isActive: true,
                    expiryDate: expiryDate.toISOString(),
                    paymentId: paymentData.id,
                    mpesaReceipt: paymentData.mpesaReceipt,
                    activatedAt: new Date().toISOString()
                };
                
                localStorage.setItem('subscription', JSON.stringify(subscription));
                
                // Show success actions
                statusInstructions.innerHTML = `
                    <div class="success-message">
                        <h4>üéâ Subscription Activated!</h4>
                        <p>Your ${plans[selectedPlan].name} is now active.</p>
                        <div class="receipt-info">
                            <p><strong>Receipt No:</strong> ${paymentData.mpesaReceipt || 'N/A'}</p>
                            <p><strong>Expires:</strong> ${expiryDate.toLocaleDateString()}</p>
                        </div>
                    </div>
                `;
                
                statusActions.style.display = 'block';
                document.getElementById('continueBtn').addEventListener('click', function() {
                    window.location.href = 'subjects.html';
                });
                
                document.getElementById('viewReceiptBtn').addEventListener('click', function() {
                    alert(`Payment Receipt\n\nReceipt: ${paymentData.mpesaReceipt}\nAmount: KES ${plans[selectedPlan].price}\nPlan: ${plans[selectedPlan].name}\nDate: ${new Date().toLocaleString()}`);
                });
                
                document.getElementById('retryBtn').style.display = 'none';
            }
            
            function paymentFailed(errorMessage) {
                updatePaymentStatus('failed', errorMessage, 100);
                paymentAttempts++;
                
                statusInstructions.innerHTML = `
                    <div class="error-message">
                        <h4>Payment Failed</h4>
                        <p>${errorMessage}</p>
                        <p class="note">Attempt ${paymentAttempts} of ${maxAttempts}</p>
                    </div>
                `;
                
                statusActions.style.display = 'block';
                document.getElementById('continueBtn').style.display = 'none';
                document.getElementById('viewReceiptBtn').style.display = 'none';
                
                const retryBtn = document.getElementById('retryBtn');
                retryBtn.style.display = 'block';
                
                if (paymentAttempts >= maxAttempts) {
                    retryBtn.disabled = true;
                    retryBtn.textContent = 'Max Attempts Reached';
                    statusInstructions.innerHTML += `<p class="error">Maximum attempts reached. Please contact support.</p>`;
                } else {
                    retryBtn.addEventListener('click', function() {
                        // Reset form and try again
                        paymentStatus.style.display = 'none';
                        paymentForm.style.display = 'block';
                        submitBtn.disabled = false;
                        submitSpinner.style.display = 'none';
                    });
                }
            }
            
            // Initialize app state
            if (typeof initApp === 'function') {
                initApp();
            }
        });
    </script>
</body>
</html>