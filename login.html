<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Medical Exam Room Pro</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Common CSS -->
    <link rel="stylesheet" href="css/common.css">
    
    <!-- Page-specific CSS -->
    <link rel="stylesheet" href="css/login.css">
    
    <!-- Favicon -->
    <link rel="icon" href="images/logo.png" type="image/png">
    
    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('service-worker.js')
                    .then(function(registration) {
                        console.log('Service Worker registered with scope:', registration.scope);
                    })
                    .catch(function(error) {
                        console.log('Service Worker registration failed:', error);
                    });
            });
        }
    </script>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-container">
            <div class="logo">
                <img src="images/logo.png" alt="Medical Exam Room Pro Logo" class="logo-image">
                <h1 class="logo-text">Login</h1>
            </div>
            
            <div class="header-actions">
                <!-- Theme Toggle -->
                <button class="theme-toggle" id="themeToggle">
                    <span class="theme-icon">üåô</span>
                    <span class="theme-text">Dark Mode</span>
                </button>
                
                <!-- Back Button -->
                <button class="btn-back" id="backBtn">
                    <span class="back-icon">‚Üê</span>
                    <span class="back-text">Back</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="login-container">
            <div class="login-header">
                <h2>Welcome Back</h2>
                <p class="login-subtitle">Login to continue your medical exam preparation</p>
            </div>
            
            <form id="loginForm" class="login-form">
                <div class="form-group">
                    <label for="emailOrPhone">Email or Phone Number</label>
                    <input type="text" id="emailOrPhone" name="emailOrPhone" 
                           placeholder="Enter email or phone (2547XXXXXXXX)" required>
                    <div class="input-hint">Use email or Kenyan phone number (2547XXXXXXXX)</div>
                </div>
                
                <div class="form-group">
                    <label for="password">Password</label>
                    <div class="password-input">
                        <input type="password" id="password" name="password" 
                               placeholder="Enter your password" required>
                        <button type="button" class="toggle-password" id="togglePassword">
                            <span class="eye-icon">üëÅÔ∏è</span>
                        </button>
                    </div>
                    <div class="input-hint">Minimum 8 characters with uppercase, lowercase, and number</div>
                </div>
                
                <div class="form-options">
                    <label class="checkbox-label">
                        <input type="checkbox" id="rememberMe" name="rememberMe">
                        <span class="checkbox-custom"></span>
                        <span class="checkbox-text">Remember me on this device</span>
                    </label>
                    
                    <a href="#" class="forgot-password" id="forgotPassword">Forgot Password?</a>
                </div>
                
                <div class="form-group">
                    <button type="submit" class="btn-primary btn-submit" id="submitBtn">
                        <span class="btn-text">Login to Account</span>
                        <span class="btn-spinner" id="submitSpinner" style="display: none;">‚è≥</span>
                    </button>
                </div>
            </form>
            
            <div class="login-footer">
                <p>Don't have an account? <a href="signup.html" class="signup-link">Sign up here</a></p>
                <p>Want to try first? <a href="free-trial.html" class="trial-link">Start 3-hour free trial</a></p>
            </div>
            
            <div class="security-warning">
                <div class="warning-icon">üîí</div>
                <p><strong>Security Alert:</strong> This device is being monitored for time manipulation. Any cheating attempt will result in permanent account lock.</p>
            </div>
            
            <!-- Device Info (Hidden) -->
            <input type="hidden" id="deviceInfo" name="deviceInfo">
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer-minimal">
        <p>Having trouble logging in? Contact: felixappbuilder@gmail.com</p>
        <p>¬© 2024 Medical Exam Room Pro</p>
    </footer>

    <!-- JavaScript Files -->
    <script src="scripts/app.js"></script>
    <script src="scripts/auth.js"></script>
    <script src="scripts/validation.js"></script>
    <script src="scripts/ui.js"></script>
    <script src="scripts/utils.js"></script>
    <script src="scripts/router.js"></script>
    <script src="scripts/security.js"></script>
    
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Theme toggle
        const themeToggle = document.getElementById('themeToggle');
        const themeIcon = themeToggle.querySelector('.theme-icon');
        const themeText = themeToggle.querySelector('.theme-text');
        
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.body.classList.toggle('dark-theme', savedTheme === 'dark');
        
        if (savedTheme === 'dark') {
            themeIcon.textContent = '‚òÄÔ∏è';
            themeText.textContent = 'Light Mode';
        }
        
        themeToggle.addEventListener('click', function() {
            const isDark = document.body.classList.toggle('dark-theme');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            
            if (isDark) {
                themeIcon.textContent = '‚òÄÔ∏è';
                themeText.textContent = 'Light Mode';
            } else {
                themeIcon.textContent = 'üåô';
                themeText.textContent = 'Dark Mode';
            }
        });
        
        // Navigation - Use router if available
        const backBtn = document.getElementById('backBtn');
        backBtn.addEventListener('click', function() {
            if (window.MedicalExamRouter && typeof window.MedicalExamRouter.navigateTo === 'function') {
                window.MedicalExamRouter.navigateTo('welcome.html');
            } else {
                window.history.back() || (window.location.href = 'welcome.html');
            }
        });
        
        // Toggle password visibility
        const togglePassword = document.getElementById('togglePassword');
        const passwordInput = document.getElementById('password');
        
        togglePassword.addEventListener('click', function() {
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
            togglePassword.querySelector('.eye-icon').textContent = type === 'password' ? 'üëÅÔ∏è' : 'üëÅÔ∏è‚Äçüó®Ô∏è';
        });
        
        // Generate device fingerprint for security
        function generateDeviceFingerprint() {
            const components = [
                navigator.userAgent,
                navigator.language,
                navigator.platform,
                screen.width + 'x' + screen.height,
                new Date().getTimezoneOffset(),
                localStorage.getItem('deviceId') || 'default'
            ].join('|');
            
            // Simple hash function
            let hash = 0;
            for (let i = 0; i < components.length; i++) {
                const char = components.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            
            const deviceId = 'device_' + Math.abs(hash).toString(16);
            localStorage.setItem('deviceId', deviceId);
            localStorage.setItem('deviceFingerprint', deviceId);
            return deviceId;
        }
        
        // Set device info
        const deviceInfo = generateDeviceFingerprint();
        document.getElementById('deviceInfo').value = JSON.stringify({
            deviceId: deviceInfo,
            platform: navigator.platform,
            browser: navigator.userAgent,
            screen: screen.width + 'x' + screen.height,
            timezone: new Date().getTimezoneOffset(),
            timestamp: Date.now()
        });
        
        // Mock backend API for login
        const MockAuthAPI = {
            // Authenticate user
            login: function(identifier, password) {
                return new Promise((resolve, reject) => {
                    setTimeout(() => {
                        // Check mock users (from signup)
                        const mockUsers = JSON.parse(localStorage.getItem('mock_users') || '[]');
                        const offlineUsers = JSON.parse(localStorage.getItem('offline_users') || '[]');
                        
                        // Combine all users
                        const allUsers = [...mockUsers, ...offlineUsers];
                        
                        // Find user by email or phone
                        const user = allUsers.find(u => 
                            u.email === identifier.toLowerCase() || 
                            u.phone === identifier.replace(/\D/g, '')
                        );
                        
                        if (!user) {
                            const error = new Error('User not found');
                            error.code = 'USER_NOT_FOUND';
                            reject(error);
                            return;
                        }
                        
                        // Check password
                        if (user.password !== password) {
                            const error = new Error('Invalid password');
                            error.code = 'INVALID_PASSWORD';
                            reject(error);
                            return;
                        }
                        
                        // Check if account is locked
                        const isLocked = localStorage.getItem('accountLocked') === 'true';
                        if (isLocked) {
                            const error = new Error('Account locked');
                            error.code = 'ACCOUNT_LOCKED';
                            reject(error);
                            return;
                        }
                        
                        // Generate mock tokens
                        const mockToken = this.generateMockToken(user.id);
                        
                        const response = {
                            status: 'success',
                            message: 'Login successful',
                            data: {
                                user: {
                                    id: user.id,
                                    firstName: user.firstName,
                                    lastName: user.lastName,
                                    email: user.email,
                                    phone: user.phone,
                                    institution: user.institution || '',
                                    yearOfStudy: user.yearOfStudy || '',
                                    createdAt: user.createdAt
                                },
                                tokens: {
                                    accessToken: mockToken.accessToken,
                                    refreshToken: mockToken.refreshToken,
                                    expiresIn: 604800 // 7 days in seconds
                                },
                                deviceFingerprint: deviceInfo,
                                isNewDevice: !user.devices || !user.devices.includes(deviceInfo)
                            }
                        };
                        
                        resolve(response);
                    }, 500); // Faster response for better UX
                });
            },
            
            // Generate mock JWT token
            generateMockToken: function(userId) {
                const header = btoa(JSON.stringify({ alg: 'HS256', typ: 'JWT' }));
                const payload = btoa(JSON.stringify({
                    userId: userId,
                    iat: Math.floor(Date.now() / 1000),
                    exp: Math.floor(Date.now() / 1000) + (7 * 24 * 60 * 60) // 7 days
                }));
                const signature = btoa('mock_signature_' + Date.now());
                
                return {
                    accessToken: `${header}.${payload}.${signature}`,
                    refreshToken: `refresh_${header}.${payload}.${signature}`
                };
            }
        };
        
        // Check if user is already logged in - Use router for redirection
        function checkExistingSession() {
            const accessToken = localStorage.getItem('accessToken');
            const userData = localStorage.getItem('userData');
            
            if (accessToken && userData) {
                try {
                    const user = JSON.parse(userData);
                    const tokenExpiry = localStorage.getItem('tokenExpiry');
                    
                    // Check if token is valid or if it's an offline token
                    const isOffline = localStorage.getItem('isOffline') === 'true';
                    const isValidToken = tokenExpiry ? new Date(tokenExpiry) > new Date() : isOffline;
                    
                    if (isValidToken) {
                        console.log('User already logged in, redirecting to subjects...');
                        
                        // Use router for navigation
                        setTimeout(() => {
                            if (window.MedicalExamRouter && typeof window.MedicalExamRouter.navigateTo === 'function') {
                                window.MedicalExamRouter.navigateTo('subjects.html', true); // Force navigation
                            } else {
                                // Fallback if router not available
                                window.location.href = 'subjects.html';
                            }
                        }, 100);
                    }
                } catch (e) {
                    // Invalid data, clear it
                    localStorage.removeItem('accessToken');
                    localStorage.removeItem('userData');
                    localStorage.removeItem('tokenExpiry');
                    localStorage.removeItem('isOffline');
                }
            }
        }
        
        // Check for existing session on page load
        checkExistingSession();
        
        // Get form elements
        const loginForm = document.getElementById('loginForm');
        const submitBtn = document.getElementById('submitBtn');
        const submitSpinner = document.getElementById('submitSpinner');
        const forgotPassword = document.getElementById('forgotPassword');
        
        // Add form submission handler - DON'T stop propagation, let router handle navigation
        loginForm.addEventListener('submit', async function(e) {
            // Only prevent default, DON'T stop propagation
            e.preventDefault();
            
            console.log('=== LOGIN FORM SUBMISSION ===');
            
            // Get form values
            const emailOrPhone = document.getElementById('emailOrPhone').value.trim();
            const password = document.getElementById('password').value;
            const rememberMe = document.getElementById('rememberMe').checked;
            
            // Basic validation
            if (!emailOrPhone) {
                showError('Please enter your email or phone number');
                return;
            }
            
            if (!password) {
                showError('Please enter your password');
                return;
            }
            
            // Show loading state
            submitBtn.disabled = true;
            submitSpinner.style.display = 'inline-block';
            submitBtn.querySelector('.btn-text').textContent = 'Logging in...';
            
            try {
                // Use mock authentication
                const result = await MockAuthAPI.login(emailOrPhone, password);
                
                // Store authentication data (router will check this)
                localStorage.setItem('accessToken', result.data.tokens.accessToken);
                localStorage.setItem('refreshToken', result.data.tokens.refreshToken);
                localStorage.setItem('userData', JSON.stringify(result.data.user));
                localStorage.setItem('deviceFingerprint', result.data.deviceFingerprint);
                
                // Set token expiry (7 days from now)
                const expiryDate = new Date();
                expiryDate.setDate(expiryDate.getDate() + 7);
                localStorage.setItem('tokenExpiry', expiryDate.toISOString());
                
                // Store remember me preference
                if (rememberMe) {
                    localStorage.setItem('rememberMe', 'true');
                } else {
                    localStorage.removeItem('rememberMe');
                }
                
                // Clear offline flag if it exists
                localStorage.removeItem('isOffline');
                
                // Log activity for router
                if (window.MedicalExamRouter && typeof window.MedicalExamRouter.logActivity === 'function') {
                    window.MedicalExamRouter.logActivity('user_logged_in', {
                        email: result.data.user.email,
                        deviceId: deviceInfo
                    });
                }
                
                console.log('Login successful!');
                
                // Show success message
                showSuccess('‚úÖ Login successful! Redirecting...');
                
                // IMPORTANT: Let router handle the navigation
                // Wait a moment for user to read success message
                setTimeout(() => {
                    // Use router for navigation - this ensures proper validation
                    if (window.MedicalExamRouter && typeof window.MedicalExamRouter.navigateTo === 'function') {
                        console.log('Using router for navigation to subjects.html');
                        window.MedicalExamRouter.navigateTo('subjects.html', true); // Force navigation
                    } else {
                        console.log('Router not available, using direct navigation');
                        window.location.href = 'subjects.html';
                    }
                }, 1000); // Give user time to see success message
                
            } catch (error) {
                console.error('Login error:', error);
                
                // Handle different error types
                if (error.code === 'USER_NOT_FOUND') {
                    showError('‚ùå User not found. Please check your email/phone or sign up.');
                } else if (error.code === 'INVALID_PASSWORD') {
                    showError('‚ùå Invalid password. Please try again.');
                } else if (error.code === 'ACCOUNT_LOCKED') {
                    showError('üîí Account locked. Please contact support: felixappbuilder@gmail.com');
                    setTimeout(() => {
                        if (window.MedicalExamRouter && typeof window.MedicalExamRouter.navigateTo === 'function') {
                            window.MedicalExamRouter.navigateTo('locked.html', true);
                        } else {
                            window.location.href = 'locked.html';
                        }
                    }, 2000);
                } else {
                    showError('‚ùå Login failed: ' + (error.message || 'Unknown error'));
                }
                
                // Track failed login attempts (for security)
                trackFailedAttempt(emailOrPhone);
                
            } finally {
                // Reset loading state
                submitBtn.disabled = false;
                submitSpinner.style.display = 'none';
                submitBtn.querySelector('.btn-text').textContent = 'Login to Account';
            }
        });
        
        // Track failed login attempts
        function trackFailedAttempt(identifier) {
            const attempts = JSON.parse(localStorage.getItem('failedLoginAttempts') || '{}');
            const now = Date.now();
            
            if (!attempts[identifier]) {
                attempts[identifier] = [];
            }
            
            // Keep only attempts from last 30 minutes
            attempts[identifier] = attempts[identifier].filter(time => 
                now - time < 30 * 60 * 1000
            );
            
            // Add current attempt
            attempts[identifier].push(now);
            
            // Save attempts
            localStorage.setItem('failedLoginAttempts', JSON.stringify(attempts));
            
            // Check if too many attempts (5 in 30 minutes)
            if (attempts[identifier].length >= 5) {
                showError('‚ö†Ô∏è Too many failed attempts. Please try again in 30 minutes.');
            }
        }
        
        // Forgot password handler
        forgotPassword.addEventListener('click', function(e) {
            e.preventDefault();
            
            const emailOrPhone = prompt('Enter your email or phone number to reset password:');
            if (emailOrPhone) {
                showSuccess('üìß Password reset instructions have been sent to your email (mock).');
                console.log('Password reset requested for:', emailOrPhone);
            }
        });
        
        // Helper function to show error messages
        function showError(message) {
            // Remove any existing messages
            const existingError = document.getElementById('formError');
            if (existingError) existingError.remove();
            
            const existingSuccess = document.getElementById('formSuccess');
            if (existingSuccess) existingSuccess.remove();
            
            // Create error display
            const errorDiv = document.createElement('div');
            errorDiv.id = 'formError';
            errorDiv.className = 'form-error';
            errorDiv.innerHTML = `
                <div class="error-content">
                    <span class="error-icon">‚ùå</span>
                    <span class="error-text">${message}</span>
                </div>
            `;
            
            // Insert after form header or at top of form
            const formHeader = document.querySelector('.login-header');
            if (formHeader) {
                formHeader.parentNode.insertBefore(errorDiv, formHeader.nextSibling);
            } else {
                loginForm.insertBefore(errorDiv, loginForm.firstChild);
            }
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.remove();
                }
            }, 5000);
        }
        
        // Helper function to show success messages
        function showSuccess(message) {
            // Remove any existing messages
            const existingSuccess = document.getElementById('formSuccess');
            if (existingSuccess) existingSuccess.remove();
            
            const existingError = document.getElementById('formError');
            if (existingError) existingError.remove();
            
            // Create success display
            const successDiv = document.createElement('div');
            successDiv.id = 'formSuccess';
            successDiv.className = 'form-success';
            successDiv.innerHTML = `
                <div class="success-content">
                    <span class="success-icon">‚úÖ</span>
                    <span class="success-text">${message}</span>
                </div>
            `;
            
            // Insert after form header or at top of form
            const formHeader = document.querySelector('.login-header');
            if (formHeader) {
                formHeader.parentNode.insertBefore(successDiv, formHeader.nextSibling);
            } else {
                loginForm.insertBefore(successDiv, loginForm.firstChild);
            }
        }
        
        // Initialize app state
        if (typeof initApp === 'function') {
            initApp();
        }
        
        // Wait for router to initialize, then check if we need to redirect
        setTimeout(checkExistingSession, 100);
        
        // Add some debug info to console
        console.log('Login page loaded');
        console.log('Router available:', !!window.MedicalExamRouter);
        if (window.MedicalExamRouter) {
            console.log('Router methods:', Object.keys(window.MedicalExamRouter));
        }
    });
</script>
</body>
</html>