<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exam Settings - Medical Exam Room Pro</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/exam-settings.css">
    <link rel="icon" href="images/logo.png" type="image/png">
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('service-worker.js');
            });
        }
    </script>
</head>
<body>

<div class="container">
    <header>
        <div class="logo">
            <img src="images/logo.png" alt="Logo">
            Exam Configuration
        </div>
        <button class="btn-outline" id="themeToggle">
            <span class="theme-icon">üåô</span>
            <span class="theme-text">Dark Mode</span>
        </button>
    </header>

    <div class="top-nav">
        <a href="#" id="backBtn" style="text-decoration: none; color: var(--accent-color);">‚Üê Back to Subjects</a>
        <div class="advanced-menu">
            ‚ãÆ
            <div class="dropdown-content">
                <strong>Advanced Settings</strong>
                <hr>
                <div style="font-size: 14px; line-height: 1.6;">
                    <!-- Display Settings -->
                    <div style="margin-bottom: 10px;">
                        <strong>Display:</strong>
                        <label class="checkbox-label">
                            Start in fullscreen mode: <input type="checkbox" id="fullscreen" checked>
                        </label>
                        <label class="checkbox-label">
                            Distraction-free mode: <input type="checkbox" id="distractionFree" checked>
                        </label>
                        <label class="checkbox-label">
                            Show progress bar: <input type="checkbox" id="showProgress" checked>
                        </label>
                    </div>
                    
                    <!-- Security Features -->
                    <div style="margin-bottom: 10px;">
                        <strong>Security:</strong>
                        <label class="checkbox-label">
                            Prevent copy-paste: <input type="checkbox" id="preventCopy" checked>
                        </label>
                        <label class="checkbox-label">
                            Auto-save (30s): <input type="checkbox" id="autoSave" checked>
                        </label>
                        <label class="checkbox-label">
                            Detect tab switching: <input type="checkbox" id="pauseDetection" checked>
                        </label>
                    </div>
                    
                    <!-- Review Options -->
                    <div style="margin-bottom: 10px;">
                        <strong>Review:</strong>
                        <label class="checkbox-label">
                            Allow flagging: <input type="checkbox" id="flagQuestions" checked>
                        </label>
                        <label class="checkbox-label">
                            Show explanations: <input type="checkbox" id="showExplanations" checked>
                        </label>
                    </div>
                    
                    <!-- Time Warnings -->
                    <div>
                        <strong>Warnings:</strong>
                        <label class="checkbox-label">
                            Color warnings: <input type="checkbox" id="colorWarnings" checked>
                        </label>
                        <label class="checkbox-label">
                            Flashing red (last 5s): <input type="checkbox" id="flashWarnings" checked>
                        </label>
                    </div>
                    
                    <!-- Advanced Options -->
                    <div style="margin-top: 10px;">
                        <strong>More Options:</strong>
                        <div style="font-size: 12px;">
                            Question Order:
                            <select id="questionOrder" style="width: 100%; margin: 5px 0; font-size: 12px; padding: 4px;">
                                <option value="random">Random</option>
                                <option value="difficulty">By Difficulty</option>
                                <option value="topic">By Topic</option>
                            </select>
                            
                            Break Interval:
                            <select id="breakInterval" style="width: 100%; margin: 5px 0; font-size: 12px; padding: 4px;">
                                <option value="0">No breaks</option>
                                <option value="25">Every 25 questions</option>
                                <option value="50">Every 50 questions</option>
                            </select>
                            
                            Passing Score: <input type="number" id="passingScore" value="70" min="0" max="100" style="width: 60px; padding: 4px; font-size: 12px;">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <h2>Configure your exam</h2>

    <div class="info-box" id="examSummary">
        <!-- Loaded by JavaScript -->
    </div>

    <div class="form-group">
        <label>Exam Mode</label>
        <select id="examMode">
            <option value="timed">Timed Exam</option>
            <option value="practice">Practice Mode</option>
            <option value="review">Review Mode</option>
        </select>
    </div>

    <div class="form-group">
        <label>Number of Questions</label>
        <div style="display: flex; gap: 10px; align-items: center;">
            <select id="questionCountSelect" style="flex: 1;">
                <option value="10">Quick Exam (10)</option>
                <option value="25" selected>Standard (25)</option>
                <option value="50">Full Exam (50)</option>
                <option value="custom">Custom</option>
            </select>
            <input type="number" id="customCount" min="1" max="200" placeholder="Custom" 
                   style="display: none; width: 100px; padding: 12px;">
        </div>
        <div id="countHint" style="font-size: 0.85rem; margin-top: 5px; color: #666;">
            Available: 0 questions
        </div>
    </div>

    <div class="form-group">
        <label>Difficulty Level</label>
        <div class="difficulty-slider">
            <input type="range" id="difficultyLevel" min="0" max="4" value="2" step="1">
            <div class="slider-value" id="difficultyValue">Mixed Difficulty</div>
        </div>
        <div id="difficultyDesc" style="font-size: 0.85rem; margin-top: 5px; color: #666;">
            Mix of easy, medium, and hard questions
        </div>
    </div>

    <div class="form-group">
        <label>Timer Settings</label>
        <select id="timerMode">
            <option value="adaptive">Adaptive (21-54s based on difficulty)</option>
            <option value="strict">Strict (30s fixed)</option>
            <option value="relaxed">Relaxed (60s fixed)</option>
            <option value="untimed">No Timer (Practice only)</option>
        </select>
    </div>

    <div class="form-group">
        <label>Question Distribution</label>
        <select id="questionDistribution">
            <option value="balanced">Balanced (Equal from each topic)</option>
            <option value="weighted">Weighted (More from weak areas)</option>
            <option value="random">Random (Completely random)</option>
        </select>
    </div>

    <div class="form-group">
        <div style="display: flex; gap: 10px; align-items: center;">
            <input type="text" id="presetName" placeholder="Preset name" 
                   style="flex: 1; padding: 12px;">
            <button class="btn-outline" id="savePresetBtn" style="white-space: nowrap;">
                Save Preset üíæ
            </button>
        </div>
        <div id="presetList" style="margin-top: 10px; max-height: 100px; overflow-y: auto;">
            <!-- Presets will be loaded here -->
        </div>
    </div>

    <div id="estimatedTime" class="estimated-time">
        Estimated exam time: Calculating...
    </div>

    <div class="button-group">
        <button class="btn-secondary" id="resetBtn">Reset to Default</button>
        <button class="btn-outline" id="cancelBtn" style="color: red;">Cancel</button>
        <button class="btn-primary" id="startExamBtn">Start Exam ‚Äî></button>
    </div>

    <p class="footer-note">All settings configured here will be applied to your exam. You can save configuration as Preset for future use.</p>
</div>

<!-- JavaScript Files -->
<script src="scripts/app.js"></script>
<script src="scripts/router.js"></script>
<script src="scripts/ui.js"></script>
<script src="scripts/utils.js"></script>
<script src="scripts/auth.js"></script>
<script src="scripts/validation.js"></script>
<script src="scripts/security.js"></script>
<script src="scripts/subscription.js"></script>
<script src="scripts/payment.js"></script>
<script src="scripts/questions.js"></script>
<script src="scripts/exam-engine.js"></script>
<script src="scripts/timer.js"></script>
<script src="scripts/db.js"></script>
<script src="scripts/sync.js"></script>
<script src="scripts/analytics.js"></script>
<script src="scripts/offline.js"></script>

<script>
    // Minimal initialization script that delegates to imported modules
    document.addEventListener('DOMContentLoaded', function() {
        
        // Initialize App State (app.js)
        if (typeof App !== 'undefined') {
            App.init();
        }
        
        // Check authentication (auth.js)
        if (typeof Auth !== 'undefined') {
            if (!Auth.isAuthenticated()) {
                // Redirect to login if not authenticated
                if (typeof Router !== 'undefined') {
                    Router.navigateTo('login.html');
                } else {
                    window.location.href = 'login.html';
                }
                return;
            }
        }
        
        // Setup UI components (ui.js)
        if (typeof UI !== 'undefined') {
            // Theme toggle
            UI.setupThemeToggle('themeToggle');
            
            // Setup form controls
            UI.setupFormControl('examMode', 'change', updateConfig);
            UI.setupFormControl('questionCountSelect', 'change', handleQuestionCountChange);
            UI.setupFormControl('difficultyLevel', 'input', updateDifficulty);
            UI.setupFormControl('timerMode', 'change', updateConfig);
            UI.setupFormControl('questionDistribution', 'change', updateConfig);
            
            // Setup advanced menu controls
            setupAdvancedControls();
            
            // Setup button handlers
            UI.setupButton('resetBtn', resetToDefaults);
            UI.setupButton('savePresetBtn', savePreset);
            UI.setupButton('startExamBtn', startExam);
        }
        
        // Setup navigation (router.js)
        if (typeof Router !== 'undefined') {
            Router.setupNavigation('backBtn', 'subjects.html');
            Router.setupNavigation('cancelBtn', null, function() {
                return confirm('Are you sure you want to cancel? Your settings will not be saved.');
            });
        } else {
            // Fallback navigation
            document.getElementById('backBtn').addEventListener('click', function() {
                window.history.back() || (window.location.href = 'subjects.html');
            });
            
            document.getElementById('cancelBtn').addEventListener('click', function() {
                if (confirm('Are you sure you want to cancel? Your settings will not be saved.')) {
                    window.history.back();
                }
            });
        }
        
        // Load exam configuration (exam-engine.js)
        if (typeof ExamEngine !== 'undefined') {
            ExamEngine.loadConfiguration();
            updateExamSummary();
            updateEstimatedTime();
            loadPresets();
        } else {
            // Fallback to localStorage
            loadFromLocalStorage();
        }
        
        // Setup security (security.js)
        if (typeof Security !== 'undefined') {
            Security.initializePageProtection();
        }
        
        // Check offline status (offline.js)
        if (typeof Offline !== 'undefined') {
            Offline.checkStatus();
        }
        
        // Initialize database (db.js)
        if (typeof DB !== 'undefined') {
            DB.init().then(() => {
                console.log('Database initialized for settings');
            });
        }
    });
    
    // Configuration update handlers
    function updateConfig() {
        const config = collectConfig();
        
        if (typeof ExamEngine !== 'undefined') {
            ExamEngine.updateConfiguration(config);
        } else {
            // Fallback to localStorage
            localStorage.setItem('examConfiguration', JSON.stringify(config));
        }
        
        updateEstimatedTime();
        
        if (typeof UI !== 'undefined') {
            UI.showToast('Settings updated', 'info');
        }
    }
    
    function handleQuestionCountChange() {
        const select = document.getElementById('questionCountSelect');
        const customInput = document.getElementById('customCount');
        
        if (select.value === 'custom') {
            customInput.style.display = 'block';
            select.style.flex = '2';
            customInput.focus();
        } else {
            customInput.style.display = 'none';
            select.style.flex = '1';
        }
        
        updateConfig();
    }
    
    function updateDifficulty() {
        const slider = document.getElementById('difficultyLevel');
        const value = parseInt(slider.value);
        
        const difficultyLabels = ['Easy Only', 'Mostly Easy', 'Mixed Difficulty', 'Mostly Hard', 'Expert Only'];
        const difficultyDescriptions = [
            'All easy questions (21 seconds each)',
            'Mostly easy questions with some medium',
            'Mix of easy, medium, and hard questions',
            'Mostly hard questions with some expert',
            'All expert questions (54 seconds each)'
        ];
        
        document.getElementById('difficultyValue').textContent = difficultyLabels[value];
        document.getElementById('difficultyDesc').textContent = difficultyDescriptions[value];
        
        updateConfig();
    }
    
    function updateExamSummary() {
        const selectedSubjects = JSON.parse(localStorage.getItem('selectedSubjects') || '[]');
        const selectedTopics = JSON.parse(localStorage.getItem('selectedTopics') || '[]');
        
        const subjectNames = {
            'anatomy': 'Anatomy', 'physiology': 'Physiology', 'biochemistry': 'Biochemistry',
            'histology': 'Histology', 'embryology': 'Embryology', 'pathology': 'Pathology',
            'pharmacology': 'Pharmacology', 'microbiology': 'Microbiology'
        };
        
        const subjectList = selectedSubjects.map(sub => subjectNames[sub] || sub).join(', ');
        const displayedTopics = selectedTopics.slice(0, 3);
        const extraCount = Math.max(0, selectedTopics.length - 3);
        const topicsDisplay = displayedTopics.length > 0 
            ? displayedTopics.join(', ') + (extraCount > 0 ? ` +${extraCount} more` : '')
            : 'No topics selected';
        
        // Calculate available questions using questions.js if available
        let availableQuestions = 0;
        if (typeof Questions !== 'undefined') {
            availableQuestions = Questions.countAvailable(selectedSubjects, selectedTopics);
        } else {
            availableQuestions = selectedTopics.length * 50; // Fallback estimate
        }
        
        document.getElementById('examSummary').innerHTML = `
            <strong>Subject:</strong> ${subjectList || 'None selected'} <br>
            <strong>Topics:</strong> ${topicsDisplay} <br>
            <strong>Available Questions:</strong> ${availableQuestions.toLocaleString()}
        `;
        
        document.getElementById('countHint').textContent = `Available: ${availableQuestions.toLocaleString()} questions`;
        
        // Update custom count max
        const customCount = document.getElementById('customCount');
        customCount.max = availableQuestions;
        if (parseInt(customCount.value) > availableQuestions) {
            customCount.value = availableQuestions;
        }
    }
    
    function updateEstimatedTime() {
        const config = collectConfig();
        let timeText = 'Calculating...';
        
        if (typeof Utils !== 'undefined' && typeof ExamEngine !== 'undefined') {
            timeText = ExamEngine.calculateEstimatedTime(config);
        } else {
            // Fallback calculation
            const questionCount = getQuestionCount();
            const difficulty = parseInt(document.getElementById('difficultyLevel').value);
            const timerMode = document.getElementById('timerMode').value;
            
            let avgTimePerQuestion;
            switch(timerMode) {
                case 'adaptive':
                    const times = [21, 27, 36, 45, 54];
                    avgTimePerQuestion = times[difficulty];
                    break;
                case 'strict':
                    avgTimePerQuestion = 30;
                    break;
                case 'relaxed':
                    avgTimePerQuestion = 60;
                    break;
                case 'untimed':
                    avgTimePerQuestion = 0;
                    break;
                default:
                    avgTimePerQuestion = 30;
            }
            
            const totalSeconds = questionCount * avgTimePerQuestion;
            if (avgTimePerQuestion === 0) {
                timeText = 'No time limit (Practice mode)';
            } else {
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = totalSeconds % 60;
                timeText = `Estimated exam time: ${minutes}m ${seconds}s`;
            }
        }
        
        document.getElementById('estimatedTime').textContent = timeText;
    }
    
    function collectConfig() {
        return {
            examMode: document.getElementById('examMode').value,
            questionCount: getQuestionCount(),
            difficulty: document.getElementById('difficultyLevel').value,
            timerMode: document.getElementById('timerMode').value,
            distribution: document.getElementById('questionDistribution').value,
            questionOrder: document.getElementById('questionOrder').value,
            passingScore: parseInt(document.getElementById('passingScore').value) || 70,
            breakInterval: document.getElementById('breakInterval').value,
            fullscreen: document.getElementById('fullscreen').checked,
            distractionFree: document.getElementById('distractionFree').checked,
            showProgress: document.getElementById('showProgress').checked,
            preventCopy: document.getElementById('preventCopy').checked,
            autoSave: document.getElementById('autoSave').checked,
            pauseDetection: document.getElementById('pauseDetection').checked,
            flagQuestions: document.getElementById('flagQuestions').checked,
            showExplanations: document.getElementById('showExplanations').checked,
            colorWarnings: document.getElementById('colorWarnings').checked,
            flashWarnings: document.getElementById('flashWarnings').checked,
            subjects: JSON.parse(localStorage.getItem('selectedSubjects') || '[]'),
            topics: JSON.parse(localStorage.getItem('selectedTopics') || '[]'),
            configTimestamp: Date.now()
        };
    }
    
    function getQuestionCount() {
        const select = document.getElementById('questionCountSelect');
        if (select.value === 'custom') {
            return document.getElementById('customCount').value || '25';
        }
        return select.value;
    }
    
    function setupAdvancedControls() {
        const advancedIds = [
            'fullscreen', 'distractionFree', 'showProgress', 'preventCopy',
            'autoSave', 'pauseDetection', 'flagQuestions', 'showExplanations',
            'colorWarnings', 'flashWarnings', 'questionOrder', 'breakInterval', 'passingScore'
        ];
        
        advancedIds.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener('change', updateConfig);
            }
        });
    }
    
    function resetToDefaults() {
        if (confirm('Reset all settings to defaults?')) {
            if (typeof ExamEngine !== 'undefined') {
                ExamEngine.resetToDefaults();
                ExamEngine.loadConfiguration();
            } else {
                // Fallback reset
                document.getElementById('examMode').value = 'timed';
                document.getElementById('questionCountSelect').value = '25';
                document.getElementById('customCount').style.display = 'none';
                document.getElementById('questionCountSelect').style.flex = '1';
                document.getElementById('difficultyLevel').value = 2;
                updateDifficulty();
                document.getElementById('timerMode').value = 'adaptive';
                document.getElementById('questionDistribution').value = 'balanced';
                
                // Advanced defaults
                document.getElementById('questionOrder').value = 'random';
                document.getElementById('passingScore').value = 70;
                document.getElementById('breakInterval').value = '0';
                
                const checkboxes = [
                    'fullscreen', 'distractionFree', 'showProgress', 'preventCopy',
                    'autoSave', 'pauseDetection', 'flagQuestions', 'showExplanations',
                    'colorWarnings', 'flashWarnings'
                ];
                
                checkboxes.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) element.checked = true;
                });
                
                localStorage.removeItem('examConfiguration');
            }
            
            updateEstimatedTime();
            
            if (typeof UI !== 'undefined') {
                UI.showToast('Settings reset to defaults', 'success');
            } else {
                alert('Settings reset to defaults!');
            }
        }
    }
    
    function savePreset() {
        const presetName = document.getElementById('presetName').value.trim();
        if (!presetName) {
            if (typeof UI !== 'undefined') {
                UI.showToast('Please enter a preset name', 'error');
            } else {
                alert('Please enter a name for your preset');
            }
            return;
        }
        
        const preset = {
            name: presetName,
            ...collectConfig(),
            timestamp: Date.now()
        };
        
        if (typeof ExamEngine !== 'undefined') {
            ExamEngine.savePreset(preset);
        } else {
            // Fallback to localStorage
            const presets = JSON.parse(localStorage.getItem('examPresets') || '[]');
            presets.push(preset);
            localStorage.setItem('examPresets', JSON.stringify(presets));
        }
        
        document.getElementById('presetName').value = '';
        loadPresets();
        
        if (typeof UI !== 'undefined') {
            UI.showToast(`Preset "${presetName}" saved`, 'success');
        } else {
            alert(`Preset "${presetName}" saved successfully!`);
        }
    }
    
    function loadPresets() {
        let presets = [];
        
        if (typeof ExamEngine !== 'undefined') {
            presets = ExamEngine.getPresets();
        } else {
            // Fallback to localStorage
            presets = JSON.parse(localStorage.getItem('examPresets') || '[]');
        }
        
        const presetList = document.getElementById('presetList');
        
        if (presets.length === 0) {
            presetList.innerHTML = '<div style="font-size: 0.85rem; color: #666; padding: 10px; text-align: center;">No saved presets yet</div>';
            return;
        }
        
        presetList.innerHTML = presets.map((preset, index) => `
            <div class="preset-item">
                <div class="preset-info">
                    <div class="preset-name">${preset.name}</div>
                    <div class="preset-details">
                        ${preset.questionCount} questions ‚Ä¢ ${preset.difficulty === '0' ? 'Easy' : preset.difficulty === '4' ? 'Expert' : 'Mixed'}
                    </div>
                </div>
                <div class="preset-actions">
                    <button class="btn-preset-load" data-index="${index}">Load</button>
                    <button class="btn-preset-delete" data-index="${index}">üóëÔ∏è</button>
                </div>
            </div>
        `).join('');
        
        // Add event listeners to preset buttons
        document.querySelectorAll('.btn-preset-load').forEach(btn => {
            btn.addEventListener('click', function() {
                const index = parseInt(this.dataset.index);
                loadPreset(presets[index]);
            });
        });
        
        document.querySelectorAll('.btn-preset-delete').forEach(btn => {
            btn.addEventListener('click', function() {
                const index = parseInt(this.dataset.index);
                if (confirm('Delete this preset?')) {
                    if (typeof ExamEngine !== 'undefined') {
                        ExamEngine.deletePreset(index);
                    } else {
                        presets.splice(index, 1);
                        localStorage.setItem('examPresets', JSON.stringify(presets));
                    }
                    loadPresets();
                }
            });
        });
    }
    
    function loadPreset(preset) {
        // Load basic settings
        document.getElementById('examMode').value = preset.examMode || 'timed';
        
        const count = preset.questionCount || 25;
        if ([10, 25, 50].includes(parseInt(count))) {
            document.getElementById('questionCountSelect').value = count;
            document.getElementById('customCount').style.display = 'none';
            document.getElementById('questionCountSelect').style.flex = '1';
        } else {
            document.getElementById('questionCountSelect').value = 'custom';
            document.getElementById('customCount').value = count;
            document.getElementById('customCount').style.display = 'block';
            document.getElementById('questionCountSelect').style.flex = '2';
        }
        
        document.getElementById('difficultyLevel').value = preset.difficulty || 2;
        updateDifficulty();
        
        document.getElementById('timerMode').value = preset.timerMode || 'adaptive';
        document.getElementById('questionDistribution').value = preset.distribution || 'balanced';
        
        // Load advanced settings
        document.getElementById('questionOrder').value = preset.questionOrder || 'random';
        document.getElementById('passingScore').value = preset.passingScore || 70;
        document.getElementById('breakInterval').value = preset.breakInterval || '0';
        
        const advancedIds = [
            'fullscreen', 'distractionFree', 'showProgress', 'preventCopy',
            'autoSave', 'pauseDetection', 'flagQuestions', 'showExplanations',
            'colorWarnings', 'flashWarnings'
        ];
        
        advancedIds.forEach(id => {
            const element = document.getElementById(id);
            if (element && preset[id] !== undefined) {
                element.checked = preset[id];
            }
        });
        
        updateConfig();
        
        if (typeof UI !== 'undefined') {
            UI.showToast(`Preset "${preset.name}" loaded`, 'success');
        } else {
            alert(`Preset "${preset.name}" loaded successfully!`);
        }
    }
    
    function startExam() {
        // Check subscription (subscription.js)
        if (typeof Subscription !== 'undefined') {
            if (!Subscription.checkActive()) {
                if (typeof Router !== 'undefined') {
                    Router.navigateTo('subscription.html');
                } else {
                    window.location.href = 'subscription.html';
                }
                return;
            }
        } else {
            // Fallback subscription check
            const subscription = JSON.parse(localStorage.getItem('subscription') || '{}');
            if (!subscription.isActive || !subscription.expiryDate || new Date(subscription.expiryDate) <= new Date()) {
                alert('Your subscription has expired. Please subscribe to start exams.');
                window.location.href = 'subscription.html';
                return;
            }
        }
        
        // Validate topics selection
        const selectedTopics = JSON.parse(localStorage.getItem('selectedTopics') || '[]');
        if (selectedTopics.length === 0) {
            if (typeof UI !== 'undefined') {
                UI.showToast('Please select at least one topic', 'error');
            } else {
                alert('Please select at least one topic before starting the exam.');
            }
            return;
        }
        
        // Save configuration
        const config = collectConfig();
        
        if (typeof ExamEngine !== 'undefined') {
            ExamEngine.saveConfiguration(config);
            
            // Generate exam using exam engine
            const exam = ExamEngine.generateExam(config);
            
            // Save to database if available
            if (typeof DB !== 'undefined') {
                DB.saveExam(exam);
            }
        } else {
            // Fallback to localStorage
            localStorage.setItem('examConfiguration', JSON.stringify(config));
            
            // Also save advanced settings separately
            const advancedSettings = {};
            const advancedIds = [
                'fullscreen', 'distractionFree', 'showProgress', 'preventCopy',
                'autoSave', 'pauseDetection', 'flagQuestions', 'showExplanations',
                'colorWarnings', 'flashWarnings', 'questionOrder', 'passingScore', 'breakInterval'
            ];
            
            advancedIds.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    advancedSettings[id] = element.type === 'checkbox' ? element.checked : element.value;
                }
            });
            localStorage.setItem('advancedSettings', JSON.stringify(advancedSettings));
        }
        
        // Navigate to exam room
        if (typeof Router !== 'undefined') {
            Router.navigateTo('exam-room.html');
        } else {
            window.location.href = 'exam-room.html';
        }
    }
    
    function loadFromLocalStorage() {
        const examConfig = JSON.parse(localStorage.getItem('examConfig') || '{}');
        
        if (examConfig.examMode) {
            document.getElementById('examMode').value = examConfig.examMode;
        }
        
        if (examConfig.questionCount) {
            const count = parseInt(examConfig.questionCount);
            if ([10, 25, 50].includes(count)) {
                document.getElementById('questionCountSelect').value = count;
            } else {
                document.getElementById('questionCountSelect').value = 'custom';
                document.getElementById('customCount').value = count;
                document.getElementById('customCount').style.display = 'block';
                document.getElementById('questionCountSelect').style.flex = '2';
            }
        }
        
        if (examConfig.difficulty) {
            const difficultyMap = { 'easy': 0, 'medium': 1, 'hard': 2, 'expert': 3, 'mixed': 2 };
            const value = difficultyMap[examConfig.difficulty] || 2;
            document.getElementById('difficultyLevel').value = value;
            updateDifficulty();
        }
        
        if (examConfig.timerMode) {
            document.getElementById('timerMode').value = examConfig.timerMode;
        }
        
        if (examConfig.distribution) {
            document.getElementById('questionDistribution').value = examConfig.distribution;
        }
        
        // Load advanced settings
        const advancedSettings = JSON.parse(localStorage.getItem('advancedSettings') || '{}');
        Object.keys(advancedSettings).forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                if (element.type === 'checkbox') {
                    element.checked = advancedSettings[id];
                } else {
                    element.value = advancedSettings[id];
                }
            }
        });
    }
</script>
</body>
</html>