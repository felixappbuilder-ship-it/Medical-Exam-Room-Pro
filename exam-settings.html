<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exam Configuration - Medical Exam Room Pro</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/exam-settings.css">
    <link rel="icon" href="images/logo.png" type="image/png">
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('service-worker.js');
            });
        }
    </script>
</head>
<body>

<div class="container">
    <header>
        <div class="logo">
            <img src="images/logo.png" alt="Logo">
            Exam Configuration
        </div>
        <button class="btn-outline" id="themeToggle">
            <span class="theme-icon">üåô</span>
            <span class="theme-text">Dark Mode</span>
        </button>
    </header>

    <div class="top-nav">
        <a href="#" id="backBtn" style="text-decoration: none; color: var(--accent-color);">‚Üê Back to Subjects</a>
        <div class="advanced-menu">
            ‚ãÆ
            <div class="dropdown-content">
                <strong>Advanced Settings</strong>
                <hr>
                <div style="font-size: 14px; line-height: 1.6;">
                    <!-- Display Settings -->
                    <div style="margin-bottom: 10px;">
                        <strong>Display:</strong>
                        <label class="checkbox-label">
                            Start in fullscreen mode: <input type="checkbox" id="fullscreen" checked>
                        </label>
                        <label class="checkbox-label">
                            Distraction-free mode: <input type="checkbox" id="distractionFree" checked>
                        </label>
                        <label class="checkbox-label">
                            Show progress bar: <input type="checkbox" id="showProgress" checked>
                        </label>
                    </div>
                    
                    <!-- Security Features -->
                    <div style="margin-bottom: 10px;">
                        <strong>Security:</strong>
                        <label class="checkbox-label">
                            Prevent copy-paste: <input type="checkbox" id="preventCopy" checked>
                        </label>
                        <label class="checkbox-label">
                            Auto-save (30s): <input type="checkbox" id="autoSave" checked>
                        </label>
                        <label class="checkbox-label">
                            Detect tab switching: <input type="checkbox" id="pauseDetection" checked>
                        </label>
                    </div>
                    
                    <!-- Review Options -->
                    <div style="margin-bottom: 10px;">
                        <strong>Review:</strong>
                        <label class="checkbox-label">
                            Allow flagging: <input type="checkbox" id="flagQuestions" checked>
                        </label>
                        <label class="checkbox-label">
                            Show explanations: <input type="checkbox" id="showExplanations" checked>
                        </label>
                    </div>
                    
                    <!-- Time Warnings -->
                    <div>
                        <strong>Warnings:</strong>
                        <label class="checkbox-label">
                            Color warnings: <input type="checkbox" id="colorWarnings" checked>
                        </label>
                        <label class="checkbox-label">
                            Flashing red (last 5s): <input type="checkbox" id="flashWarnings" checked>
                        </label>
                    </div>
                    
                    <!-- Advanced Options -->
                    <div style="margin-top: 10px;">
                        <strong>More Options:</strong>
                        <div style="font-size: 12px;">
                            Question Order:
                            <select id="questionOrder" style="width: 100%; margin: 5px 0; font-size: 12px; padding: 4px;">
                                <option value="random">Random</option>
                                <option value="difficulty">By Difficulty</option>
                                <option value="topic">By Topic</option>
                            </select>
                            
                            Break Interval:
                            <select id="breakInterval" style="width: 100%; margin: 5px 0; font-size: 12px; padding: 4px;">
                                <option value="0">No breaks</option>
                                <option value="25">Every 25 questions</option>
                                <option value="50">Every 50 questions</option>
                            </select>
                            
                            Passing Score: <input type="number" id="passingScore" value="70" min="0" max="100" style="width: 60px; padding: 4px; font-size: 12px;">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <h2>Configure your exam</h2>

    <div class="info-box" id="examSummary">
        <!-- Loaded by JavaScript -->
    </div>

    <div class="form-group">
        <label>Exam Mode</label>
        <select id="examMode">
            <option value="timed">Timed Exam</option>
            <option value="practice">Practice Mode</option>
            <option value="review">Review Mode</option>
        </select>
    </div>

    <div class="form-group">
        <label>Number of Questions</label>
        <div style="display: flex; gap: 10px; align-items: center;">
            <select id="questionCountSelect" style="flex: 1;">
                <option value="10">Quick Exam (10)</option>
                <option value="25" selected>Standard (25)</option>
                <option value="50">Full Exam (50)</option>
                <option value="custom">Custom</option>
            </select>
            <input type="number" id="customCount" min="1" max="200" placeholder="Custom" 
                   style="display: none; width: 100px; padding: 12px;">
        </div>
        <div id="countHint" style="font-size: 0.85rem; margin-top: 5px; color: #666;">
            Available: 0 questions
        </div>
    </div>

    <div class="form-group">
        <label>Difficulty Level</label>
        <div class="difficulty-slider">
            <input type="range" id="difficultyLevel" min="0" max="4" value="2" step="1">
            <div class="slider-value" id="difficultyValue">Mixed Difficulty</div>
        </div>
        <div id="difficultyDesc" style="font-size: 0.85rem; margin-top: 5px; color: #666;">
            Mix of easy, medium, and hard questions
        </div>
    </div>

    <div class="form-group">
        <label>Timer Settings</label>
        <select id="timerMode">
            <option value="adaptive">Adaptive (21-54s based on difficulty)</option>
            <option value="strict">Strict (30s fixed)</option>
            <option value="relaxed">Relaxed (60s fixed)</option>
            <option value="untimed">No Timer (Practice only)</option>
        </select>
    </div>

    <div class="form-group">
        <label>Question Distribution</label>
        <select id="questionDistribution">
            <option value="balanced">Balanced (Equal from each topic)</option>
            <option value="weighted">Weighted (More from weak areas)</option>
            <option value="random">Random (Completely random)</option>
        </select>
    </div>

    <div class="form-group">
        <div style="display: flex; gap: 10px; align-items: center;">
            <input type="text" id="presetName" placeholder="Preset name" 
                   style="flex: 1; padding: 12px;">
            <button class="btn-outline" id="savePresetBtn" style="white-space: nowrap;">
                Save Preset üíæ
            </button>
        </div>
        <div id="presetList" style="margin-top: 10px; max-height: 100px; overflow-y: auto;">
            <!-- Presets will be loaded here -->
        </div>
    </div>

    <div id="estimatedTime" class="estimated-time">
        Estimated exam time: Calculating...
    </div>

    <div class="button-group">
        <button class="btn-secondary" id="resetBtn">Reset to Default</button>
        <button class="btn-outline" id="cancelBtn" style="color: red;">Cancel</button>
        <button class="btn-primary" id="startExamBtn">Start Exam ‚Äî></button>
    </div>

    <p class="footer-note">All settings configured here will be applied to your exam. You can save configuration as Preset for future use.</p>
</div>

<!-- JavaScript Files -->
<script src="scripts/app.js"></script>
<script src="scripts/router.js"></script>
<script src="scripts/ui.js"></script>
<script src="scripts/utils.js"></script>
<script src="scripts/subscription.js"></script>
<script src="scripts/questions.js"></script>
<script src="scripts/exam-engine.js"></script>


<script>
    /**
 * exam-settings.js - Exam Configuration Handler
 * Purpose: Exam setup, configuration validation, and preparation for exam-room.html
 * Uses: app.js, exam-engine.js, questions.js, subscription.js, ui.js, utils.js, router.js
 */

// Wait for all modules to be ready
document.addEventListener('DOMContentLoaded', async function() {
    console.log("Exam Settings: Initializing...");
    
    // ==================== MODULE INITIALIZATION ====================
    
    // Wait for essential modules to load
    await waitForModules(['App', 'QuestionBank', 'Subscription', 'UI', 'Utils', 'Router']);
    
    // Module references
    const app = window.App || {};
    const questionBank = window.QuestionBank;
    const subscription = window.Subscription;
    const ui = window.UI;
    const utils = window.Utils;
    const router = window.Router;
    
    // ==================== STATE MANAGEMENT ====================
    
    let state = {
        selectedSubjects: [],
        selectedTopics: [],
        availableQuestions: 0,
        examConfig: {},
        isConfigValid: false
    };
    
    // ==================== INITIALIZATION ====================
    
    async function initializeExamSettings() {
        try {
            console.log("Exam Settings: Starting initialization...");
            
            // 1. Initialize theme from UI module
            initializeTheme();
            
            // 2. Load user state from app
            await loadUserState();
            
            // 3. Load selected subjects and topics
            loadSelections();
            
            // 4. Calculate available questions
            await calculateAvailableQuestions();
            
            // 5. Initialize UI components
            initializeUIComponents();
            
            // 6. Load saved exam configuration
            loadSavedConfiguration();
            
            // 7. Setup event listeners
            setupEventListeners();
            
            // 8. Update UI based on state
            updateUI();
            
            console.log("Exam Settings: Initialization complete");
            
        } catch (error) {
            console.error("Exam Settings: Initialization failed:", error);
            showError("Failed to initialize exam settings. Please refresh the page.");
        }
    }
    
    // ==================== MODULE INTEGRATION FUNCTIONS ====================
    
    async function waitForModules(moduleNames) {
        const promises = moduleNames.map(moduleName => {
            return new Promise((resolve) => {
                const checkModule = () => {
                    if (window[moduleName]) {
                        console.log(`${moduleName} module loaded`);
                        resolve(window[moduleName]);
                    } else {
                        setTimeout(checkModule, 100);
                    }
                };
                checkModule();
            });
        });
        
        await Promise.all(promises);
    }
    
    function initializeTheme() {
        if (ui && ui.initializeTheme) {
            ui.initializeTheme();
        } else {
            // Fallback theme handling
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.body.classList.toggle('dark-theme', savedTheme === 'dark');
            
            const themeToggle = document.getElementById('themeToggle');
            if (themeToggle) {
                themeToggle.addEventListener('click', function() {
                    const isDark = document.body.classList.toggle('dark-theme');
                    localStorage.setItem('theme', isDark ? 'dark' : 'light');
                    
                    const themeIcon = this.querySelector('.theme-icon');
                    const themeText = this.querySelector('.theme-text');
                    
                    if (isDark) {
                        themeIcon.textContent = '‚òÄÔ∏è';
                        themeText.textContent = 'Light Mode';
                    } else {
                        themeIcon.textContent = 'üåô';
                        themeText.textContent = 'Dark Mode';
                    }
                });
            }
        }
    }
    
    async function loadUserState() {
        try {
            // Check if user is logged in via app module
            if (app && app.getCurrentUser) {
                const user = app.getCurrentUser();
                if (!user) {
                    throw new Error("User not logged in");
                }
                console.log("User state loaded:", user.id);
            }
        } catch (error) {
            console.warn("Could not load user state:", error);
        }
    }
    
    function loadSelections() {
        try {
            // Load from localStorage (this would come from subjects page)
            state.selectedSubjects = JSON.parse(localStorage.getItem('selectedSubjects') || '[]');
            state.selectedTopics = JSON.parse(localStorage.getItem('selectedTopics') || '[]');
            
            if (state.selectedTopics.length === 0) {
                showWarning("No topics selected. Please go back and select topics.");
            }
            
            console.log("Loaded selections:", {
                subjects: state.selectedSubjects.length,
                topics: state.selectedTopics.length
            });
        } catch (error) {
            console.error("Failed to load selections:", error);
            state.selectedSubjects = [];
            state.selectedTopics = [];
        }
    }
    
    async function calculateAvailableQuestions() {
        try {
            if (!questionBank || !questionBank.getQuestionCount) {
                throw new Error("Question bank module not available");
            }
            
            let totalQuestions = 0;
            
            // Calculate questions for each topic
            for (const topic of state.selectedTopics) {
                const parts = topic.split('_');
                if (parts.length === 2) {
                    const [subject, topicName] = parts;
                    try {
                        const count = await questionBank.getQuestionCount(subject, topicName);
                        totalQuestions += count;
                    } catch (error) {
                        console.warn(`Could not get count for ${subject}/${topicName}:`, error);
                    }
                }
            }
            
            state.availableQuestions = totalQuestions;
            console.log(`Available questions: ${totalQuestions}`);
            
        } catch (error) {
            console.error("Failed to calculate available questions:", error);
            // Fallback estimation
            state.availableQuestions = state.selectedTopics.length * 50;
        }
    }
    
    // ==================== UI COMPONENTS INITIALIZATION ====================
    
    function initializeUIComponents() {
        // Initialize UI components if UI module is available
        if (ui) {
            // Initialize tooltips
            const tooltips = document.querySelectorAll('[data-tooltip]');
            tooltips.forEach(el => {
                if (ui.initializeTooltip) {
                    ui.initializeTooltip(el);
                }
            });
            
            // Initialize progress indicators
            const progressBars = document.querySelectorAll('.progress-bar');
            progressBars.forEach(el => {
                if (ui.initializeProgressBar) {
                    ui.initializeProgressBar(el);
                }
            });
        }
    }
    
    function loadSavedConfiguration() {
        try {
            const savedConfig = JSON.parse(localStorage.getItem('examConfiguration') || '{}');
            if (savedConfig && Object.keys(savedConfig).length > 0) {
                state.examConfig = savedConfig;
                applySavedConfiguration(savedConfig);
                console.log("Loaded saved exam configuration");
            }
        } catch (error) {
            console.error("Failed to load saved configuration:", error);
        }
    }
    
    function applySavedConfiguration(config) {
        // Apply mode
        const modeElement = document.querySelector(`.mode-option[data-mode="${config.examMode}"]`);
        if (modeElement) {
            selectMode(modeElement);
        }
        
        // Apply question count
        if (config.questionCount) {
            const count = parseInt(config.questionCount);
            if ([10, 25, 50].includes(count)) {
                const countBtn = document.querySelector(`.count-btn[data-count="${count}"]`);
                if (countBtn) countBtn.click();
            } else if (count > 0) {
                const customInput = document.getElementById('customCount');
                if (customInput) {
                    customInput.value = count;
                    updateCustomCount();
                }
            }
        }
        
        // Apply difficulty
        if (config.difficulty) {
            const slider = document.getElementById('difficultyLevel');
            if (slider) {
                slider.value = config.difficulty;
                updateDifficultyDisplay();
            }
        }
        
        // Apply timer mode
        if (config.timerMode) {
            const timerRadio = document.querySelector(`input[name="timer"][value="${config.timerMode}"]`);
            if (timerRadio) timerRadio.checked = true;
        }
        
        // Load presets if available
        loadPresets();
    }
    
    // ==================== UI UPDATE FUNCTIONS ====================
    
    function updateUI() {
        updateExamSummary();
        updateTopicsReview();
        updateQuestionCountLimits();
        calculateEstimatedTime();
        updateValidationStatus();
    }
    
    function updateExamSummary() {
        const subjectNames = {
            'anatomy': 'Anatomy', 'physiology': 'Physiology', 'biochemistry': 'Biochemistry',
            'histology': 'Histology', 'embryology': 'Embryology', 'pathology': 'Pathology',
            'pharmacology': 'Pharmacology', 'microbiology': 'Microbiology'
        };
        
        const subjectList = state.selectedSubjects.map(sub => subjectNames[sub] || sub).join(', ');
        const topicCount = state.selectedTopics.length;
        
        const summaryHTML = `
            <div class="summary-card">
                <div class="summary-item">
                    <span class="summary-label">Subjects:</span>
                    <span class="summary-value">${subjectList || 'None selected'}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Topics Selected:</span>
                    <span class="summary-value">${topicCount} topic${topicCount !== 1 ? 's' : ''}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Available Questions:</span>
                    <span class="summary-value" id="availableQuestions">
                        ${state.availableQuestions.toLocaleString()}
                    </span>
                </div>
            </div>
        `;
        
        const summaryElement = document.getElementById('examSummary');
        if (summaryElement) {
            summaryElement.innerHTML = summaryHTML;
        }
        
        // Update hint
        const countHint = document.getElementById('countHint');
        if (countHint) {
            countHint.textContent = `Available: ${state.availableQuestions.toLocaleString()} questions`;
        }
    }
    
    function updateTopicsReview() {
        const topicsContainer = document.getElementById('topicsReview');
        if (!topicsContainer) return;
        
        if (state.selectedTopics.length === 0) {
            topicsContainer.innerHTML = `
                <div class="no-topics">
                    <span class="warning-icon">‚ö†Ô∏è</span>
                    <span class="warning-text">No topics selected</span>
                </div>
            `;
        } else {
            // Format topic names for display
            const topicDisplay = state.selectedTopics.map(topic => {
                const parts = topic.split('_');
                if (parts.length === 2) {
                    const [subject, topicName] = parts;
                    const formattedName = topicName.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    return `${subject.charAt(0).toUpperCase() + subject.slice(1)}: ${formattedName}`;
                }
                return topic;
            });
            
            const topicList = topicDisplay.slice(0, 5).map(topic => 
                `<span class="topic-tag">${topic}</span>`
            ).join('');
            
            const extraCount = Math.max(0, state.selectedTopics.length - 5);
            const extraText = extraCount > 0 ? `<span class="extra-count">+${extraCount} more</span>` : '';
            
            topicsContainer.innerHTML = `
                <div class="topics-list">
                    ${topicList}
                    ${extraText}
                </div>
            `;
        }
    }
    
    function updateQuestionCountLimits() {
        const customCountInput = document.getElementById('customCount');
        if (customCountInput) {
            customCountInput.max = state.availableQuestions;
            customCountInput.min = 1;
            
            // Update placeholder
            customCountInput.placeholder = `1-${state.availableQuestions}`;
            
            // Validate current value
            if (customCountInput.value) {
                const value = parseInt(customCountInput.value);
                if (value > state.availableQuestions) {
                    customCountInput.value = state.availableQuestions;
                }
            }
        }
    }
    
    function updateDifficultyDisplay() {
        const difficultySlider = document.getElementById('difficultyLevel');
        const difficultyValue = document.getElementById('difficultyValue');
        const difficultyDesc = document.getElementById('difficultyDesc');
        
        if (!difficultySlider || !difficultyValue || !difficultyDesc) return;
        
        const value = parseInt(difficultySlider.value);
        const difficultyLabels = ['Easy Only', 'Mostly Easy', 'Mixed Difficulty', 'Mostly Hard', 'Expert Only'];
        const difficultyDescriptions = [
            'All easy questions (21 seconds each)',
            'Mostly easy questions with some medium',
            'Mix of easy, medium, and hard questions',
            'Mostly hard questions with some expert',
            'All expert questions (54 seconds each)'
        ];
        
        difficultyValue.textContent = difficultyLabels[value];
        difficultyDesc.textContent = difficultyDescriptions[value];
    }
    
    function calculateEstimatedTime() {
        const questionCount = getSelectedQuestionCount();
        const difficulty = parseInt(document.getElementById('difficultyLevel')?.value || 2);
        const timerMode = document.querySelector('input[name="timer"]:checked')?.value || 'adaptive';
        
        // Base times for each difficulty level (in seconds)
        const difficultyTimes = [21, 27, 36, 45, 54];
        const baseTime = difficultyTimes[difficulty] || 30;
        
        let totalSeconds;
        switch(timerMode) {
            case 'adaptive':
                totalSeconds = questionCount * baseTime;
                break;
            case 'strict':
                totalSeconds = questionCount * 30;
                break;
            case 'relaxed':
                totalSeconds = questionCount * 60;
                break;
            case 'untimed':
                totalSeconds = 0;
                break;
            default:
                totalSeconds = questionCount * 30;
        }
        
        const estimatedTimeElement = document.getElementById('estimatedTime');
        if (!estimatedTimeElement) return;
        
        if (totalSeconds === 0) {
            estimatedTimeElement.textContent = 'No time limit (Practice mode)';
        } else {
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            
            if (minutes === 0) {
                estimatedTimeElement.textContent = `Estimated exam time: ${seconds} seconds`;
            } else if (seconds === 0) {
                estimatedTimeElement.textContent = `Estimated exam time: ${minutes} minute${minutes !== 1 ? 's' : ''}`;
            } else {
                estimatedTimeElement.textContent = `Estimated exam time: ${minutes} minute${minutes !== 1 ? 's' : ''} ${seconds} seconds`;
            }
        }
    }
    
    function updateValidationStatus() {
        const hasTopics = state.selectedTopics.length > 0;
        const questionCount = getSelectedQuestionCount();
        const isValid = hasTopics && questionCount > 0 && questionCount <= state.availableQuestions;
        
        state.isConfigValid = isValid;
        
        // Update start button state
        const startBtn = document.getElementById('startExamBtn');
        if (startBtn) {
            startBtn.disabled = !isValid;
            if (!isValid) {
                startBtn.title = !hasTopics ? 'Select topics first' : 
                               questionCount === 0 ? 'Select question count' :
                               'Question count exceeds available questions';
            } else {
                startBtn.title = 'Start exam with current settings';
            }
        }
    }
    
    // ==================== EVENT HANDLERS ====================
    
    function setupEventListeners() {
        // Navigation
        setupNavigationListeners();
        
        // Question count selection
        setupQuestionCountListeners();
        
        // Difficulty slider
        setupDifficultyListeners();
        
        // Mode selection
        setupModeListeners();
        
        // Timer mode
        setupTimerListeners();
        
        // Custom count input
        setupCustomCountListener();
        
        // Change topics button
        setupChangeTopicsListener();
        
        // Preset functionality
        setupPresetListeners();
        
        // Reset button
        setupResetListener();
        
        // Start exam button
        setupStartExamListener();
        
        // Additional settings
        setupAdditionalSettingsListeners();
    }
    
    function setupNavigationListeners() {
        const backBtn = document.getElementById('backBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        
        if (backBtn) {
            backBtn.addEventListener('click', function() {
                if (router && router.navigateBack) {
                    router.navigateBack();
                } else {
                    window.history.back() || (window.location.href = 'subjects.html');
                }
            });
        }
        
        if (cancelBtn) {
            cancelBtn.addEventListener('click', function() {
                if (confirm('Are you sure you want to cancel? Your settings will not be saved.')) {
                    if (router && router.navigateBack) {
                        router.navigateBack();
                    } else {
                        window.history.back();
                    }
                }
            });
        }
    }
    
    function setupQuestionCountListeners() {
        document.querySelectorAll('.count-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                // Remove active class from all buttons
                document.querySelectorAll('.count-btn').forEach(b => b.classList.remove('active'));
                // Add active class to clicked button
                this.classList.add('active');
                // Clear custom count
                const customCount = document.getElementById('customCount');
                if (customCount) customCount.value = '';
                
                updateValidationStatus();
                calculateEstimatedTime();
            });
        });
    }
    
    function setupCustomCountListener() {
        const customCount = document.getElementById('customCount');
        if (!customCount) return;
        
        customCount.addEventListener('input', function() {
            updateCustomCount();
        });
        
        customCount.addEventListener('blur', function() {
            validateCustomCount();
        });
    }
    
    function updateCustomCount() {
        const customCount = document.getElementById('customCount');
        if (!customCount) return;
        
        // Remove active class from count buttons
        document.querySelectorAll('.count-btn').forEach(b => b.classList.remove('active'));
        
        updateValidationStatus();
        calculateEstimatedTime();
    }
    
    function validateCustomCount() {
        const customCount = document.getElementById('customCount');
        if (!customCount) return;
        
        let value = parseInt(customCount.value) || 0;
        const max = parseInt(customCount.max) || state.availableQuestions;
        
        if (value < 1) value = 1;
        if (value > max) value = max;
        
        customCount.value = value;
        updateValidationStatus();
        calculateEstimatedTime();
    }
    
    function setupDifficultyListeners() {
        const difficultySlider = document.getElementById('difficultyLevel');
        if (!difficultySlider) return;
        
        difficultySlider.addEventListener('input', function() {
            updateDifficultyDisplay();
            calculateEstimatedTime();
        });
    }
    
    function setupModeListeners() {
        document.querySelectorAll('.mode-option').forEach(option => {
            option.addEventListener('click', function() {
                selectMode(this);
                calculateEstimatedTime();
            });
        });
    }
    
    function selectMode(element) {
        // Remove selected class from all options
        document.querySelectorAll('.mode-option').forEach(opt => {
            opt.classList.remove('selected');
            const check = opt.querySelector('.mode-check');
            if (check) check.textContent = '';
        });
        
        // Add selected class to clicked option
        element.classList.add('selected');
        const check = element.querySelector('.mode-check');
        if (check) check.textContent = '‚úì';
    }
    
    function setupTimerListeners() {
        document.querySelectorAll('input[name="timer"]').forEach(radio => {
            radio.addEventListener('change', calculateEstimatedTime);
        });
    }
    
    function setupChangeTopicsListener() {
        const changeTopicsBtn = document.getElementById('changeTopicsBtn');
        if (!changeTopicsBtn) return;
        
        changeTopicsBtn.addEventListener('click', function() {
            if (state.selectedSubjects.length === 1) {
                // Go back to specific subject page
                const subject = state.selectedSubjects[0];
                window.location.href = `subject-${subject}.html`;
            } else {
                // Go back to subjects page
                window.location.href = 'subjects.html';
            }
        });
    }
    
    function setupPresetListeners() {
        const savePresetBtn = document.getElementById('savePresetBtn');
        const presetNameInput = document.getElementById('presetName');
        
        if (savePresetBtn && presetNameInput) {
            savePresetBtn.addEventListener('click', function() {
                savePreset();
            });
            
            presetNameInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    savePreset();
                }
            });
        }
        
        loadPresets();
    }
    
    function savePreset() {
        const presetNameInput = document.getElementById('presetName');
        if (!presetNameInput) return;
        
        const presetName = presetNameInput.value.trim();
        if (!presetName) {
            showError('Please enter a name for your preset');
            return;
        }
        
        const preset = getCurrentConfiguration();
        preset.name = presetName;
        preset.timestamp = Date.now();
        
        // Save to localStorage
        const presets = JSON.parse(localStorage.getItem('examPresets') || '[]');
        
        // Check if preset with same name exists
        const existingIndex = presets.findIndex(p => p.name === presetName);
        if (existingIndex !== -1) {
            presets[existingIndex] = preset;
        } else {
            presets.push(preset);
        }
        
        localStorage.setItem('examPresets', JSON.stringify(presets));
        
        // Clear input
        presetNameInput.value = '';
        
        // Reload presets
        loadPresets();
        
        showSuccess(`Preset "${presetName}" saved successfully!`);
    }
    
    function loadPresets() {
        const presetList = document.getElementById('presetList');
        if (!presetList) return;
        
        const presets = JSON.parse(localStorage.getItem('examPresets') || '[]');
        
        if (presets.length === 0) {
            presetList.innerHTML = '<div class="no-presets">No saved presets yet</div>';
            return;
        }
        
        // Sort by timestamp (newest first)
        presets.sort((a, b) => b.timestamp - a.timestamp);
        
        presetList.innerHTML = presets.map((preset, index) => `
            <div class="preset-item">
                <div class="preset-info">
                    <div class="preset-name">${preset.name}</div>
                    <div class="preset-details">
                        <span class="detail">${preset.examMode || 'timed'}</span>
                        <span class="detail">${preset.questionCount || 25} questions</span>
                        <span class="detail">${getDifficultyLabel(preset.difficulty)}</span>
                    </div>
                </div>
                <div class="preset-actions">
                    <button class="btn-preset-load" data-index="${index}">
                        <span class="btn-icon">‚Üª</span>
                        <span class="btn-text">Load</span>
                    </button>
                    <button class="btn-preset-delete" data-index="${index}">
                        <span class="btn-icon">üóëÔ∏è</span>
                    </button>
                </div>
            </div>
        `).join('');
        
        // Add event listeners to preset buttons
        document.querySelectorAll('.btn-preset-load').forEach(btn => {
            btn.addEventListener('click', function() {
                const index = parseInt(this.dataset.index);
                loadPreset(presets[index]);
            });
        });
        
        document.querySelectorAll('.btn-preset-delete').forEach(btn => {
            btn.addEventListener('click', function() {
                const index = parseInt(this.dataset.index);
                deletePreset(index, presets);
            });
        });
    }
    
    function getDifficultyLabel(difficulty) {
        const labels = ['Easy', 'Mostly Easy', 'Mixed', 'Mostly Hard', 'Expert'];
        return labels[difficulty] || 'Mixed';
    }
    
    function loadPreset(preset) {
        if (!preset) return;
        
        // Load mode
        const modeOption = document.querySelector(`.mode-option[data-mode="${preset.examMode}"]`);
        if (modeOption) selectMode(modeOption);
        
        // Load question count
        const count = parseInt(preset.questionCount);
        if ([10, 25, 50].includes(count)) {
            const countBtn = document.querySelector(`.count-btn[data-count="${count}"]`);
            if (countBtn) countBtn.click();
        } else if (count > 0) {
            const customCount = document.getElementById('customCount');
            if (customCount) {
                customCount.value = count;
                updateCustomCount();
            }
        }
        
        // Load difficulty
        const difficultySlider = document.getElementById('difficultyLevel');
        if (difficultySlider && preset.difficulty !== undefined) {
            difficultySlider.value = preset.difficulty;
            updateDifficultyDisplay();
        }
        
        // Load timer mode
        if (preset.timerMode) {
            const timerRadio = document.querySelector(`input[name="timer"][value="${preset.timerMode}"]`);
            if (timerRadio) timerRadio.checked = true;
        }
        
        // Load checkboxes
        const checkboxes = [
            'fullscreen', 'distractionFree', 'autoAdvance', 'showProgress',
            'preventCopy', 'autoSave', 'pauseDetection', 'timeValidation',
            'flagQuestions', 'showExplanations', 'instantFeedback', 'reviewAll',
            'colorWarnings', 'soundWarnings', 'flashWarnings'
        ];
        
        checkboxes.forEach(id => {
            const checkbox = document.getElementById(id);
            if (checkbox && preset[id] !== undefined) {
                checkbox.checked = preset[id];
            }
        });
        
        showSuccess(`Preset "${preset.name}" loaded successfully!`);
        calculateEstimatedTime();
    }
    
    function deletePreset(index, presets) {
        if (confirm('Are you sure you want to delete this preset?')) {
            presets.splice(index, 1);
            localStorage.setItem('examPresets', JSON.stringify(presets));
            loadPresets();
            showSuccess('Preset deleted successfully!');
        }
    }
    
    function setupResetListener() {
        const resetBtn = document.getElementById('resetBtn');
        if (!resetBtn) return;
        
        resetBtn.addEventListener('click', function() {
            if (confirm('Reset all settings to defaults?')) {
                resetToDefaults();
            }
        });
    }
    
    function resetToDefaults() {
        // Reset mode to timed
        const timedMode = document.querySelector('.mode-option[data-mode="timed"]');
        if (timedMode) selectMode(timedMode);
        
        // Reset question count to 25
        const standardCount = document.querySelector('.count-btn[data-count="25"]');
        if (standardCount) standardCount.click();
        
        // Reset difficulty to mixed (level 2)
        const difficultySlider = document.getElementById('difficultyLevel');
        if (difficultySlider) {
            difficultySlider.value = 2;
            updateDifficultyDisplay();
        }
        
        // Reset timer to adaptive
        const adaptiveTimer = document.querySelector('input[name="timer"][value="adaptive"]');
        if (adaptiveTimer) adaptiveTimer.checked = true;
        
        // Reset custom count
        const customCount = document.getElementById('customCount');
        if (customCount) customCount.value = '';
        
        // Reset checkboxes to defaults
        const defaultCheckboxes = {
            fullscreen: true,
            distractionFree: true,
            autoAdvance: false,
            showProgress: true,
            preventCopy: true,
            autoSave: true,
            pauseDetection: true,
            timeValidation: true,
            flagQuestions: true,
            showExplanations: true,
            instantFeedback: false,
            reviewAll: true,
            colorWarnings: true,
            soundWarnings: false,
            flashWarnings: true
        };
        
        Object.keys(defaultCheckboxes).forEach(id => {
            const checkbox = document.getElementById(id);
            if (checkbox) {
                checkbox.checked = defaultCheckboxes[id];
            }
        });
        
        calculateEstimatedTime();
        showSuccess('Settings reset to defaults!');
    }
    
    function setupAdditionalSettingsListeners() {
        // Add listeners for additional settings if needed
        const additionalSettings = document.querySelectorAll('.setting-checkbox');
        additionalSettings.forEach(setting => {
            setting.addEventListener('change', function() {
                // Update validation or calculations if needed
                updateValidationStatus();
            });
        });
    }
    
    function setupStartExamListener() {
        const startBtn = document.getElementById('startExamBtn');
        if (!startBtn) return;
        
        startBtn.addEventListener('click', async function() {
            await startExam();
        });
    }
    
    // ==================== EXAM START FUNCTION ====================
    
    async function startExam() {
        try {
            // 1. Validate configuration
            if (!state.isConfigValid) {
                showError('Please complete the exam configuration');
                return;
            }
            
            // 2. Check subscription
            const hasSubscription = await checkSubscription();
            if (!hasSubscription) {
                showError('Valid subscription required. Please subscribe to continue.');
                if (router && router.navigateTo) {
                    router.navigateTo('subscription.html');
                } else {
                    window.location.href = 'subscription.html';
                }
                return;
            }
            
            // 3. Get current configuration
            const examConfig = getCurrentConfiguration();
            
            // 4. Validate against available questions
            if (examConfig.questionCount > state.availableQuestions) {
                showError(`Only ${state.availableQuestions} questions available. Please reduce the question count.`);
                return;
            }
            
            // 5. Save configuration
            saveExamConfiguration(examConfig);
            
            // 6. Navigate to exam room
            if (router && router.navigateTo) {
                router.navigateTo('exam-room.html');
            } else {
                window.location.href = 'exam-room.html';
            }
            
        } catch (error) {
            console.error("Failed to start exam:", error);
            showError("Failed to start exam. Please try again.");
        }
    }
    
    async function checkSubscription() {
        try {
            if (subscription && subscription.hasActiveSubscription) {
                const user = app.getCurrentUser ? app.getCurrentUser() : null;
                if (user && user.id) {
                    return await subscription.hasActiveSubscription(user.id);
                }
            }
            
            // Fallback to localStorage check
            const subscriptionData = JSON.parse(localStorage.getItem('subscription') || '{}');
            const expiryDate = subscriptionData.expiryDate;
            
            if (!expiryDate) return false;
            
            const now = new Date();
            const expiry = new Date(expiryDate);
            return expiry > now;
            
        } catch (error) {
            console.error("Subscription check failed:", error);
            return false;
        }
    }
    
    function getCurrentConfiguration() {
        return {
            examId: 'exam_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
            examMode: document.querySelector('.mode-option.selected')?.dataset.mode || 'timed',
            questionCount: getSelectedQuestionCount(),
            difficulty: parseInt(document.getElementById('difficultyLevel')?.value || 2),
            timerMode: document.querySelector('input[name="timer"]:checked')?.value || 'adaptive',
            distribution: document.querySelector('input[name="distribution"]:checked')?.value || 'balanced',
            questionOrder: document.getElementById('questionOrder')?.value || 'random',
            passingScore: parseInt(document.getElementById('passingScore')?.value || 70),
            breakInterval: document.getElementById('breakInterval')?.value || '0',
            // Display settings
            fullscreen: document.getElementById('fullscreen')?.checked || true,
            distractionFree: document.getElementById('distractionFree')?.checked || true,
            autoAdvance: document.getElementById('autoAdvance')?.checked || false,
            showProgress: document.getElementById('showProgress')?.checked || true,
            // Security settings
            preventCopy: document.getElementById('preventCopy')?.checked || true,
            autoSave: document.getElementById('autoSave')?.checked || true,
            pauseDetection: document.getElementById('pauseDetection')?.checked || true,
            timeValidation: document.getElementById('timeValidation')?.checked || true,
            // Review settings
            flagQuestions: document.getElementById('flagQuestions')?.checked || true,
            showExplanations: document.getElementById('showExplanations')?.checked || true,
            instantFeedback: document.getElementById('instantFeedback')?.checked || false,
            reviewAll: document.getElementById('reviewAll')?.checked || true,
            // Warning settings
            colorWarnings: document.getElementById('colorWarnings')?.checked || true,
            soundWarnings: document.getElementById('soundWarnings')?.checked || false,
            flashWarnings: document.getElementById('flashWarnings')?.checked || true,
            // Subjects and topics
            subjects: state.selectedSubjects,
            topics: state.selectedTopics,
            availableQuestions: state.availableQuestions,
            // Metadata
            configTimestamp: Date.now()
        };
    }
    
    function getSelectedQuestionCount() {
        const activeBtn = document.querySelector('.count-btn.active');
        if (activeBtn) {
            return parseInt(activeBtn.dataset.count);
        }
        
        const customCount = document.getElementById('customCount');
        if (customCount && customCount.value) {
            return parseInt(customCount.value) || 25;
        }
        
        return 25; // Default
    }
    
    function saveExamConfiguration(config) {
        try {
            localStorage.setItem('examConfiguration', JSON.stringify(config));
            console.log("Exam configuration saved:", config);
        } catch (error) {
            console.error("Failed to save exam configuration:", error);
            throw error;
        }
    }
    
    // ==================== UTILITY FUNCTIONS ====================
    
    function showError(message) {
        if (ui && ui.showError) {
            ui.showError(message);
        } else {
            alert(message);
        }
    }
    
    function showWarning(message) {
        if (ui && ui.showWarning) {
            ui.showWarning(message);
        } else {
            console.warn(message);
        }
    }
    
    function showSuccess(message) {
        if (ui && ui.showSuccess) {
            ui.showSuccess(message);
        } else {
            alert(message);
        }
    }
    
    // ==================== START INITIALIZATION ====================
    
    // Initialize exam settings
    await initializeExamSettings();
    
    console.log("Exam Settings: Script execution complete");
});
</script>
</body>
</html>