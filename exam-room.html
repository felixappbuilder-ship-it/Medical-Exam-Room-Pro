<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exam Room - Medical Exam Room Pro</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/exam-room.css">
    <link rel="icon" href="images/logo.png" type="image/png">
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('service-worker.js');
            });
        }
    </script>
</head>
<body>

    <!-- New header matching first HTML layout -->
    <header>
        <div class="header-top">
            <div>
                <strong>Medical Exam Room Pro</strong><br>
                <span id="examProgress">Question 1 of 25</span>
            </div>
            <div class="exam-controls">
                <button id="profileBtn">Profile</button>
                <button id="fullscreenBtn">Fullscreen</button>
            </div>
        </div>
        <div class="timer-row">
            <span id="timerValue">00:30</span> remaining
            <div class="timer-visual" id="timerVisual" style="display: inline-block; width: 100px; height: 4px; background: #4CAF50; margin-left: 10px;"></div>
        </div>
        <div class="button-row">
            <div>
                <button id="backToSubjectsBtn">‚Üê Back to subjects</button>
                <button id="flagBtn">Flag</button>
                <button id="pauseBtn">Pause</button>
            </div>
            <div>
                <button id="submitBtn">Submit</button>
            </div>
        </div>
    </header>

    <main>
        <!-- Question Section (90%) -->
        <div class="question-section">
            <div class="desc-box">
                <div class="question-meta">
                    <span id="questionNumber">Q1</span> ‚Ä¢ 
                    <span id="questionSubject">Anatomy</span> ‚Ä¢ 
                    <span id="questionTopic">Upper Limb</span> ‚Ä¢ 
                    <span id="questionDifficulty">Medium</span>
                </div>
                <div class="question-time" id="questionTimeInfo">Avg time: 24s</div>
            </div>
            
            <div class="q-text">
                <p id="questionText"></p>
            </div>
            
            <div class="q-image-container" id="questionImage" style="display: none;">
                <img src="" alt="Question diagram" id="questionImg">
                <div class="image-caption" id="imageCaption"></div>
            </div>
            
            <div class="answers-list" id="optionsContainer">
                <!-- Options will be loaded dynamically -->
            </div>
            

        </div>

        <!-- Navigation Sidebar (10%) -->
        <nav class="nav-sidebar" id="navigationContainer">
            <button id="prevBtn">‚Üê Prev</button>
            <button id="nextBtn">Next ‚Üí</button>
            <div style="margin: 10px 0; width: 100%; border-top: 1px solid #ccc;"></div>
            
            <!-- Navigation grid - will be populated dynamically -->
            <div id="navigationGrid" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 3px; width: 100%;">
                <!-- Question buttons will be added here -->
            </div>
            
            <button id="toggleNavBtn" style="margin-top: 10px;">Hide Grid</button>
            
    
        </nav>
    </main>
   
    <footer>
        <div class="prog-bar">
            <div class="prog-fill" id="progressFill" style="width: 4%;"></div>
        </div>
        <div class="legend">
            <span><div class="box" style="background:#c8e6c9"></div> answered</span>
            <span><div class="box" style="background:#ffcdd2"></div> flagged</span>
            <span><div class="box" style="background:#bbdefb"></div> current</span>
            <span><div class="box" style="background:#fff"></div> unseen</span>
            
            <!-- Stats moved here from original footer -->
            <span style="margin-left: auto; display: flex; gap: 15px; font-size: 0.9rem;">
                <span>Flagged: <strong id="flaggedCount">0</strong></span>
                <span>Answered: <strong id="answeredCount">0</strong></span>
                <span>Time: <strong id="totalTime">00:00</strong></span>
                <span id="progressText">4% complete</span>
            </span>
        </div>
    </footer>

    <!-- All modals from the original -->
    <!-- Pause Modal -->
    <div class="modal-overlay" id="pauseModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Exam Paused</h2>
                <button class="modal-close" id="closePauseModal">√ó</button>
            </div>
            <div class="modal-body">
                <div class="pause-info">
                    <div class="info-item">
                        <span class="info-label">Time Elapsed:</span>
                        <span class="info-value" id="pauseTimeElapsed">00:00</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Questions Answered:</span>
                        <span class="info-value" id="pauseAnswered">0/25</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Flagged Questions:</span>
                        <span class="info-value" id="pauseFlagged">0</span>
                    </div>
                </div>
                
                <div class="pause-options">
                    <button class="btn-secondary" id="reviewFlaggedBtn">
                        <span class="btn-icon">üö©</span>
                        <span class="btn-text">Review Flagged</span>
                    </button>
                    
                    <button class="btn-secondary" id="changeSettingsBtn">
                        <span class="btn-icon">‚öôÔ∏è</span>
                        <span class="btn-text">Change Settings</span>
                    </button>
                    
                    <button class="btn-primary" id="resumeBtn">
                        <span class="btn-icon">‚ñ∂Ô∏è</span>
                        <span class="btn-text">Resume Exam</span>
                    </button>
                </div>
                
                <div class="pause-warning">
                    <span class="warning-icon">‚ö†Ô∏è</span>
                    <p>Your exam will auto-save. Do not close this window or navigate away.</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Submit Confirmation Modal -->
    <div class="modal-overlay" id="submitModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Submit Exam?</h2>
                <button class="modal-close" id="closeSubmitModal">√ó</button>
            </div>
            <div class="modal-body">
                <div class="submit-summary">
                    <h3>Exam Summary</h3>
                    <div class="summary-grid">
                        <div class="summary-item">
                            <span class="summary-label">Total Questions:</span>
                            <span class="summary-value" id="submitTotal">25</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Answered:</span>
                            <span class="summary-value" id="submitAnswered">0</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Flagged:</span>
                            <span class="summary-value" id="submitFlagged">0</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Time Used:</span>
                            <span class="summary-value" id="submitTime">00:00</span>
                        </div>
                    </div>
                    
                    <div class="submit-warning" id="submitWarning">
                        <span class="warning-icon">‚ö†Ô∏è</span>
                        <p>You have <span id="unansweredCount">0</span> unanswered questions. Are you sure you want to submit?</p>
                    </div>
                </div>
                
                <div class="submit-options">
                    <button class="btn-secondary" id="cancelSubmitBtn">
                        <span class="btn-icon">‚Üê</span>
                        <span class="btn-text">Continue Exam</span>
                    </button>
                    
                    <button class="btn-primary" id="confirmSubmitBtn">
                        <span class="btn-icon">‚úì</span>
                        <span class="btn-text">Submit & View Results</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Time Warning Modal -->
    <div class="modal-overlay time-warning" id="timeWarningModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚è∞ Time Warning</h2>
            </div>
            <div class="modal-body">
                <p id="timeWarningMessage">10 seconds remaining for this question!</p>
                <div class="time-warning-actions">
                    <button class="btn-primary" id="acknowledgeTimeBtn">
                        Acknowledge
                    </button>
                </div>
            </div>
        </div>
    </div>

   <!-- JavaScript Files - Keep all original scripts -->
<script src="scripts/app.js"></script>
<script src="scripts/exam-engine.js"></script>
<script src="scripts/timer.js"></script>
<script src="scripts/questions.js"></script>
<script src="scripts/db.js"></script>
<script src="scripts/security.js"></script>
<script src="scripts/ui.js"></script>
<script src="scripts/utils.js"></script>
<script src="scripts/router.js"></script>

<!-- CORRECTED JavaScript for new layout -->
<script>
document.addEventListener('DOMContentLoaded', async function() {
    // ==================== MODULE INITIALIZATION ====================
    console.log("Exam Room: Initializing modules...");
    
    // Wait for modules to be ready
    await waitForModule('ExamEngine', 5000);
    await waitForModule('MedicalExamDB', 3000);
    
    const examEngine = window.ExamEngine; // From exam-engine.js
    const db = window.MedicalExamDB; // From db.js
    const questionBank = window.QuestionBank; // From questions.js
    const security = window.SecuritySystem; // From security.js
    
    // UI State
    const uiState = {
        isFullscreen: false,
        navVisible: true,
        currentTimer: null,
        examConfigLoaded: false,
        examStarted: false,
        uiElements: {},
        currentQuestion: null
    };
    
    // ==================== HELPER FUNCTIONS ====================
    
    async function waitForModule(moduleName, timeout = 5000) {
        return new Promise((resolve, reject) => {
            const startTime = Date.now();
            const checkModule = () => {
                if (window[moduleName]) {
                    console.log(`${moduleName} module loaded`);
                    resolve(window[moduleName]);
                } else if (Date.now() - startTime > timeout) {
                    reject(new Error(`${moduleName} module not found after ${timeout}ms`));
                } else {
                    setTimeout(checkModule, 100);
                }
            };
            checkModule();
        });
    }
    
    function showError(message) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error-notification';
        errorDiv.innerHTML = `
            <div class="error-content">
                <span class="error-icon">‚ö†Ô∏è</span>
                <span class="error-message">${message}</span>
                <button class="error-close">√ó</button>
            </div>
        `;
        
        errorDiv.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #f5c6cb;
            z-index: 10000;
            max-width: 300px;
        `;
        
        document.body.appendChild(errorDiv);
        
        errorDiv.querySelector('.error-close').addEventListener('click', () => {
            errorDiv.remove();
        });
        
        setTimeout(() => {
            if (errorDiv.parentElement) {
                errorDiv.remove();
            }
        }, 5000);
    }
    
    function showSuccess(message) {
        const successDiv = document.createElement('div');
        successDiv.className = 'success-notification';
        successDiv.innerHTML = `
            <div class="success-content">
                <span class="success-icon">‚úì</span>
                <span class="success-message">${message}</span>
            </div>
        `;
        
        successDiv.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #c3e6cb;
            z-index: 10000;
            max-width: 300px;
        `;
        
        document.body.appendChild(successDiv);
        
        setTimeout(() => {
            if (successDiv.parentElement) {
                successDiv.remove();
            }
        }, 3000);
    }
    
    // ==================== INITIALIZATION ====================
    
    async function initializeExamRoom() {
        console.log('Initializing exam room...');
        
        try {
            // 1. Initialize UI elements cache
            initializeUIElements();
            
            // 2. Load exam configuration from localStorage
            const examConfig = loadExamConfiguration();
            
            if (!examConfig) {
                throw new Error('No exam configuration found. Please go back and select topics.');
            }
            
            // 3. Validate user subscription
            await validateSubscription();
            
            // 4. Load questions for exam
            const questions = await loadQuestionsForExam(examConfig);
            
            if (!questions || questions.length === 0) {
                throw new Error('No questions available for the selected topics.');
            }
            
            // 5. Start the exam
            await startExam(examConfig, questions);
            
            // 6. Initialize UI with first question
            await initializeQuestionUI();
            
            // 7. Start timers and updates
            startTimersAndUpdates();
            
            // 8. Setup event listeners
            setupEventListeners();
            
            console.log('Exam room fully initialized');
            showSuccess('Exam started successfully!');
            
        } catch (error) {
            console.error('Failed to initialize exam room:', error);
            showError(error.message);
            
            // Redirect to subjects page after delay
            setTimeout(() => {
                window.location.href = 'subjects.html';
            }, 3000);
        }
    }
    
    function initializeUIElements() {
        uiState.uiElements = {
            // Question elements
            questionNumber: document.getElementById('questionNumber'),
            questionSubject: document.getElementById('questionSubject'),
            questionTopic: document.getElementById('questionTopic'),
            questionDifficulty: document.getElementById('questionDifficulty'),
            questionText: document.getElementById('questionText'),
            questionImage: document.getElementById('questionImage'),
            questionImg: document.getElementById('questionImg'),
            imageCaption: document.getElementById('imageCaption'),
            optionsContainer: document.getElementById('optionsContainer'),
            
            // Timer elements
            timerValue: document.getElementById('timerValue'),
            timerVisual: document.getElementById('timerVisual'),
            totalTime: document.getElementById('totalTime'),
            
            // Progress elements
            flaggedCount: document.getElementById('flaggedCount'),
            answeredCount: document.getElementById('answeredCount'),
            progressFill: document.getElementById('progressFill'),
            progressText: document.getElementById('progressText'),
            
            // Navigation elements
            navigationGrid: document.getElementById('navigationGrid'),
            examProgress: document.getElementById('examProgress'),
            
            // Button elements
            flagBtn: document.getElementById('flagBtn'),
            prevBtn: document.getElementById('prevBtn'),
            nextBtn: document.getElementById('nextBtn'),
            pauseBtn: document.getElementById('pauseBtn'),
            fullscreenBtn: document.getElementById('fullscreenBtn'),
            toggleNavBtn: document.getElementById('toggleNavBtn'),
            submitBtn: document.getElementById('submitBtn'),
            backToSubjectsBtn: document.getElementById('backToSubjectsBtn'),
            profileBtn: document.getElementById('profileBtn'),
            
            // Additional elements
            questionTimeInfo: document.getElementById('questionTimeInfo'),
            
            // Modal elements
            pauseModal: document.getElementById('pauseModal'),
            submitModal: document.getElementById('submitModal'),
            timeWarningModal: document.getElementById('timeWarningModal')
        };
        
        console.log('UI elements initialized');
    }
    
    function loadExamConfiguration() {
        try {
            const config = JSON.parse(localStorage.getItem('examConfiguration') || '{}');
            
            if (!config.examId || !config.topics || !Array.isArray(config.topics)) {
                return null;
            }
            
            console.log('Exam configuration loaded:', config);
            return config;
            
        } catch (error) {
            console.error('Error loading exam configuration:', error);
            return null;
        }
    }
    
    async function validateSubscription() {
        try {
            // Get current user from localStorage
            const userData = localStorage.getItem('current_user');
            if (!userData) {
                throw new Error('Please login to continue.');
            }
            
            const user = JSON.parse(userData);
            
            // Check subscription via database
            const hasAccess = await db.hasActiveSubscription(user.id);
            
            if (!hasAccess) {
                // Check if trial is active
                const subscription = await db.getSubscription(user.id);
                if (!subscription || !subscription.isActive) {
                    throw new Error('Your subscription has expired. Please renew to continue.');
                }
            }
            
            console.log('Subscription validated');
            return true;
            
        } catch (error) {
            console.error('Subscription validation failed:', error);
            throw error;
        }
    }
    
    async function loadQuestionsForExam(config) {
        try {
            console.log('Loading questions for exam...');
            
            // Use question bank to get questions
            const criteria = {
                topics: config.topics,
                count: config.questionCount || 25,
                difficulty: config.difficulty || 'mixed',
                randomize: true
            };
            
            const questions = await questionBank.getQuestionsForExam(criteria);
            
            if (!questions || questions.length === 0) {
                throw new Error('No questions available for selected topics.');
            }
            
            console.log(`Loaded ${questions.length} questions for exam`);
            return questions;
            
        } catch (error) {
            console.error('Failed to load questions:', error);
            throw error;
        }
    }
    
    async function startExam(config, questions) {
        try {
            console.log('Starting exam with ExamEngine...');
            
            // Prepare exam settings
            const examSettings = {
                mode: config.examMode || 'timed',
                duration: config.duration || 15, // minutes
                questionCount: questions.length,
                subjects: config.subjects || [],
                topics: config.topics || [],
                difficulty: config.difficulty || 'mixed',
                showTimer: true,
                allowFlagging: true,
                autoSubmit: false
            };
            
            // Start exam using ExamEngine
            const examStart = await examEngine.startExam(examSettings, questions);
            
            if (!examStart || !examStart.examId) {
                throw new Error('Failed to start exam');
            }
            
            // Save exam ID for reference
            localStorage.setItem('current_exam_id', examStart.examId);
            
            uiState.examStarted = true;
            uiState.examConfigLoaded = true;
            
            console.log('Exam started successfully:', examStart.examId);
            return examStart;
            
        } catch (error) {
            console.error('Failed to start exam:', error);
            throw error;
        }
    }
    
    async function initializeQuestionUI() {
        try {
            // Get current question from ExamEngine
            const questionData = examEngine.getCurrentQuestion();
            
            if (!questionData) {
                throw new Error('No question data available');
            }
            
            // Update UI with question data
            updateQuestionDisplay(questionData);
            
            // Update navigation grid
            updateNavigationGrid();
            
            // Update progress
            updateProgressDisplay();
            
            console.log('Question UI initialized');
            
        } catch (error) {
            console.error('Failed to initialize question UI:', error);
            throw error;
        }
    }
    
    function updateQuestionDisplay(question) {
        if (!question) return;
        
        const elements = uiState.uiElements;
        
        // Update question info
        if (elements.questionNumber) {
            elements.questionNumber.textContent = `Q${question.questionNumber || 1}`;
        }
        
        if (elements.questionSubject) {
            elements.questionSubject.textContent = question.subjectName || question.subject || 'General';
        }
        
        if (elements.questionTopic) {
            elements.questionTopic.textContent = question.topic || 'General';
        }
        
        if (elements.questionDifficulty) {
            const difficultyMap = {
                1: 'Easy', 2: 'Medium', 3: 'Intermediate', 4: 'Hard', 5: 'Expert'
            };
            elements.questionDifficulty.textContent = difficultyMap[question.difficulty] || 'Medium';
        }
        
        if (elements.questionText) {
            elements.questionText.innerHTML = `<p>${question.question || ''}</p>`;
        }
        
        // Update question image
        if (elements.questionImage && elements.questionImg) {
            if (question.image) {
                elements.questionImage.style.display = 'block';
                elements.questionImg.src = `assets/images/${question.image}`;
                elements.questionImg.alt = question.question || 'Question image';
                elements.imageCaption.textContent = question.imageCaption || '';
            } else {
                elements.questionImage.style.display = 'none';
            }
        }
        
        // Update options
        updateOptionsDisplay(question);
        
        // Update flag button
        updateFlagButton(question);
        
        // Update exam progress text
        if (elements.examProgress) {
            elements.examProgress.textContent = 
                `Question ${question.questionNumber || 1} of ${examEngine.getProgress().total || 25}`;
        }
        
        uiState.currentQuestion = question;
    }
    
    function updateOptionsDisplay(question) {
        const optionsContainer = uiState.uiElements.optionsContainer;
        if (!optionsContainer) return;
        
        optionsContainer.innerHTML = '';
        
        if (!question.options || !Array.isArray(question.options)) {
            optionsContainer.innerHTML = '<li class="option error">No options available</li>';
            return;
        }
        
        question.options.forEach((option, index) => {
            const optionLabel = String.fromCharCode(65 + index); // A, B, C, D, E
            const optionElement = document.createElement('li');
            optionElement.className = 'option';
            
            if (question.userAnswer === optionLabel) {
                optionElement.classList.add('selected');
            }
            
            optionElement.innerHTML = `
                <label>
                    <input type="radio" name="questionOption" value="${optionLabel}" 
                           ${question.userAnswer === optionLabel ? 'checked' : ''}>
                    <span class="option-letter">${optionLabel}.</span>
                    <span class="option-text">${option}</span>
                </label>
            `;
            
            // Add click event
            optionElement.addEventListener('click', (e) => {
                if (examEngine.isPaused) return;
                
                const radio = optionElement.querySelector('input[type="radio"]');
                radio.checked = true;
                handleOptionSelect(optionLabel);
            });
            
            // Also handle radio button clicks directly
            const radio = optionElement.querySelector('input[type="radio"]');
            radio.addEventListener('click', (e) => {
                e.stopPropagation();
                if (examEngine.isPaused) return;
                handleOptionSelect(optionLabel);
            });
            
            optionsContainer.appendChild(optionElement);
        });
    }
    
    function updateFlagButton(question) {
        const flagBtn = uiState.uiElements.flagBtn;
        if (!flagBtn) return;
        
        const isFlagged = question.isFlagged || false;
        
        if (isFlagged) {
            flagBtn.classList.add('flagged');
            flagBtn.textContent = 'Unflag';
            flagBtn.title = 'Remove flag from this question';
        } else {
            flagBtn.classList.remove('flagged');
            flagBtn.textContent = 'Flag';
            flagBtn.title = 'Flag this question for review';
        }
    }
    
    function updateNavigationGrid() {
        const navGrid = uiState.uiElements.navigationGrid;
        if (!navGrid) return;
        
        const progress = examEngine.getProgress();
        if (!progress) return;
        
        navGrid.innerHTML = '';
        
        for (let i = 1; i <= progress.total; i++) {
            const button = document.createElement('button');
            button.className = 'nav-btn';
            button.dataset.question = i;
            button.textContent = i;
            
            // Check question status
            const questionState = examEngine.getQuestionState(i - 1); // 0-indexed
            
            if (questionState) {
                if (questionState.isAnswered) button.classList.add('answered');
                if (questionState.isFlagged) button.classList.add('flagged');
                if (i === progress.current) button.classList.add('current');
            }
            
            button.addEventListener('click', () => {
                navigateToQuestion(i);
            });
            
            navGrid.appendChild(button);
        }
    }
    
    function updateProgressDisplay() {
        const progress = examEngine.getProgress();
        if (!progress) return;
        
        const elements = uiState.uiElements;
        
        if (elements.answeredCount) {
            elements.answeredCount.textContent = progress.answered || 0;
        }
        
        if (elements.flaggedCount) {
            elements.flaggedCount.textContent = progress.flagged || 0;
        }
        
        if (elements.progressFill && elements.progressText) {
            elements.progressFill.style.width = `${progress.percentage || 0}%`;
            elements.progressText.textContent = `${progress.percentage || 0}% complete`;
        }
        
        // Update navigation buttons
        if (elements.prevBtn && elements.nextBtn) {
            elements.prevBtn.disabled = progress.current === 1;
            elements.nextBtn.disabled = progress.current === progress.total;
        }
    }
    
    // ==================== TIMER FUNCTIONS ====================
    
    function startTimersAndUpdates() {
        // Start question timer
        startQuestionTimer();
        
        // Start progress updates
        startProgressUpdates();
        
        // Start auto-save
        startAutoSave();
    }
    
    function startQuestionTimer() {
        // This would integrate with timer.js
        // For now, we'll create a simple timer
        updateTimerDisplay();
        setInterval(updateTimerDisplay, 1000);
    }
    
    function updateTimerDisplay() {
        const timerValue = uiState.uiElements.timerValue;
        const timerVisual = uiState.uiElements.timerVisual;
        
        if (!timerValue || !timerVisual) return;
        
        const timeRemaining = examEngine.getCurrentQuestionTimeRemaining();
        if (!timeRemaining) return;
        
        // Format time as MM:SS
        const minutes = Math.floor(timeRemaining.seconds / 60);
        const seconds = timeRemaining.seconds % 60;
        timerValue.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        // Update visual progress
        const percentage = Math.max(0, Math.min(100, timeRemaining.percentage));
        timerVisual.style.width = `${percentage}%`;
        
        // Update color based on time remaining
        updateTimerColor(timeRemaining.percentage);
    }
    
    function updateTimerColor(percentage) {
        const timerValue = uiState.uiElements.timerValue;
        const timerVisual = uiState.uiElements.timerVisual;
        
        if (!timerValue || !timerVisual) return;
        
        // Remove all color classes
        timerValue.classList.remove('green', 'yellow', 'red', 'flashing');
        timerVisual.classList.remove('green', 'yellow', 'red', 'flashing');
        
        if (percentage > 70) {
            timerValue.classList.add('green');
            timerVisual.classList.add('green');
        } else if (percentage > 30) {
            timerValue.classList.add('yellow');
            timerVisual.classList.add('yellow');
        } else if (percentage > 5) {
            timerValue.classList.add('red');
            timerVisual.classList.add('red');
        } else {
            timerValue.classList.add('flashing');
            timerVisual.classList.add('flashing');
        }
    }
    
    function startProgressUpdates() {
        setInterval(() => {
            updateProgressDisplay();
            
            // Update total time display
            const totalTime = uiState.uiElements.totalTime;
            if (totalTime) {
                const totalSeconds = examEngine.calculateTotalTime();
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = totalSeconds % 60;
                totalTime.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }, 1000);
    }
    
    function startAutoSave() {
        setInterval(async () => {
            if (examEngine.isPaused || examEngine.isCompleted) return;
            
            try {
                await examEngine.saveExamState();
                console.log('Auto-save completed');
            } catch (error) {
                console.error('Auto-save failed:', error);
            }
        }, 30000); // Every 30 seconds
    }
    
    // ==================== EVENT HANDLERS ====================
    
    function setupEventListeners() {
        // Navigation buttons
        if (uiState.uiElements.prevBtn) {
            uiState.uiElements.prevBtn.addEventListener('click', () => {
                if (examEngine.isPaused) return;
                const question = examEngine.previousQuestion();
                if (question) {
                    updateQuestionDisplay(question);
                    updateProgressDisplay();
                }
            });
        }
        
        if (uiState.uiElements.nextBtn) {
            uiState.uiElements.nextBtn.addEventListener('click', () => {
                if (examEngine.isPaused) return;
                const question = examEngine.nextQuestion();
                if (question) {
                    updateQuestionDisplay(question);
                    updateProgressDisplay();
                }
            });
        }
        
        // Flag button
        if (uiState.uiElements.flagBtn) {
            uiState.uiElements.flagBtn.addEventListener('click', () => {
                if (examEngine.isPaused) return;
                const success = examEngine.toggleFlag();
                if (success) {
                    updateFlagButton(examEngine.getCurrentQuestion());
                    updateProgressDisplay();
                    updateNavigationGrid();
                }
            });
        }
        
        // Pause button
        if (uiState.uiElements.pauseBtn) {
            uiState.uiElements.pauseBtn.addEventListener('click', () => {
                if (examEngine.isPaused) {
                    examEngine.resumeExamFromPause();
                    uiState.uiElements.pauseBtn.textContent = 'Pause';
                    hidePauseModal();
                } else {
                    examEngine.pauseExam();
                    uiState.uiElements.pauseBtn.textContent = 'Resume';
                    showPauseModal();
                }
            });
        }
        
        // Fullscreen button
        if (uiState.uiElements.fullscreenBtn) {
            uiState.uiElements.fullscreenBtn.addEventListener('click', toggleFullscreen);
        }
        
        // Navigation toggle button
        if (uiState.uiElements.toggleNavBtn) {
            uiState.uiElements.toggleNavBtn.addEventListener('click', toggleNavigation);
        }
        
        // Submit button
        if (uiState.uiElements.submitBtn) {
            uiState.uiElements.submitBtn.addEventListener('click', showSubmitModal);
        }
        
        // Back to subjects button
        if (uiState.uiElements.backToSubjectsBtn) {
            uiState.uiElements.backToSubjectsBtn.addEventListener('click', () => {
                if (confirm('Are you sure you want to quit the exam? Your progress will be saved.')) {
                    examEngine.quitExam();
                    window.location.href = 'subjects.html';
                }
            });
        }
        
        // Setup keyboard shortcuts
        setupKeyboardShortcuts();
        
        // Setup modal event listeners
        setupModalEventListeners();
    }
    
    function handleOptionSelect(option) {
        const success = examEngine.saveAnswer(option);
        if (success) {
            updateProgressDisplay();
            updateNavigationGrid();
            showSuccess('Answer saved');
        }
    }
    
    function navigateToQuestion(questionNumber) {
        if (examEngine.isPaused) return;
        
        const question = examEngine.goToQuestion(questionNumber - 1); // Convert to 0-indexed
        if (question) {
            updateQuestionDisplay(question);
            updateProgressDisplay();
        }
    }
    
    function toggleFullscreen() {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch(err => {
                console.log(`Fullscreen error: ${err.message}`);
            });
            uiState.isFullscreen = true;
            uiState.uiElements.fullscreenBtn.textContent = 'Exit Fullscreen';
        } else {
            document.exitFullscreen();
            uiState.isFullscreen = false;
            uiState.uiElements.fullscreenBtn.textContent = 'Fullscreen';
        }
    }
    
    function toggleNavigation() {
        const navGrid = document.getElementById('navigationGrid');
        if (!navGrid) return;
        
        if (navGrid.style.display === 'none') {
            navGrid.style.display = 'flex';
            uiState.uiElements.toggleNavBtn.textContent = 'Hide Grid';
        } else {
            navGrid.style.display = 'none';
            uiState.uiElements.toggleNavBtn.textContent = 'Show Grid';
        }
    }
    
    function showPauseModal() {
        const modal = uiState.uiElements.pauseModal;
        if (!modal) return;
        
        const progress = examEngine.getProgress();
        const timeSpent = examEngine.calculateTotalTime();
        
        // Update modal content
        const minutes = Math.floor(timeSpent / 60);
        const seconds = timeSpent % 60;
        const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        const timeElapsed = document.getElementById('pauseTimeElapsed');
        const answeredCount = document.getElementById('pauseAnswered');
        const flaggedCount = document.getElementById('pauseFlagged');
        
        if (timeElapsed) timeElapsed.textContent = timeString;
        if (answeredCount) answeredCount.textContent = `${progress.answered}/${progress.total}`;
        if (flaggedCount) flaggedCount.textContent = progress.flagged;
        
        modal.style.display = 'flex';
    }
    
    function hidePauseModal() {
        const modal = uiState.uiElements.pauseModal;
        if (modal) modal.style.display = 'none';
    }
    
    function showSubmitModal() {
        const modal = uiState.uiElements.submitModal;
        if (!modal) return;
        
        // Update modal stats
        const progress = examEngine.getProgress();
        const answered = progress.answered || 0;
        const total = progress.total || 0;
        const flagged = progress.flagged || 0;
        const unanswered = total - answered;
        
        const submitAnswered = document.getElementById('submitAnswered');
        const submitFlagged = document.getElementById('submitFlagged');
        const submitTotal = document.getElementById('submitTotal');
        const submitWarning = document.getElementById('submitWarning');
        const unansweredCount = document.getElementById('unansweredCount');
        
        if (submitAnswered) submitAnswered.textContent = answered;
        if (submitFlagged) submitFlagged.textContent = flagged;
        if (submitTotal) submitTotal.textContent = total;
        if (unansweredCount) unansweredCount.textContent = unanswered;
        
        if (submitWarning) {
            if (unanswered > 0) {
                submitWarning.style.display = 'block';
            } else {
                submitWarning.style.display = 'none';
            }
        }
        
        // Update time in modal
        const timeSpent = examEngine.calculateTotalTime();
        const minutes = Math.floor(timeSpent / 60);
        const seconds = timeSpent % 60;
        const submitTime = document.getElementById('submitTime');
        if (submitTime) {
            submitTime.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        modal.style.display = 'flex';
    }
    
    async function handleSubmitExam() {
        try {
            const confirmation = confirm("Are you sure you want to submit the exam? This action cannot be undone.");
            if (!confirmation) return;
            
            // Submit exam
            const results = await examEngine.submitExam();
            
            if (!results) {
                throw new Error('Failed to submit exam');
            }
            
            // Save exam results via question bank
            if (questionBank.saveExamAttempt) {
                await questionBank.saveExamAttempt(
                    examEngine.getExamState().questions.map(q => ({
                        ...q,
                        userAnswer: examEngine.getExamState().answers[q.id].selectedOption,
                        timeSpent: examEngine.getExamState().answers[q.id].timeSpent
                    })),
                    results
                );
            }
            
            // Save to database
            if (db && db.saveExamResult) {
                await db.saveExamResult({
                    ...examEngine.getExamState(),
                    results: results
                });
            }
            
            // Clear current exam ID
            localStorage.removeItem('current_exam_id');
            
            // Redirect to results page
            window.location.href = `results.html?exam=${results.examId}`;
            
        } catch (error) {
            console.error('Error submitting exam:', error);
            showError('Failed to submit exam. Please try again.');
        }
    }
    
    function setupKeyboardShortcuts() {
        document.addEventListener('keydown', (e) => {
            if (examEngine.isPaused || examEngine.isCompleted) return;
            
            // Don't trigger shortcuts when typing in inputs
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                return;
            }
            
            switch(e.key.toLowerCase()) {
                case '1':
                case 'a':
                    handleOptionSelect('A');
                    break;
                case '2':
                case 'b':
                    handleOptionSelect('B');
                    break;
                case '3':
                case 'c':
                    handleOptionSelect('C');
                    break;
                case '4':
                case 'd':
                    handleOptionSelect('D');
                    break;
                case '5':
                case 'e':
                    handleOptionSelect('E');
                    break;
                case ' ':
                    e.preventDefault();
                    examEngine.toggleFlag();
                    updateFlagButton(examEngine.getCurrentQuestion());
                    break;
                case 'arrowleft':
                    if (examEngine.currentQuestionIndex > 0) {
                        navigateToQuestion(examEngine.currentQuestionIndex);
                    }
                    break;
                case 'arrowright':
                    const progress = examEngine.getProgress();
                    if (examEngine.currentQuestionIndex < progress.total - 1) {
                        navigateToQuestion(examEngine.currentQuestionIndex + 2);
                    }
                    break;
                case 'escape':
                    if (examEngine.isPaused) {
                        examEngine.resumeExamFromPause();
                    } else {
                        examEngine.pauseExam();
                    }
                    break;
            }
        });
    }
    
    function setupModalEventListeners() {
        // Close submit modal
        document.getElementById('closeSubmitModal')?.addEventListener('click', () => {
            document.getElementById('submitModal').style.display = 'none';
        });
        
        document.getElementById('cancelSubmitBtn')?.addEventListener('click', () => {
            document.getElementById('submitModal').style.display = 'none';
        });
        
        // Confirm submit
        document.getElementById('confirmSubmitBtn')?.addEventListener('click', handleSubmitExam);
        
        // Resume from pause modal
        document.getElementById('resumeBtn')?.addEventListener('click', () => {
            if (examEngine.isPaused) {
                examEngine.resumeExamFromPause();
                uiState.uiElements.pauseBtn.textContent = 'Pause';
                hidePauseModal();
            }
        });
        
        // Review flagged from pause modal
        document.getElementById('reviewFlaggedBtn')?.addEventListener('click', () => {
            const flagged = examEngine.getFlaggedQuestions();
            if (flagged.length > 0) {
                const firstFlagged = flagged[0].index + 1; // Convert to 1-indexed
                navigateToQuestion(firstFlagged);
                hidePauseModal();
                if (examEngine.isPaused) {
                    examEngine.resumeExamFromPause();
                    uiState.uiElements.pauseBtn.textContent = 'Pause';
                }
            }
        });
    }
    
    // ==================== START INITIALIZATION ====================
    
    // Start the initialization process
    await initializeExamRoom();
    
    console.log("Exam Room: Script execution complete");
});
</script>
</body>
</html>