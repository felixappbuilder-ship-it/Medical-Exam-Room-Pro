<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account Locked - Medical Exam Room Pro</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/locked.css">
    <link rel="icon" href="images/logo.png" type="image/png">
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('service-worker.js');
            });
        }
    </script>
</head>
<body>
    <div class="locked-container">
        <!-- Lock Screen Content -->
        <div class="locked-content">
            <div class="locked-icon">üîí</div>
            
            <h1>Account Locked</h1>
            
            <div class="locked-reason" id="lockedReason">
                <!-- Lock reason will be displayed here -->
            </div>
            
            <div class="locked-details">
                <div class="detail-item">
                    <span class="detail-label">Lock ID:</span>
                    <span class="detail-value" id="lockId">Loading...</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Device ID:</span>
                    <span class="detail-value" id="deviceId">Loading...</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Lock Time:</span>
                    <span class="detail-value" id="lockTime">Loading...</span>
                </div>
            </div>
            
            <div class="locked-instructions">
                <h3>What Happened?</h3>
                <p>Your account has been locked due to a security violation. This is usually caused by:</p>
                <ul>
                    <li>Time manipulation detected</li>
                    <li>Multiple failed login attempts</li>
                    <li>Suspicious activity</li>
                    <li>Violation of terms of service</li>
                </ul>
            </div>
            
            <div class="locked-warning">
                <div class="warning-icon">‚ö†Ô∏è</div>
                <div class="warning-content">
                    <h4>Security Notice</h4>
                    <p>This app has zero-tolerance for cheating. Any attempt to manipulate time or bypass security measures will result in permanent account lock.</p>
                </div>
            </div>
            
            <div class="locked-resolution">
                <h3>How to Unlock Your Account</h3>
                <ol>
                    <li>Contact support using the information below</li>
                    <li>Provide your account details and lock ID</li>
                    <li>Explain what happened</li>
                    <li>Wait for support to review and unlock your account</li>
                </ol>
                
                <div class="contact-info">
                    <h4>Contact Support</h4>
                    <div class="contact-methods">
                        <div class="contact-method">
                            <div class="method-icon">üìß</div>
                            <div class="method-details">
                                <div class="method-label">Email:</div>
                                <div class="method-value">felixappbuilder@gmail.com</div>
                            </div>
                        </div>
                        
                        <div class="contact-method">
                            <div class="method-icon">üì±</div>
                            <div class="method-details">
                                <div class="method-label">Phone:</div>
                                <div class="method-value">0746834527</div>
                            </div>
                        </div>
                        
                        <div class="contact-method">
                            <div class="method-icon">‚è∞</div>
                            <div class="method-details">
                                <div class="method-label">Support Hours:</div>
                                <div class="method-value">Mon-Fri, 9 AM - 5 PM EAT</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="resolution-note">
                    <p><strong>Note:</strong> Account unlock is at the discretion of support. Repeated violations may result in permanent ban.</p>
                </div>
            </div>
            
            <div class="locked-actions">
                <button class="btn-primary" id="contactSupportBtn">
                    <span class="btn-icon">üìß</span>
                    <span class="btn-text">Email Support</span>
                </button>
                
                <button class="btn-secondary" id="copyDetailsBtn">
                    <span class="btn-icon">üìã</span>
                    <span class="btn-text">Copy Lock Details</span>
                </button>
                
                <button class="btn-secondary" id="retryBtn" style="display: none;">
                    <span class="btn-icon">üîÑ</span>
                    <span class="btn-text">Retry Connection</span>
                </button>
            </div>
            
            <div class="locked-footer">
                <p>This is a security feature to protect the integrity of the exam system.</p>
                <p class="footer-note">Medical Exam Room Pro - Security System v1.0</p>
            </div>
        </div>
    </div>

    <!-- JavaScript Files -->
    <script src="scripts/security.js"></script>
    <script src="scripts/ui.js"></script>
    <script src="scripts/utils.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Load lock details
            function loadLockDetails() {
                const lockReason = localStorage.getItem('lockReason') || 'Security Violation Detected';
                const lockId = localStorage.getItem('lockId') || 'LOCK_' + Date.now();
                const deviceId = localStorage.getItem('deviceId') || 'UNKNOWN_DEVICE';
                const lockTime = localStorage.getItem('lockTime') || new Date().toISOString();
                
                // Display lock details
                document.getElementById('lockedReason').textContent = lockReason;
                document.getElementById('lockId').textContent = lockId.substring(0, 12) + '...';
                document.getElementById('deviceId').textContent = deviceId.substring(0, 12) + '...';
                document.getElementById('lockTime').textContent = new Date(lockTime).toLocaleString();
                
                // Check if lock is temporary (e.g., network issue)
                const isTemporary = localStorage.getItem('isTemporaryLock') === 'true';
                if (isTemporary) {
                    document.getElementById('retryBtn').style.display = 'block';
                    document.querySelector('.locked-instructions').innerHTML += `
                        <div class="temporary-note">
                            <p><strong>This appears to be a temporary lock due to connection issues.</strong></p>
                            <p>Try reconnecting to the internet and click "Retry Connection".</p>
                        </div>
                    `;
                }
            }
            
            // Contact support button
            document.getElementById('contactSupportBtn').addEventListener('click', function() {
                const lockId = localStorage.getItem('lockId') || 'UNKNOWN';
                const deviceId = localStorage.getItem('deviceId') || 'UNKNOWN';
                const lockReason = localStorage.getItem('lockReason') || 'Security violation';
                
                const subject = encodeURIComponent('Account Locked - Medical Exam Room Pro');
                const body = encodeURIComponent(
                    `Hello Support,\n\nMy account is locked. Here are the details:\n\n` +
                    `Lock ID: ${lockId}\n` +
                    `Device ID: ${deviceId}\n` +
                    `Reason: ${lockReason}\n\n` +
                    `Please help me unlock my account.\n\n` +
                    `Thank you.`
                );
                
                window.location.href = `mailto:felixappbuilder@gmail.com?subject=${subject}&body=${body}`;
            });
            
            // Copy lock details button
            document.getElementById('copyDetailsBtn').addEventListener('click', function() {
                const lockId = localStorage.getItem('lockId') || 'UNKNOWN';
                const deviceId = localStorage.getItem('deviceId') || 'UNKNOWN';
                const lockReason = localStorage.getItem('lockReason') || 'Security violation';
                const lockTime = localStorage.getItem('lockTime') || new Date().toISOString();
                
                const details = 
                    `Lock ID: ${lockId}\n` +
                    `Device ID: ${deviceId}\n` +
                    `Reason: ${lockReason}\n` +
                    `Time: ${new Date(lockTime).toLocaleString()}\n` +
                    `Contact: felixappbuilder@gmail.com / 0746834527`;
                
                navigator.clipboard.writeText(details).then(() => {
                    alert('Lock details copied to clipboard!');
                }).catch(() => {
                    // Fallback for browsers that don't support clipboard API
                    const textArea = document.createElement('textarea');
                    textArea.value = details;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    alert('Lock details copied to clipboard!');
                });
            });
            
            // Retry button (for temporary locks)
            document.getElementById('retryBtn').addEventListener('click', function() {
                // Clear temporary lock
                localStorage.removeItem('isTemporaryLock');
                
                // Check if we can reconnect
                if (navigator.onLine) {
                    // Try to refresh token or reconnect
                    const accessToken = localStorage.getItem('accessToken');
                    const tokenExpiry = localStorage.getItem('tokenExpiry');
                    
                    if (accessToken && tokenExpiry && new Date(tokenExpiry) > new Date()) {
                        // Token is still valid, redirect to app
                        window.location.href = 'subjects.html';
                    } else {
                        // Token expired or missing, go to login
                        window.location.href = 'login.html';
                    }
                } else {
                    alert('Still offline. Please check your internet connection.');
                }
            });
            
            // Prevent navigation away from lock screen
            window.addEventListener('beforeunload', function(e) {
                if (!localStorage.getItem('lockBypassed')) {
                    e.preventDefault();
                    e.returnValue = 'Your account is locked. You need to contact support.';
                }
            });
            
            // Check if lock should be bypassed (for development/testing)
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('bypass') === 'true' && window.location.hostname === 'localhost') {
                localStorage.setItem('lockBypassed', 'true');
                window.location.href = 'subjects.html';
                return;
            }
            
            // Initialize
            loadLockDetails();
            
            // Apply theme based on system preference
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (prefersDark) {
                document.body.classList.add('dark-theme');
            }
        });
    </script>
</body>
</html>