<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign Up - Medical Exam Room Pro</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/signup.css">
    <link rel="icon" href="images/logo.png" type="image/png">
    
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('service-worker.js')
                    .then(function(registration) {
                        console.log('Service Worker registered');
                    })
                    .catch(function(error) {
                        console.log('Service Worker registration failed:', error);
                    });
            });
        }
    </script>
</head>
<body>
    <header class="header">
        <div class="header-container">
            <div class="logo">
                <img src="images/logo.png" alt="Logo" class="logo-image">
                <h1 class="logo-text">Create Account</h1>
            </div>
            
            <div class="header-actions">
                <button class="theme-toggle" id="themeToggle">
                    <span class="theme-icon">üåô</span>
                    <span class="theme-text">Dark Mode</span>
                </button>
                
                <button class="btn-back" id="backBtn">
                    <span class="back-icon">‚Üê</span>
                    <span class="back-text">Back</span>
                </button>
            </div>
        </div>
    </header>

    <main class="main-content">
        <div class="signup-container">
            <div class="signup-header">
                <h2>Create Your Account</h2>
                <p class="signup-subtitle">Join thousands of medical students excelling in their exams</p>
            </div>
            
            <form id="signupForm" class="signup-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="firstName">First Name *</label>
                        <input type="text" id="firstName" name="firstName" 
                               placeholder="Enter your first name" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="lastName">Last Name *</label>
                        <input type="text" id="lastName" name="lastName" 
                               placeholder="Enter your last name" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="email">Email Address *</label>
                    <input type="email" id="email" name="email" 
                           placeholder="student@example.com" required>
                    <div class="input-hint">We'll send important updates to this email</div>
                </div>
                
                <div class="form-group">
                    <label for="phone">Phone Number *</label>
                    <input type="tel" id="phone" name="phone" 
                           placeholder="2547XXXXXXXX or 07XXXXXXXX" required>
                    <div class="input-hint">Used for M-Pesa payments. Kenyan format only.</div>
                </div>
                
                <div class="form-group">
                    <label for="password">Password *</label>
                    <div class="password-input">
                        <input type="password" id="password" name="password" 
                               placeholder="Create a strong password" required>
                        <button type="button" class="toggle-password" id="togglePassword">
                            <span class="eye-icon">üëÅÔ∏è</span>
                        </button>
                    </div>
                    <div class="password-strength" id="passwordStrength">
                        <div class="strength-bar"></div>
                        <div class="strength-text">Password strength: Weak</div>
                    </div>
                    <div class="input-hint">Minimum 8 characters with uppercase, lowercase, and number</div>
                </div>
                
                <div class="form-group">
                    <label for="confirmPassword">Confirm Password *</label>
                    <input type="password" id="confirmPassword" name="confirmPassword" 
                           placeholder="Re-enter your password" required>
                    <div class="password-match" id="passwordMatch"></div>
                </div>
                
                <div class="form-group">
                    <label for="institution">Medical Institution (Optional)</label>
                    <select id="institution" name="institution">
                        <option value="">Select your institution</option>
                        <option value="uon">University of Nairobi</option>
                        <option value="kemu">Kenyatta University</option>
                        <option value="mmust">Moi University</option>
                        <option value="ku">Kenyatta University</option>
                        <option value="egerton">Egerton University</option>
                        <option value="mku">Mount Kenya University</option>
                        <option value="other">Other Institution</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="yearOfStudy">Year of Study (Optional)</label>
                    <select id="yearOfStudy" name="yearOfStudy">
                        <option value="">Select year</option>
                        <option value="1">Year 1</option>
                        <option value="2">Year 2</option>
                        <option value="3">Year 3</option>
                        <option value="4">Year 4</option>
                        <option value="5">Year 5</option>
                        <option value="6">Year 6</option>
                        <option value="intern">Intern</option>
                        <option value="postgrad">Postgraduate</option>
                    </select>
                </div>
                
                <div class="form-options">
                    <label class="checkbox-label">
                        <input type="checkbox" id="terms" name="terms" required>
                        <span class="checkbox-custom"></span>
                        <span class="checkbox-text">I agree to the <a href="terms.html" class="link">Terms of Service</a> and <a href="privacy.html" class="link">Privacy Policy</a></span>
                    </label>
                    
                    <label class="checkbox-label">
                        <input type="checkbox" id="newsletter" name="newsletter">
                        <span class="checkbox-custom"></span>
                        <span class="checkbox-text">Send me exam tips and updates (optional)</span>
                    </label>
                </div>
                
                <div class="security-notice">
                    <div class="security-icon">üîí</div>
                    <p><strong>Device Registration:</strong> This device will be registered to your account. Do not share your device with others during exams.</p>
                </div>
                
                <div class="form-group">
                    <button type="submit" class="btn-primary btn-submit" id="submitBtn">
                        <span class="btn-text">Create Account & Start Free Trial</span>
                        <span class="btn-spinner" id="submitSpinner" style="display: none;">‚è≥</span>
                    </button>
                </div>
                
                <input type="hidden" id="deviceInfo" name="deviceInfo">
            </form>
            
            <div class="signup-footer">
                <p>Already have an account? <a href="login.html" class="login-link">Login here</a></p>
                <p>Just want to try? <a href="free-trial.html" class="trial-link">Start 3-hour free trial without registration</a></p>
            </div>
        </div>
    </main>

    <footer class="footer-minimal">
        <p>By creating an account, you agree to our anti-cheating policy.</p>
        <p>¬© 2024 Medical Exam Room Pro | Contact: felixappbuilder@gmail.com</p>
    </footer>

    <script src="scripts/app.js"></script>
    <script src="scripts/auth.js"></script>
    <script src="scripts/validation.js"></script>
    <script src="scripts/security.js"></script>
    <script src="scripts/ui.js"></script>
    <script src="scripts/utils.js"></script>
    <script src="scripts/router.js"></script>
    
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Theme toggle
        const themeToggle = document.getElementById('themeToggle');
        const themeIcon = themeToggle.querySelector('.theme-icon');
        const themeText = themeToggle.querySelector('.theme-text');
        
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.body.classList.toggle('dark-theme', savedTheme === 'dark');
        
        if (savedTheme === 'dark') {
            themeIcon.textContent = '‚òÄÔ∏è';
            themeText.textContent = 'Light Mode';
        }
        
        themeToggle.addEventListener('click', function() {
            const isDark = document.body.classList.toggle('dark-theme');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            
            if (isDark) {
                themeIcon.textContent = '‚òÄÔ∏è';
                themeText.textContent = 'Light Mode';
            } else {
                themeIcon.textContent = 'üåô';
                themeText.textContent = 'Dark Mode';
            }
        });
        
        // Navigation
        const backBtn = document.getElementById('backBtn');
        backBtn.addEventListener('click', function() {
            window.history.back() || (window.location.href = 'welcome.html');
        });
        
        // Password toggle
        const togglePassword = document.getElementById('togglePassword');
        const passwordInput = document.getElementById('password');
        
        togglePassword.addEventListener('click', function() {
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
            togglePassword.querySelector('.eye-icon').textContent = type === 'password' ? 'üëÅÔ∏è' : 'üëÅÔ∏è‚Äçüó®Ô∏è';
        });
        
        // Password strength checker
        const passwordInputField = document.getElementById('password');
        const passwordStrength = document.getElementById('passwordStrength');
        const strengthBar = passwordStrength.querySelector('.strength-bar');
        const strengthText = passwordStrength.querySelector('.strength-text');
        
        passwordInputField.addEventListener('input', function() {
            const password = this.value;
            let strength = 0;
            
            // Length check
            if (password.length >= 8) strength += 25;
            if (password.length >= 12) strength += 15;
            
            // Complexity checks
            if (/[A-Z]/.test(password)) strength += 20;
            if (/[a-z]/.test(password)) strength += 20;
            if (/[0-9]/.test(password)) strength += 20;
            if (/[^A-Za-z0-9]/.test(password)) strength += 20;
            
            // Update strength bar
            strengthBar.style.width = Math.min(strength, 100) + '%';
            
            // Update text
            if (strength < 40) {
                strengthBar.style.backgroundColor = '#f44336';
                strengthText.textContent = 'Password strength: Weak';
            } else if (strength < 70) {
                strengthBar.style.backgroundColor = '#ff9800';
                strengthText.textContent = 'Password strength: Fair';
            } else if (strength < 90) {
                strengthBar.style.backgroundColor = '#4caf50';
                strengthText.textContent = 'Password strength: Good';
            } else {
                strengthBar.style.backgroundColor = '#2196f3';
                strengthText.textContent = 'Password strength: Strong';
            }
        });
        
        // Password confirmation
        const confirmPassword = document.getElementById('confirmPassword');
        const passwordMatch = document.getElementById('passwordMatch');
        
        function checkPasswordMatch() {
            const password = passwordInputField.value;
            const confirm = confirmPassword.value;
            
            if (!password || !confirm) {
                passwordMatch.textContent = '';
                return;
            }
            
            if (password === confirm) {
                passwordMatch.textContent = '‚úì Passwords match';
                passwordMatch.style.color = '#4caf50';
            } else {
                passwordMatch.textContent = '‚úó Passwords do not match';
                passwordMatch.style.color = '#f44336';
            }
        }
        
        passwordInputField.addEventListener('input', checkPasswordMatch);
        confirmPassword.addEventListener('input', checkPasswordMatch);
        
        // Phone number formatting
        const phoneInput = document.getElementById('phone');
        
        phoneInput.addEventListener('blur', function() {
            let phone = this.value.replace(/\D/g, '');
            
            if (phone.length === 9 && phone.startsWith('7')) {
                this.value = '254' + phone;
            } else if (phone.length === 10 && phone.startsWith('07')) {
                this.value = '254' + phone.substring(1);
            } else if (phone.length === 12 && phone.startsWith('254')) {
                // Already in correct format
            }
        });
        
        // Generate device fingerprint
        function generateDeviceFingerprint() {
            const components = [
                navigator.userAgent,
                navigator.language,
                navigator.platform,
                screen.width + 'x' + screen.height,
                new Date().getTimezoneOffset(),
                'medical_exam_room_pro'
            ].join('|');
            
            let hash = 0;
            for (let i = 0; i < components.length; i++) {
                const char = components.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            
            const deviceId = 'device_' + Math.abs(hash).toString(16);
            localStorage.setItem('deviceId', deviceId);
            localStorage.setItem('deviceFingerprint', deviceId);
            return deviceId;
        }
        
        // Mock backend API simulation
        const MockBackendAPI = {
            // Check if email/phone already exists
            checkExistingUser: function(email, phone) {
                const users = JSON.parse(localStorage.getItem('mock_users') || '[]');
                return users.find(user => user.email === email || user.phone === phone);
            },
            
            // Register new user (mock)
            register: function(userData) {
                return new Promise((resolve, reject) => {
                    setTimeout(() => {
                        // Check if user already exists
                        const existingUser = this.checkExistingUser(userData.email, userData.phone);
                        if (existingUser) {
                            const error = new Error('User already exists');
                            error.code = existingUser.email === userData.email ? 'EMAIL_EXISTS' : 'PHONE_EXISTS';
                            reject(error);
                            return;
                        }
                        
                        // Generate mock response
                        const userId = 'user_' + Date.now();
                        const mockToken = this.generateMockToken(userId);
                        
                        const response = {
                            status: 'success',
                            message: 'Registration successful',
                            data: {
                                user: {
                                    id: userId,
                                    firstName: userData.firstName,
                                    lastName: userData.lastName,
                                    email: userData.email,
                                    phone: userData.phone,
                                    institution: userData.institution || '',
                                    yearOfStudy: userData.yearOfStudy || '',
                                    createdAt: new Date().toISOString()
                                },
                                tokens: {
                                    accessToken: mockToken.accessToken,
                                    refreshToken: mockToken.refreshToken,
                                    expiresIn: 604800 // 7 days in seconds
                                },
                                deviceFingerprint: userData.deviceInfo.deviceId,
                                isNewDevice: true
                            }
                        };
                        
                        // Store user in mock database
                        const users = JSON.parse(localStorage.getItem('mock_users') || '[]');
                        users.push({
                            ...response.data.user,
                            password: userData.password // In real app, this would be hashed
                        });
                        localStorage.setItem('mock_users', JSON.stringify(users));
                        
                        resolve(response);
                    }, 1000); // Simulate network delay
                });
            },
            
            // Generate mock JWT token
            generateMockToken: function(userId) {
                const header = btoa(JSON.stringify({ alg: 'HS256', typ: 'JWT' }));
                const payload = btoa(JSON.stringify({
                    userId: userId,
                    iat: Math.floor(Date.now() / 1000),
                    exp: Math.floor(Date.now() / 1000) + (7 * 24 * 60 * 60) // 7 days
                }));
                const signature = btoa('mock_signature_' + Date.now());
                
                return {
                    accessToken: `${header}.${payload}.${signature}`,
                    refreshToken: `refresh_${header}.${payload}.${signature}`
                };
            }
        };
        
        // Get form elements
        const signupForm = document.getElementById('signupForm');
        const submitBtn = document.getElementById('submitBtn');
        const submitSpinner = document.getElementById('submitSpinner');
        
        // Add form submission handler
        signupForm.addEventListener('submit', async function(e) {
            // IMPORTANT: Prevent default AND stop propagation
            e.preventDefault();
            e.stopImmediatePropagation();
            
            console.log('=== SIGNUP FORM SUBMISSION (MOCK BACKEND) ===');
            
            // Validate form
            const firstName = document.getElementById('firstName').value.trim();
            const lastName = document.getElementById('lastName').value.trim();
            const email = document.getElementById('email').value.trim().toLowerCase();
            const phone = document.getElementById('phone').value.trim();
            const password = document.getElementById('password').value;
            const confirmPasswordValue = document.getElementById('confirmPassword').value;
            const terms = document.getElementById('terms').checked;
            
            // Validation
            if (!firstName || !lastName) {
                showError('Please enter your full name');
                return;
            }
            
            if (!email || !email.includes('@') || !email.includes('.')) {
                showError('Please enter a valid email address');
                return;
            }
            
            // Validate phone number
            const phoneDigits = phone.replace(/\D/g, '');
            const formattedPhone = phoneDigits.length === 9 ? '254' + phoneDigits : 
                                  phoneDigits.length === 10 ? '254' + phoneDigits.substring(1) : phoneDigits;
            
            if (!(formattedPhone.length === 12 && formattedPhone.startsWith('254'))) {
                showError('Please enter a valid Kenyan phone number (e.g., 2547XXXXXXXX or 07XXXXXXXX)');
                return;
            }
            
            if (password.length < 8) {
                showError('Password must be at least 8 characters long');
                return;
            }
            
            // Check password complexity
            if (!/[A-Z]/.test(password)) {
                showError('Password must contain at least one uppercase letter');
                return;
            }
            
            if (!/[a-z]/.test(password)) {
                showError('Password must contain at least one lowercase letter');
                return;
            }
            
            if (!/[0-9]/.test(password)) {
                showError('Password must contain at least one number');
                return;
            }
            
            if (password !== confirmPasswordValue) {
                showError('Passwords do not match');
                return;
            }
            
            if (!terms) {
                showError('You must agree to the Terms of Service and Privacy Policy');
                return;
            }
            
            // Show loading state
            submitBtn.disabled = true;
            submitSpinner.style.display = 'inline-block';
            submitBtn.querySelector('.btn-text').textContent = 'Creating Account...';
            
            try {
                // Prepare registration data
                const deviceInfo = {
                    deviceId: generateDeviceFingerprint(),
                    platform: navigator.platform,
                    browser: navigator.userAgent,
                    screen: screen.width + 'x' + screen.height,
                    timezone: new Date().getTimezoneOffset(),
                    timestamp: Date.now()
                };
                
                const registrationData = {
                    firstName: firstName,
                    lastName: lastName,
                    email: email,
                    phone: formattedPhone,
                    password: password,
                    institution: document.getElementById('institution').value || '',
                    yearOfStudy: document.getElementById('yearOfStudy').value || '',
                    newsletter: document.getElementById('newsletter').checked,
                    deviceInfo: deviceInfo,
                    clientTime: Date.now()
                };
                
                console.log('Registration data:', registrationData);
                
                // Check if we should simulate online or offline mode
                const simulateOnline = true; // Set to false to test offline mode
                
                if (simulateOnline) {
                    // Use mock backend API
                    console.log('Using mock backend API...');
                    
                    const result = await MockBackendAPI.register(registrationData);
                    
                    // Store authentication data EXACTLY as router.js expects
                    localStorage.setItem('accessToken', result.data.tokens.accessToken);
                    localStorage.setItem('refreshToken', result.data.tokens.refreshToken);
                    localStorage.setItem('userData', JSON.stringify(result.data.user));
                    localStorage.setItem('deviceFingerprint', result.data.deviceFingerprint);
                    
                    // Set token expiry (7 days from now)
                    const expiryDate = new Date();
                    expiryDate.setDate(expiryDate.getDate() + 7);
                    localStorage.setItem('tokenExpiry', expiryDate.toISOString());
                    
                    // Mark as new user for free trial
                    localStorage.setItem('isNewUser', 'true');
                    
                    // Store subscription placeholder (will be set in free-trial.html)
                    localStorage.setItem('subscription', JSON.stringify({
                        plan: 'none',
                        isActive: false,
                        expiryDate: null,
                        trialAvailable: true
                    }));
                    
                    // Log activity for router
                    if (window.MedicalExamRouter && typeof window.MedicalExamRouter.logActivity === 'function') {
                        window.MedicalExamRouter.logActivity('user_registered', {
                            email: email,
                            deviceId: deviceInfo.deviceId
                        });
                    }
                    
                    console.log('Registration successful! User data stored.');
                    
                    // Show success message
                    showSuccess('üéâ Account created successfully! Redirecting to free trial...');
                    
                    // Wait a moment for user to read success message
                    setTimeout(() => {
                        // Navigate to free trial
                        if (window.MedicalExamRouter && typeof window.MedicalExamRouter.navigateTo === 'function') {
                            window.MedicalExamRouter.navigateTo('free-trial.html');
                        } else {
                            window.location.href = 'free-trial.html';
                        }
                    }, 2000);
                    
                } else {
                    // Offline mode
                    console.log('Using offline registration...');
                    
                    // Create offline user
                    const offlineUser = {
                        id: 'offline_user_' + Date.now(),
                        firstName: firstName,
                        lastName: lastName,
                        email: email,
                        phone: formattedPhone,
                        institution: document.getElementById('institution').value || '',
                        yearOfStudy: document.getElementById('yearOfStudy').value || '',
                        createdAt: new Date().toISOString(),
                        isOffline: true
                    };
                    
                    // Store user data
                    const users = JSON.parse(localStorage.getItem('offline_users') || '[]');
                    users.push(offlineUser);
                    localStorage.setItem('offline_users', JSON.stringify(users));
                    
                    // Store authentication data for router
                    localStorage.setItem('accessToken', 'offline_token_' + Date.now());
                    localStorage.setItem('userData', JSON.stringify(offlineUser));
                    localStorage.setItem('isOffline', 'true');
                    
                    showSuccess('‚úÖ Account created offline. Some features may be limited until you connect to internet.');
                    
                    setTimeout(() => {
                        if (window.MedicalExamRouter && typeof window.MedicalExamRouter.navigateTo === 'function') {
                            window.MedicalExamRouter.navigateTo('free-trial.html');
                        } else {
                            window.location.href = 'free-trial.html';
                        }
                    }, 2000);
                }
                
            } catch (error) {
                console.error('Registration error:', error);
                
                if (error.code === 'EMAIL_EXISTS') {
                    showError('‚ùå Email already registered. Please login instead.');
                    setTimeout(() => {
                        if (window.MedicalExamRouter && typeof window.MedicalExamRouter.navigateTo === 'function') {
                            window.MedicalExamRouter.navigateTo('login.html');
                        } else {
                            window.location.href = 'login.html';
                        }
                    }, 2000);
                } else if (error.code === 'PHONE_EXISTS') {
                    showError('‚ùå Phone number already registered. Please login instead.');
                    setTimeout(() => {
                        if (window.MedicalExamRouter && typeof window.MedicalExamRouter.navigateTo === 'function') {
                            window.MedicalExamRouter.navigateTo('login.html');
                        } else {
                            window.location.href = 'login.html';
                        }
                    }, 2000);
                } else {
                    showError('‚ùå Registration failed: ' + (error.message || 'Unknown error'));
                }
            } finally {
                // Reset loading state
                submitBtn.disabled = false;
                submitSpinner.style.display = 'none';
                submitBtn.querySelector('.btn-text').textContent = 'Create Account & Start Free Trial';
            }
        });
        
        // Helper function to show error messages
        function showError(message) {
            // Remove any existing messages
            const existingError = document.getElementById('formError');
            if (existingError) existingError.remove();
            
            // Create error display
            const errorDiv = document.createElement('div');
            errorDiv.id = 'formError';
            errorDiv.className = 'form-error';
            errorDiv.innerHTML = `
                <div class="error-content">
                    <span class="error-icon">‚ùå</span>
                    <span class="error-text">${message}</span>
                </div>
            `;
            
            // Insert after form header or at top of form
            const formHeader = document.querySelector('.signup-header');
            if (formHeader) {
                formHeader.parentNode.insertBefore(errorDiv, formHeader.nextSibling);
            } else {
                signupForm.insertBefore(errorDiv, signupForm.firstChild);
            }
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.remove();
                }
            }, 5000);
        }
        
        // Helper function to show success messages
        function showSuccess(message) {
            // Remove any existing messages
            const existingSuccess = document.getElementById('formSuccess');
            if (existingSuccess) existingSuccess.remove();
            
            const existingError = document.getElementById('formError');
            if (existingError) existingError.remove();
            
            // Create success display
            const successDiv = document.createElement('div');
            successDiv.id = 'formSuccess';
            successDiv.className = 'form-success';
            successDiv.innerHTML = `
                <div class="success-content">
                    <span class="success-icon">‚úÖ</span>
                    <span class="success-text">${message}</span>
                </div>
            `;
            
            // Insert after form header or at top of form
            const formHeader = document.querySelector('.signup-header');
            if (formHeader) {
                formHeader.parentNode.insertBefore(successDiv, formHeader.nextSibling);
            } else {
                signupForm.insertBefore(successDiv, signupForm.firstChild);
            }
        }
        
        // Check if user is already logged in
        function checkExistingSession() {
            const accessToken = localStorage.getItem('accessToken');
            const userData = localStorage.getItem('userData');
            
            if (accessToken && userData) {
                try {
                    const user = JSON.parse(userData);
                    const tokenExpiry = localStorage.getItem('tokenExpiry');
                    
                    // Check if token is valid or if it's an offline token
                    const isOffline = localStorage.getItem('isOffline') === 'true';
                    const isValidToken = tokenExpiry ? new Date(tokenExpiry) > new Date() : isOffline;
                    
                    if (isValidToken) {
                        console.log('User already logged in, redirecting to subjects...');
                        
                        // Small delay to ensure DOM is ready
                        setTimeout(() => {
                            if (window.MedicalExamRouter && typeof window.MedicalExamRouter.navigateTo === 'function') {
                                window.MedicalExamRouter.navigateTo('subjects.html');
                            } else {
                                window.location.href = 'subjects.html';
                            }
                        }, 500);
                    }
                } catch (e) {
                    // Invalid data, clear it
                    localStorage.removeItem('accessToken');
                    localStorage.removeItem('userData');
                    localStorage.removeItem('tokenExpiry');
                }
            }
        }
        
        // Check for existing session on page load
        checkExistingSession();
        
        // Initialize app state if app.js is loaded
        if (typeof initApp === 'function') {
            initApp();
        }
        
        // Add CSS for form messages
        const style = document.createElement('style');
        style.textContent = `
            .form-error {
                animation: fadeIn 0.3s ease-in;
                background: #ffebee;
                border: 1px solid #f44336;
                border-radius: 8px;
                padding: 12px 15px;
                margin: 15px 0;
                color: #d32f2f;
                display: flex;
                align-items: center;
                gap: 10px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            
            .form-success {
                animation: fadeIn 0.3s ease-in;
                background: #e8f5e9;
                border: 1px solid #4caf50;
                border-radius: 8px;
                padding: 12px 15px;
                margin: 15px 0;
                color: #2e7d32;
                display: flex;
                align-items: center;
                gap: 10px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(-10px); }
                to { opacity: 1; transform: translateY(0); }
            }
            
            .error-icon, .success-icon {
                font-size: 1.2em;
                flex-shrink: 0;
            }
            
            .error-content, .success-content {
                display: flex;
                align-items: center;
                gap: 10px;
                width: 100%;
            }
            
            .error-text, .success-text {
                flex-grow: 1;
                font-size: 0.95em;
            }
            
            /* Dark theme support */
            .dark-theme .form-error {
                background: #422;
                border-color: #f55;
                color: #ff9999;
            }
            
            .dark-theme .form-success {
                background: #242;
                border-color: #4f4;
                color: #9f9;
            }
        `;
        document.head.appendChild(style);
        
        // Add click handlers for terms and privacy links
        document.addEventListener('click', function(e) {
            if (e.target.closest('a[href="terms.html"]')) {
                e.preventDefault();
                alert('Terms of Service\n\n1. This is a mock/demo application\n2. All data is stored locally in your browser\n3. No real payments are processed\n4. For demonstration purposes only');
            }
            
            if (e.target.closest('a[href="privacy.html"]')) {
                e.preventDefault();
                alert('Privacy Policy\n\nYour data is stored locally in your browser only. No information is sent to any server. This is a demonstration application.');
            }
            
            if (e.target.closest('a[href="login.html"]')) {
                e.preventDefault();
                if (window.MedicalExamRouter && typeof window.MedicalExamRouter.navigateTo === 'function') {
                    window.MedicalExamRouter.navigateTo('login.html');
                } else {
                    window.location.href = 'login.html';
                }
            }
            
            if (e.target.closest('a[href="free-trial.html"]')) {
                e.preventDefault();
                if (window.MedicalExamRouter && typeof window.MedicalExamRouter.navigateTo === 'function') {
                    window.MedicalExamRouter.navigateTo('free-trial.html');
                } else {
                    window.location.href = 'free-trial.html';
                }
            }
        });
    });
</script>
</body>
</html>